<!--
     The FreeBSD Polish Documentation Project

     $FreeBSD: doc/pl_PL.ISO8859-2/books/handbook/security/chapter.sgml,v 1.1 2006/11/10 11:46:51 therek Exp $
     Original revision: 1.296
-->

<chapter id="security">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Matthew</firstname>
	<surname>Dillon</surname>
        <contrib>Wiêkszo¶æ rozdzia³u napisa³ na podstawie strony podrêcznika
          systemowego security(7) </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author>
        <firstname>£ukasz</firstname>
        <surname>Bromirski</surname>
        <contrib>T³umaczy³ </contrib>
      </author>
    </authorgroup>
    <authorgroup>
      <author>
        <firstname>Cezary</firstname>
        <surname>Morga</surname>
        <contrib>Przek³ad uzupe³ni³ </contrib>
      </author>
    </authorgroup>
  </chapterinfo>

  <title>Bezpieczeñstwo</title>
  <indexterm><primary>bezpieczeñstwo</primary></indexterm>

  <sect1 id="security-synopsis">
    <title>Streszczenie</title>

    <para>W rozdziale omówione zostan± podstawy koncepcji bezpieczeñstwa
      systemu &os;, podstawowe dobre zwyczaje oraz niektóre tematy bardziej
      zaawansowane.  Wiele z poruszanych tematów mo¿na równie¿ zastosowaæ w szerszym
      aspekcie do bezpieczeñstwa systemów w Internecie.  Internet przesta³ byæ
      <quote>przyjaznym</quote> miejscem, w którym wszyscy chc± stanowiæ mi³e
      s±siedztwo.  Ochrona danych, w³asno¶ci intelektualnej, czasu i wielu innych
      istotnych warto¶ci przez zabezpieczenie systemu przed rêkami w³amywaczy
      staje siê spraw± zasadnicz±.</para>

    <para>&os; zapewnia ca³± gamê narzêdzi i mechanizmów zapewniaj±cych integralno¶æ
      i bezpieczeñstwo naszemu systemowi oraz pod³±czonej do niego sieci.</para>

    <para>Przeczytawszy ten rozdzia³, poznamy:</para>

    <itemizedlist>
      <listitem>
        <para>Podstawowe pojêcia zwi±zane z bezpieczeñstwem systemu, w odniesieniu do &os;.</para>
      </listitem>

      <listitem>
        <para>Ró¿ne mechanizmy kryptograficzne dostêpne we &os;, takie jak
	  <acronym>DES</acronym> i <acronym>MD5</acronym>.</para>
      </listitem>

      <listitem>
        <para>Jak skonfigurowaæ system uwierzytelniaj±cy stosuj±cy has³a jednorazowe.</para>
      </listitem>

      <listitem>
	<para>Jak skonfigurowaæ <acronym>TCP</acronym> Wrappers do wspó³pracy
          z <command>inetd</command>.</para>
      </listitem>

      <listitem>
        <para>Jak skonfigurowaæ <application>KerberosIV</application> we &os; wcze¶niejszych
          ni¿ 5.0.</para>
      </listitem>

      <listitem>
	<para>Jak skonfigurowaæ <application>Kerberos5</application> we &os;.</para>
      </listitem>

      <listitem>
	<para>Jak skonfigurowaæ IPsec i stworzyæ sieæ <acronym>VPN</acronym> pomiêdzy maszynami
	&os;/&windows;.</para>
      </listitem>
     
      <listitem>
	<para>Jak skonfigurowaæ i korzystaæ z <application>OpenSSH</application>, implementacji
          <acronym>SSH</acronym> we &os;.</para>
      </listitem>

      <listitem>
	<para>Czym s± listy <acronym>ACL</acronym> systemu plików i jak z nich korzystaæ.</para>
      </listitem>

      <listitem>
	<para>Jak wykorzystaæ narzêdzie <application>Portaudit</application>
	  do weryfikacji programów innych producentów zainstalowanych z Kolekcji
	  portów.</para>
      </listitem>

      <listitem>
	<para>Jak korzystaæ z komunikatów bezpieczeñstwa &os;.</para>
      </listitem>

      <listitem>
	<para>Czym jest Kontrola procesów i jak j± aktywowaæ we &os;.</para>
      </listitem>
    </itemizedlist>

    <para>Przed przeczytaniem tego rozdzia³u, powinni¶my:</para>

    <itemizedlist>
      <listitem>
        <para>Rozumieæ podstawowe zagadnienia zwi±zane z Internetem i &os;.</para>
      </listitem>
    </itemizedlist>

    <para>Dodatkowe zagadnienia bezpieczeñstwa omawiane s± równie¿ w innych czê¶ciach
      niniejszego Podrêcznika. Przyk³adowo, <xref
      linkend="mac"> omawia Obowi±zkow± kontrolê dostêpu (Mandatory Access Control), podczas
      gdy <xref linkend="firewalls"> opisuje zapory ogniowe.</para>
  </sect1>

  <sect1 id="security-intro">
    <title>Wprowadzenie</title>

    <para>Bezpieczeñstwo to funkcja zaczynaj±ca siê i koñcz±ca administratorem
      systemu.  O ile wszystkie wielou¿ytkownikowe systemy BSD &unix; maj± pewien
      poziom bezpieczeñstwa, rola zbudowania i utrzymania dodatkowych mechanizmów
      zabezpieczaj±cych maj±cych <quote>zadowoliæ</quote> u¿ytkowników jest prawdopodobnie
      najwiêkszym wyzwaniem dla administratora.  Systemy s± na tyle bezpieczne,
      na ile zostan± skonfigurowane a zagadnienia zwi±zane z bezpieczeñstwem
      zawsze konkuruj± z naturaln± ludzk± potrzeb± posiadania wygodnego ¶rodowiska
      pracy.  Systemy &unix; s± zdolne do wykonywania du¿ej ilo¶ci
      jednoczesnych procesów, przy czym wiele z nich pracuje jako serwery
      &mdash; co oznacza, ¿e zewnêtrzne jednostki mog± ³±czyæ siê do nich
      i porozumiewaæ siê.  Wraz z gwa³town± ewolucj± wczorajszych mini
      i super-komputerów, które sta³y siê dzisiaj standardowym sprzêtem
      u¿ywanym w domu i nierzadko po³±czonych z sieci±, bezpieczeñstwo staje
      siê powa¿nym problemem.</para>

    <para>Bezpieczeñstwo najlepiej implementowaæ w oparciu o model podzielonej
      na warstwy <quote>cebuli</quote>.  Sprowadza siê do to tego, ¿e nale¿y
      stworzyæ jak najwiêcej warstw bezpieczeñstwa zachowuj±c równowagê z wygod±
      u¿ywania systemu a nastêpnie monitorowaæ system pod k±tem intruzów.
      Nie chcemy z pewno¶ci± przesadziæ z poziomem bezpieczeñstwa, poniewa¿
      wp³ynie to na efektywno¶æ wykrywania &mdash; a jest ono najwa¿niejszym
      aspektem mechanizmów bezpieczeñstwa.  Na przyk³ad, nie ma wiêkszego sensu
      ustawiaæ flagi <literal>schg</literal> (patrz &man.chflags.1;) na ka¿dym
      binarnym pliku systemowym, poniewa¿ o ile tymczasowo chroni to je, uniemo¿liwia
      w³amywaczowi dokonanie ³atwo wykrywalnej zmiany.  Doprowadzi to w wyniku
      do tego, ¿e mechanizmy wykrywania w³amañ po prostu nie zauwa¿± ataku.</para>

    <para>Bezpieczeñstwo systemu dotyczy równie¿ ró¿nych form ataku, w³±czaj±c
      w to te maj±ce na celu za³amanie pracy poszczególnych aplikacji czy ca³ego
      systemu, czy generalnie maj±ce na celu destabilizacje pracy nie koniecznie
      przez uzyskanie dostêpu do konta <username>root</username>.  Zagadnienia
      bezpieczeñstwa mo¿na podzieliæ na parê kategorii:</para>

    <orderedlist>
      <listitem>
        <para>Ataki typu Denial of Service.</para>
      </listitem>

      <listitem>
        <para>W³amania na konta u¿ytkowników.</para>
      </listitem>

      <listitem>
        <para>W³amania na konto root poprzez dostêpne serwery.</para>
      </listitem>

      <listitem>
        <para>W³amania na konto root przez konta u¿ytkowników.</para>
      </listitem>

      <listitem>
        <para>Stworzenie tylnego wej¶cia.</para>
      </listitem>
    </orderedlist>

    <indexterm>
      <primary>ataki DoS</primary>
      <see>Denial of Service (DoS)</see>
    </indexterm>
    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>ataki DoS</secondary>
      <see>Denial of Service (DoS)</see>
    </indexterm>
    <indexterm><primary>Denial of Service (DoS)</primary></indexterm>

    <para>Odmowa Us³ugi (Denial of Service) to rodzaj ataku pozbawiaj±cy
      atakowan± maszynê potrzebnych jej zasobów.  Zwykle, ataki DoS opieraj±
      siê na mechanizmie u¿ywaj±cym rozwi±zania si³owego, próbuj±cym za³amaæ
      atakowan± maszynê lub spowodowaæ ¿e us³ugi przez ni± udostêpnianie stan±
      siê nieosi±galne - przez atak na stos serwera lub samej maszyny.  Niektóre
      z ataków DoS próbuj± wykorzystaæ b³êdy w stosie sieciowym, co zwykle mo¿liwe
      jest nawet za pomoc± jednego pakietu.  Tym ostatnim atakom mo¿na zapobiec
      aplikuj±c ³atê do j±dra, natomiast atakom na serwery przez odpowiednie
      ustawienie opcji tak, by zmniejszyæ obci±¿enie powodowane przez nie w przypadku
      skrajnie niekorzystnych warunków.  Sieciowe ataki si³owe s± trudniejsze
      do powstrzymania.  Na przyk³ad, atak z u¿yciem sfa³szowanych adresów pakietów
      jest praktycznie niemo¿liwy do powstrzymania - a powoduje odciêcie systemu od
      Internetu.  Byæ mo¿e nie spowoduje za³amania siê Twojej maszyny, ale wysyci
      ³±cze z Internetem do tego stopnia, ¿e jakikolwiek prawdziwy ruch na nim stanie
      siê niemo¿liwy.</para>

    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>w³amania na konto</secondary>
    </indexterm>

    <para>W³amania na konto u¿ytkownika s± powszechniejsze ni¿ ataki DoS.  Wielu administratorów
      nadal u¿ywa standardowych serwerów <application>telnetd</application>,
      <application>rlogind</application>, <application>rshd</application>
      i <application>ftpd</application>.  S± one domy¶lnie skonfigurowane tak,
      by nie u¿ywaæ po³±czeñ szyfrowanych.  W wyniku tego, je¶li mamy ju¿ ca³kiem
      poka¼n± liczbê u¿ytkowników, niektórzy z nich zaczn± logowaæ siê ze zdalnych
      lokalizacji (poniewa¿ bêdzie to dla nich wygodniejsze) - co umo¿liwi pods³uchanie
      ich hase³.  Uwa¿ny administrator systemu bêdzie sprawdza³ logi z po³±czeñ,
      analizuj±c adresy z których by³y wykonywane nawet dla po³±czeñ zakoñczonych
      sukcesem.</para>

    <para>Nale¿y zawsze zak³adaæ, ¿e gdy atakuj±cy uzyska dostêp do konta u¿ytkownika,
      mo¿e równie¿ uzyskaæ dostêp do konta <username>root</username>.  W ¶wiecie
      rzeczywistym, w dobrze zabezpieczonym i zarz±dzanym systemie jest to jednak
      tylko mo¿liwo¶æ teoretyczna.  Ró¿nica jest zasadnicza, poniewa¿ bez dostêpu
      do konta <username>root</username> atakuj±cy nie mo¿e zwykle ukryæ swoich
      ¶ladów ani zrobiæ nic oprócz skasowania plików u¿ytkownika.  W³amania na konto
      u¿ytkownika zdarzaj± siê bardzo czêsto, poniewa¿ zwykli u¿ytkownicy nie przyk³adaj±
      takiej uwagi do bezpieczeñstwa jak administratorzy systemów.</para>

    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>tylne wej¶cia</secondary>
    </indexterm>

    <para>Administratorzy systemów musz± zdawaæ sobie sprawê, ¿e jest wiele
      potencjalnych sposobów uzyskania dostêpu do konta <username>root</username>.
      Atakuj±cy mo¿e znaæ has³o na to konto, znale¼æ dziurê w demonie pracuj±cym
      z prawami <username>root</username>a i wykorzystaæ j± przez po³±czenie
      sieciowe, lub w demonie pracuj±cym z prawami suid-root i wykorzystaæ
      j± korzystaj±c z konta zwyk³ego u¿ytkownika.  W sytuacji, w której atakuj±cy
      ma sposób dostêpu bezpo¶rednio do konta <username>root</username>, nie musi
      ju¿ zawracaæ sobie g³owy instalowaniem tylnej furtki.  Wiele z dziur zwi±zanych
      z dostêpem do konta <username>root</username> wykrytych i poprawionych do tej
      pory, wi±za³o siê z dosyæ poka¼n± prac± wykonan± przez atakuj±cego by zatrzeæ
      po sobie ¶lady, tak wiêc zwykle pozostawiaj± oni po sobie w³a¶nie tylne furtki.
      Tylna furtka umo¿liwia atakuj±cemu ³atwy dostêp do konta <username>root</username>,
      ale daje równie¿ mo¿liwo¶æ m±dremu administratorowi wykrycia intruza.
      Uniemo¿liwienie zainstalowania tylnej furtki mo¿e nie byæ tak korzystne jak siê wydaje
      - poniewa¿ nie naprawia tak naprawdê sedna problemu.</para>


    <para>Zabiegi maj±ce na celu zabezpieczenie systemu powinny byæ zawsze implementowane
      w ramach wielowarstwowego modelu, opartego na modelu <quote>cebuli</quote>.
      Mo¿na je skategoryzowaæ nastêpuj±co:</para>

    <orderedlist>
      <listitem>
        <para>Zabezpieczenie konta <username>root</username> i administratorów.</para>
      </listitem>

      <listitem>
        <para>Zabezpieczenie serwerów pracuj±cych z uprawnieniami <username>root</username>
          oraz binarnych plików suid/sgid.</para>
      </listitem>

      <listitem>
        <para>Zabezpieczenie kont u¿ytkowników.</para>
      </listitem>

      <listitem>
        <para>Zabezpieczenie pliku z has³ami.</para>
      </listitem>

      <listitem>
	<para>Zabezpieczenie j±dra systemu, urz±dzeñ surowych i systemu plików.</para>
      </listitem>

      <listitem>
        <para>Szybkie wykrywanie niedopuszczalnych zmian dokonywanych w systemie.</para>
      </listitem>

      <listitem>
        <para>Paranoja.</para>
      </listitem>
    </orderedlist>

    <para>Nastêpna sekcja tego rozdzia³u zajmie siê powy¿szymi punktami dok³adniej.</para>
  </sect1>

  <sect1 id="securing-freebsd">
    <title>Zabezpieczanie &os;</title>
    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>zabezpieczanie &os;</secondary>
    </indexterm>

    <note>
      <title>Polecenia a Protoko³y</title>
      <para>W dokumencie tym u¿ywamy tekstu <application>pogrubionego</application> odnosz±c
        siê do nazw aplikacji, oraz tekstu o <command>sta³ej szeroko¶ci</command> w stosunku
        do poleceñ.  Nazwy protoko³ów pisane bêd± zwyk³± czcionk±.  Owe rozró¿nienie typograficzne
        znajduje zastosowanie szczególnie w przypadkach takich jak ssh, które jest zarówno
        protoko³em jak i poleceniem.</para>
    </note>

    <para>Poni¿ej opisane zosta³y metody zabezpieczania systemu &os; wypunktowane
      w <link linkend="security-intro">poprzedniej sekcji</link> tego rozdzia³u.</para>

    <sect2 id="securing-root-and-staff">
      <title>Zabezpieczanie konta <username>root</username> i kont administratorów</title>
      <indexterm>
        <primary><command>su</command></primary>
      </indexterm>

      <para>Po pierwsze, nie zajmujmy siê zabezpieczaniem kont administratorów,
        je¶li nie zabezpieczyli¶my wpierw konta <username>root</username>.
        Wiêkszo¶æ systemów ma przypisane has³o do tego konta.  Na pocz±tek nale¿y
        za³o¿yæ, ¿e atakuj±cy <emphasis>zawsze</emphasis> mo¿e prze³amaæ has³o.
        Nie oznacza to absolutnie, ¿e powinni¶my usun±æ has³o do niego.  Jest ono prawie
        zawsze niezbêdne dla dostêpu przez konsolê.  Oznacza to natomiast, ¿e powinni¶my
        uniemo¿liwiæ u¿ycie tego has³a z po³±czenia innego ni¿ konsola, lub nawet przez
        polecenie &man.su.1;.  Na przyk³ad, upewnijmy siê ¿e pty oznaczone s± jako
        <quote>insecure</quote> w pliku <filename>/etc/ttys</filename>, co spowoduje
        ¿e logowanie bezpo¶rednio na konto <username>root</username>a przez <command>telnet</command>
        lub <command>rlogin</command> bêd± niemo¿liwe.  Je¶li u¿ywamy innych us³ug
        logowania, takich jak <application>sshd</application> upewnijmy siê, ¿e w jego
        konfiguracji te¿ zabroniono bezpo¶redniego logowania na konto
        <username>root</username>a.  Mo¿na to wykonaæ, edytuj±c plik
        <filename>/etc/ssh/sshd_config</filename> i upewniaj±c siê ¿e dyrektywa
        <literal>PermitRootLogin</literal> ustawiona jest na <literal>NO</literal>.
        Przejrzyjmy konfiguracjê wszystkich us³ug &mdash; takie jak np. FTP bardzo
        czêsto staj± siê celem udanych ataków.  Logowanie wprost na konto
        <username>root</username> powinny byæ mo¿liwe tylko przez konsolê
        systemow±.</para>
      <indexterm>
        <primary><groupname>wheel</groupname></primary>
      </indexterm>

      <para>Oczywi¶cie, jako administratorzy systemu bêdziemy musieli czasami u¿yæ uprawnieñ
        konta <username>root</username>, tak wiêc otworzymy na tê okazjê parê dziur.
        Upewnimy siê jednak, ¿e wymagaj± one dodatkowych hase³.  Jednym ze sposobów na zapewnienie
        takiej funkcjonalno¶ci jest dodanie kont administratorów do grupy <groupname>wheel</groupname>
        w pliku <filename>/etc/group</filename>.  Administratorzy, których konta w³±czone zosta³y do grupy
        <groupname>wheel</groupname>, mog± u¿yæ polecenia <command>su</command> by dostaæ siê
        na konto <username>root</username>.  Nigdy nie powinni¶my dawaæ administratorom
        po prostu cz³onkostwa w grupie <groupname>wheel</groupname> wybieraj±c na ich domy¶ln± grupê
        w³a¶nie <groupname>wheel</groupname>.  Wszyscy administratorzy powinni
        nale¿eæ do innej grupy, np. <groupname>admin</groupname>, a dopiero pó¼niej powinni byæ
        dodani do grupy <groupname>wheel</groupname> za pomoc± pliku <filename>/etc/group</filename>.
        Tylko ci cz³onkowie zespo³u, którzy faktycznie potrzebuj± dostêpu do konta <username>root</username>
        powinni zostaæ dopisani dodatkowo do grupy <groupname>wheel</groupname>.  W przypadku
        stosowania us³ug takich jak Kerberos, mo¿na skorzystaæ z pliku <filename>.k5login</filename>
        konta <username>root</username>, by umo¿liwiæ &man.ksu.1; na te konto bez dopisywania
        kogokolwiek do grupy <groupname>wheel</groupname>.  Mo¿e to byæ lepsze rozwi±zanie,
        gdy¿ mechanizm <groupname>wheel</groupname>  nadal umo¿liwia dostêp do konta <username>root</username>,
        je¶li intruzowi uda siê uzyskaæ plik z has³ami i z³amaæ has³o którego¶ z administratorów.
        Tak wiêc, o ile stosowanie mechanizmu <groupname>wheel</groupname> jest lepsze ni¿
        nie stosowanie niczego, o tyyle nie jest to najbezpieczniejsze rozwi±zanie.</para>

      <!-- XXX:
	This will need updating depending on the outcome of PR bin/71147.
	Personally I know what I'd like to see, which puts this in definite
	need of a rewrite, but we'll have to wait and see.  ceri@
      -->

      <para>Po¶rednim sposobem zabezpieczenia kont administratorów i dostêpu
        do konta <username>root</username> jest <quote>wygwiazdkowanie</quote> zaszyfrowanych
        hase³ kont administratorów.  Za pomoc± polecenia &man.vipw.8; mo¿emy zast±piæ ka¿de
        has³o pojedyñczym znakiem <quote><literal>*</literal></quote>.  Polecenie to uaktualni
        plik <filename>/etc/master.passwd</filename> i bazê danych u¿ytkownik/has³o,
        uniemo¿liwiaj±c logowanie z u¿yciem has³a.</para>

      <para>A staff account entry such as:</para>

      <programlisting>foobar:R9DT/Fa1/LV9U:1000:1000::0:0:Foo Bar:/home/foobar:/usr/local/bin/tcsh</programlisting>

      <para>Should be changed to this:</para>

      <programlisting>foobar:*:1000:1000::0:0:Foo Bar:/home/foobar:/usr/local/bin/tcsh</programlisting>

      <para>This change will prevent normal logins from occurring,
        since the encrypted password will never match
        <quote><literal>*</literal></quote>.  With this done,
	staff members must use
        another mechanism to authenticate themselves such as
        &man.kerberos.1; or &man.ssh.1; using a public/private key
        pair.  When using something like Kerberos, one generally must
        secure the machines which run the Kerberos servers and your
        desktop workstation.  When using a public/private key pair
        with ssh, one must generally secure
        the machine used to login <emphasis>from</emphasis> (typically
        one's workstation).  An additional layer of protection can be
        added to the key pair by password protecting the key pair when
        creating it with &man.ssh-keygen.1;.  Being able to
        <quote>star</quote> out the passwords for staff accounts also
        guarantees that staff members can only login through secure
        access methods that you have set up.  This forces all staff
        members to use secure, encrypted connections for all of their
        sessions, which closes an important hole used by many
        intruders: sniffing the network from an unrelated,
        less secure machine.</para>

      <para>The more indirect security mechanisms also assume that you are
	logging in from a more restrictive server to a less restrictive
	server.  For example, if your main box is running all sorts of
	servers, your workstation should not be running any.  In order for
	your workstation to be reasonably secure you should run as few
	servers as possible, up to and including no servers at all, and
	you should run a password-protected screen blanker.  Of course,
	given physical access to a workstation an attacker can break any
	sort of security you put on it.  This is definitely a problem that
	you should consider, but you should also consider the fact that the
	vast majority of break-ins occur remotely, over a network, from
	people who do not have physical access to your workstation or
	servers.</para>
      <indexterm><primary>KerberosIV</primary></indexterm>

      <para>Using something like Kerberos also gives you the ability to
	disable or change the password for a staff account in one place,
	and have it immediately affect all the machines on which the staff
	member may have an account.  If a staff member's account gets
	compromised, the ability to instantly change his password on all
	machines should not be underrated.  With discrete passwords,
	changing a password on N machines can be a mess.  You can also
	impose re-passwording restrictions with Kerberos:  not only can a
	Kerberos ticket be made to timeout after a while, but the Kerberos
	system can require that the user choose a new password after a
	certain period of time (say, once a month).</para>
    </sect2>

    <sect2>
      <title>Securing Root-run Servers and SUID/SGID Binaries</title>

      <indexterm>
        <primary><command>ntalk</command></primary>
      </indexterm>
      <indexterm>
        <primary><command>comsat</command></primary>
      </indexterm>
      <indexterm>
        <primary><command>finger</command></primary>
      </indexterm>
      <indexterm>
        <primary>sandboxes</primary>
      </indexterm>
      <indexterm>
        <primary><application>sshd</application></primary>
      </indexterm>
      <indexterm>
        <primary><application>telnetd</application></primary>
      </indexterm>
      <indexterm>
        <primary><application>rshd</application></primary>
      </indexterm>
      <indexterm>
        <primary><application>rlogind</application></primary>
      </indexterm>

      <para>The prudent sysadmin only runs the servers he needs to, no
	more, no less.  Be aware that third party servers are often the
	most bug-prone.  For example, running an old version of
	<application>imapd</application> or
	<application>popper</application> is like giving a universal
	<username>root</username> ticket out to the entire world.
	Never run a server that you have not checked out carefully.
	Many servers do not need to be run as <username>root</username>.
	For example, the <application>ntalk</application>,
	<application>comsat</application>, and
	<application>finger</application> daemons can be run in special
	user <firstterm>sandboxes</firstterm>.  A sandbox is not perfect,
	unless you go through a large amount of trouble, but the onion
	approach to security still stands: If someone is able to break
	in through a server running in a sandbox, they still have to
	break out of the sandbox.  The more layers the attacker must
	break through, the lower the likelihood of his success.  Root
	holes have historically been found in virtually every server
	ever run as <username>root</username>, including basic system servers.
	If you are running a machine through which people only login via
	<application>sshd</application> and never login via
	<application>telnetd</application> or
	<application>rshd</application> or
	<application>rlogind</application>, then turn off those
	services!</para>
      
      <para>&os; now defaults to running
	<application>ntalkd</application>,
	<application>comsat</application>, and
	<application>finger</application> in a sandbox.  Another program
	which may be a candidate for running in a sandbox is &man.named.8;.
	<filename>/etc/defaults/rc.conf</filename> includes the arguments
	necessary to run <application>named</application> in a sandbox in a
	commented-out form.  Depending on whether you are installing a new
	system or upgrading an existing system, the special user accounts
	used by these sandboxes may not be installed.  The prudent
	sysadmin would research and implement sandboxes for servers
	whenever possible.</para>
      <indexterm>
        <primary><application>sendmail</application></primary>
      </indexterm>

      <para>There are a number of other servers that typically do not run
	in sandboxes: <application>sendmail</application>,
	<application>popper</application>,
	<application>imapd</application>, <application>ftpd</application>,
	and others.  There are alternatives to some of these, but
	installing them may require more work than you are willing to
	perform (the convenience factor strikes again).  You may have to
	run these servers as <username>root</username> and rely on other
	mechanisms to detect break-ins that might occur through them.</para>

      <para>The other big potential <username>root</username> holes in a
	system are the
	suid-root and sgid binaries installed on the system.  Most of
	these binaries, such as <application>rlogin</application>, reside
	in <filename>/bin</filename>, <filename>/sbin</filename>,
	<filename>/usr/bin</filename>, or <filename>/usr/sbin</filename>.
	While nothing is 100% safe, the system-default suid and sgid
	binaries can be considered reasonably safe.  Still,
	<username>root</username> holes are occasionally found in these
	binaries.  A <username>root</username> hole was found in
	<literal>Xlib</literal> in 1998 that made
	<application>xterm</application> (which is typically suid)
	vulnerable.  It is better to be safe than sorry and the prudent
	sysadmin will restrict suid binaries, that only staff should run,
	to a special group that only staff can access, and get rid of
	(<command>chmod 000</command>) any suid binaries that nobody uses.
	A server with no display generally does not need an
	<application>xterm</application> binary.  Sgid binaries can be
	almost as dangerous.  If an intruder can break an sgid-kmem binary,
	the intruder might be able to read <filename>/dev/kmem</filename>
	and thus read the encrypted password file, potentially compromising
	any passworded account.  Alternatively an intruder who breaks
	group <literal>kmem</literal> can monitor keystrokes sent through
	ptys, including ptys used by users who login through secure
	methods.  An intruder that breaks the <groupname>tty</groupname>
	group can write to
	almost any user's tty.  If a user is running a terminal program or
	emulator with a keyboard-simulation feature, the intruder can
	potentially generate a data stream that causes the user's terminal
	to echo a command, which is then run as that user.</para>
    </sect2>

    <sect2 id="secure-users">
      <title>Securing User Accounts</title>

      <para>User accounts are usually the most difficult to secure.  While
	you can impose Draconian access restrictions on your staff and
	<quote>star</quote> out their passwords, you may not be able to
	do so with any general user accounts you might have.  If you do
	have sufficient control, then you may win out and be able to secure
	the user accounts properly.  If not, you simply have to be more
	vigilant in your monitoring of those accounts.  Use of
	ssh and Kerberos for user accounts is
	more problematic, due to the extra administration and technical
	support required, but still a very good solution compared to a
	crypted password file.</para>
    </sect2>

    <sect2>
      <title>Securing the Password File</title>

      <para>The only sure fire way is to <literal>*</literal> out as many
	passwords as you can and use ssh or
	Kerberos for access to those accounts.  Even though the encrypted
	password file (<filename>/etc/spwd.db</filename>) can only be read
	by <username>root</username>, it may be possible for an intruder
	to obtain read access to that file even if the attacker cannot
	obtain root-write access.</para>

      <para>Your security scripts should always check for and report
	changes to the password file (see the <link
	  linkend="security-integrity">Checking file integrity</link> section
	below).</para>
    </sect2>

    <sect2>
      <title>Securing the Kernel Core, Raw Devices, and
	File systems</title>

      <para>If an attacker breaks <username>root</username> he can do
        just about anything, but
	there are certain conveniences.  For example, most modern kernels
	have a packet sniffing device driver built in.  Under &os; it
	is called the <devicename>bpf</devicename> device.  An intruder
	will commonly attempt to run a packet sniffer on a compromised
	machine.  You do not need to give the intruder the capability and
	most systems do not have the need for the
	<devicename>bpf</devicename> device compiled in.</para>

      <indexterm>
        <primary><command>sysctl</command></primary>
      </indexterm>
      <para>But even if you turn off the <devicename>bpf</devicename>
	device, you still have
	<filename>/dev/mem</filename> and 
	<filename>/dev/kmem</filename>
	to worry about.  For that matter, the intruder can still write to
	raw disk devices.  Also, there is another kernel feature called
	the module loader, &man.kldload.8;.  An enterprising intruder can
	use a KLD module to install his own <devicename>bpf</devicename>
	device, or other sniffing
	device, on a running kernel.  To avoid these problems you have to
	run the kernel at a higher secure level, at least securelevel 1.
	The securelevel can be set with a <command>sysctl</command> on
	the <varname>kern.securelevel</varname> variable.  Once you have
	set the securelevel to 1, write access to raw devices will be
	denied and special <command>chflags</command> flags,
	such as <literal>schg</literal>,
	will be enforced.  You must also ensure that the
	<literal>schg</literal> flag is set on critical startup binaries,
	directories, and script files &mdash; everything that gets run up
	to the point where the securelevel is set.  This might be overdoing
	it, and upgrading the system is much more difficult when you
	operate at a higher secure level.  You may compromise and run the
	system at a higher secure level but not set the
	<literal>schg</literal> flag for every system file and directory
	under the sun.  Another possibility is to simply mount
	<filename>/</filename> and <filename>/usr</filename> read-only.
	It should be noted that being too Draconian in what you attempt to
	protect may prevent the all-important detection of an
	intrusion.</para>
    </sect2>

    <sect2 id="security-integrity">
      <title>Checking File Integrity: Binaries, Configuration Files,
	Etc.</title>

      <para>When it comes right down to it, you can only protect your core
	system configuration and control files so much before the
	convenience factor rears its ugly head.  For example, using
	<command>chflags</command> to set the <literal>schg</literal> bit
	on most of the files in <filename>/</filename> and
	<filename>/usr</filename> is probably counterproductive, because
	while it may protect the files, it also closes a detection window.
	The last layer of your security onion is perhaps the most
	important &mdash; detection.  The rest of your security is pretty
	much useless (or, worse, presents you with a false sense of
	safety) if you cannot detect potential incursions.  Half the job
	of the onion is to slow down the attacker, rather than stop him, in
	order to give the detection side of the equation a chance to catch
	him in the act.</para>

      <para>The best way to detect an incursion is to look for modified,
	missing, or unexpected files.  The best way to look for modified
	files is from another (often centralized) limited-access system.
	Writing your security scripts on the extra-secure limited-access
	system makes them mostly invisible to potential attackers, and this
	is important.  In order to take maximum advantage you generally
	have to give the limited-access box significant access to the
	other machines in the business, usually either by doing a
	read-only NFS export of the other machines to the limited-access
	box, or by setting up ssh key-pairs to
	allow the limited-access box to ssh to
	the other machines.  Except for its network traffic, NFS is the
	least visible method &mdash; allowing you to monitor the
	file systems on each client box virtually undetected.  If your
	limited-access server is connected to the client boxes through a
	switch, the NFS method is often the better choice.  If your
	limited-access server is connected to the client boxes through a
	hub, or through several layers of routing, the NFS method may be
	too insecure (network-wise) and using
	ssh may be the better choice even with
	the audit-trail tracks that ssh
	lays.</para>

      <para>Once you give a limited-access box, at least read access to the
	client systems it is supposed to monitor, you must write scripts
	to do the actual monitoring.  Given an NFS mount, you can write
	scripts out of simple system utilities such as &man.find.1; and
	&man.md5.1;.  It is best to physically md5 the client-box files
	at least once a day, and to test control files such as those
	found in <filename>/etc</filename> and
	<filename>/usr/local/etc</filename> even more often.  When
	mismatches are found, relative to the base md5 information the
	limited-access machine knows is valid, it should scream at a
	sysadmin to go check it out.  A good security script will also
	check for inappropriate suid binaries and for new or deleted files
	on system partitions such as <filename>/</filename> and
	<filename>/usr</filename>.</para>

      <para>When using ssh rather than NFS,
	writing the security script is much more difficult.   You
	essentially have to <command>scp</command> the scripts to the client 
	box in order to
	run them, making them visible, and for safety you also need to
	<command>scp</command> the binaries (such as find) that those
	scripts use.  The <application>ssh</application> client on the
	client box may already be compromised.  All in all, using
	ssh may be necessary when running over
	insecure links, but it is also a lot harder to deal with.</para>

      <para>A good security script will also check for changes to user and
	staff members access configuration files:
	<filename>.rhosts</filename>, <filename>.shosts</filename>,
	<filename>.ssh/authorized_keys</filename> and so forth&hellip;
	files that might fall outside the purview of the
	<literal>MD5</literal> check.</para>

      <para>If you have a huge amount of user disk space, it may take too
	long to run through every file on those partitions.  In this case,
	setting mount flags to disallow suid binaries and devices on those
	partitions is a good idea.  The <literal>nodev</literal> and
	<literal>nosuid</literal> options (see &man.mount.8;) are what you
	want to look into.  You should probably scan them anyway, at least
	once a week, since the object of this layer is to detect a break-in
	whether or not the break-in is effective.</para>

      <para>Process accounting (see &man.accton.8;) is a relatively
	low-overhead feature of the operating system which might help
	as a post-break-in evaluation mechanism.  It is especially
	useful in tracking down how an intruder has actually broken into
	a system, assuming the file is still intact after the break-in
	occurs.</para>

      <para>Finally, security scripts should process the log files, and the
	logs themselves should be generated in as secure a manner as
	possible &mdash; remote syslog can be very useful.  An intruder
	tries to cover his tracks, and log files are critical to the
	sysadmin trying to track down the time and method of the initial
	break-in.  One way to keep a permanent record of the log files is
	to run the system console to a serial port and collect the
	information on a continuing basis through a secure machine
	monitoring the consoles.</para>
    </sect2>

    <sect2>
      <title>Paranoia</title>

      <para>A little paranoia never hurts.  As a rule, a sysadmin can add
	any number of security features, as long as they do not affect
	convenience, and can add security features that
	<emphasis>do</emphasis> affect convenience with some added thought.
	Even more importantly, a security administrator should mix it up a
	bit &mdash; if you use recommendations such as those given by this
	document verbatim, you give away your methodologies to the
	prospective attacker who also has access to this document.</para>
    </sect2>

    <sect2>
      <title>Denial of Service Attacks</title>
      <indexterm><primary>Denial of Service (DoS)</primary></indexterm>

      <para>This section covers Denial of Service attacks.  A DoS attack
	is typically a packet attack.  While there is not much you can do
	about modern spoofed packet attacks that saturate your network,
	you can generally limit the damage by ensuring that the attacks
	cannot take down your servers.</para>

      <orderedlist>
	<listitem>
	  <para>Limiting server forks.</para>
	</listitem>

	<listitem>
	  <para>Limiting springboard attacks (ICMP response attacks, ping
	    broadcast, etc.).</para>
	</listitem>

	<listitem>
	  <para>Kernel Route Cache.</para>
	</listitem>
      </orderedlist>

      <para>A common DoS attack is against a forking server that attempts
	to cause the server to eat processes, file descriptors, and memory,
	until the machine dies.  <application>inetd</application>
	(see &man.inetd.8;) has several
	options to limit this sort of attack.  It should be noted that
	while it is possible to prevent a machine from going down, it is
	not generally possible to prevent a service from being disrupted
	by the attack.  Read the <application>inetd</application> manual
	page carefully and pay
	specific attention to the <option>-c</option>, <option>-C</option>,
	and <option>-R</option> options.  Note that spoofed-IP attacks
	will circumvent the <option>-C</option> option to 
	<application>inetd</application>, so
	typically a combination of options must be used.  Some standalone
	servers have self-fork-limitation parameters.</para>

      <para><application>Sendmail</application> has its
	<option>-OMaxDaemonChildren</option> option, which tends to work
	much better than trying to use sendmail's load limiting options
	due to the load lag.  You should specify a
	<literal>MaxDaemonChildren</literal> parameter, when you start
	<application>sendmail</application>, high enough to handle your
	expected load, but not so high that the computer cannot handle that
	number of <application>sendmails</application> without falling on
	its face.  It is also prudent to run sendmail in queued mode
	(<option>-ODeliveryMode=queued</option>) and to run the daemon
	(<command>sendmail -bd</command>) separate from the queue-runs
	(<command>sendmail -q15m</command>).  If you still want real-time
	delivery you can run the queue at a much lower interval, such as
	<option>-q1m</option>, but be sure to specify a reasonable
	<literal>MaxDaemonChildren</literal> option for
	<emphasis>that</emphasis> sendmail to prevent cascade failures.</para>

      <para><application>Syslogd</application> can be attacked directly
	and it is strongly recommended that you use the <option>-s</option>
	option whenever possible, and the <option>-a</option> option
	otherwise.</para>

      <para>You should also be fairly careful with connect-back services
	such as <application>TCP Wrapper</application>'s reverse-identd,
	which can be attacked directly.  You generally do not want to use
	the reverse-ident feature of
	<application>TCP Wrapper</application> for this reason.</para>

      <para>It is a very good idea to protect internal services from
	external access by firewalling them off at your border routers.
	The idea here is to prevent saturation attacks from outside your
	LAN, not so much to protect internal services from network-based
	<username>root</username> compromise.
	Always configure an exclusive firewall, i.e.,
	<quote>firewall everything <emphasis>except</emphasis> ports A, B,
	C, D, and M-Z</quote>.  This way you can firewall off all of your
	low ports except for certain specific services such as
	<application>named</application> (if you are primary for a zone),
	<application>ntalkd</application>,
	<application>sendmail</application>, and other Internet-accessible
	services.  If you try to configure the firewall the other way
	&mdash; as an inclusive or permissive firewall, there is a good
	chance that you will forget to <quote>close</quote> a couple of
	services, or that you will add a new internal service and forget
	to update the firewall.  You can still open up the high-numbered
	port range on the firewall, to allow permissive-like operation,
	without compromising your low ports.  Also take note that &os;
	allows you to control the range of port numbers used for dynamic
	binding, via the various <varname>net.inet.ip.portrange</varname>
	<command>sysctl</command>'s (<command>sysctl -a | fgrep
	portrange</command>), which can also ease the complexity of your
	firewall's configuration.  For example, you might use a normal
	first/last range of 4000 to 5000, and a hiport range of 49152 to
	65535, then block off everything under 4000 in your firewall
	(except for certain specific Internet-accessible ports, of
	course).</para>

      <para>Another common DoS attack is called a springboard attack
	&mdash; to attack a server in a manner that causes the server to
	generate responses which overloads the server, the local
	network, or some other machine.  The most common attack of this
	nature is the <emphasis>ICMP ping broadcast attack</emphasis>.
	The attacker spoofs ping packets sent to your LAN's broadcast
	address with the source IP address set to the actual machine they
	wish to attack.  If your border routers are not configured to
	stomp on ping's to broadcast addresses, your LAN winds up
	generating sufficient responses to the spoofed source address to
	saturate the victim, especially when the attacker uses the same
	trick on several dozen broadcast addresses over several dozen
	different networks at once.  Broadcast attacks of over a hundred
	and twenty megabits have been measured.  A second common
	springboard attack is against the ICMP error reporting system.
	By constructing packets that generate ICMP error responses, an
	attacker can saturate a server's incoming network and cause the
	server to saturate its outgoing network with ICMP responses.  This
	type of attack can also crash the server by running it out of
	mbuf's, especially if the server cannot drain the ICMP responses
	it generates fast enough.
	Use the <application>sysctl</application>
	variable <literal>net.inet.icmp.icmplim</literal> to limit these attacks.
	The last major class of springboard
	attacks is related to certain internal 
	<application>inetd</application> services such as the
	udp echo service.  An attacker simply spoofs a UDP packet with the
	source address being server A's echo port, and the destination
	address being server B's echo port, where server A and B are both
	on your LAN.  The two servers then bounce this one packet back and
	forth between each other.  The attacker can overload both servers
	and their LANs simply by injecting a few packets in this manner.
	Similar problems exist with the internal 
	<application>chargen</application> port.  A
	competent sysadmin will turn off all of these inetd-internal test
	services.</para>

      <para>Spoofed packet attacks may also be used to overload the kernel
	route cache.  Refer to the <varname>net.inet.ip.rtexpire</varname>,
	<varname>rtminexpire</varname>, and <varname>rtmaxcache</varname>
	<command>sysctl</command> parameters.  A spoofed packet attack
	that uses a random source IP will cause the kernel to generate a
	temporary cached route in the route table, viewable with
	<command>netstat -rna | fgrep W3</command>.  These routes
	typically timeout in 1600 seconds or so.  If the kernel detects
	that the cached route table has gotten too big it will dynamically
	reduce the <varname>rtexpire</varname> but will never decrease it 
	to less than <varname>rtminexpire</varname>.  There are two 
	problems:</para>
	
      <orderedlist>
	<listitem>
	  <para>The kernel does not react quickly enough when a lightly
	    loaded server is suddenly attacked.</para>
	</listitem>
	
	<listitem>
	  <para>The <varname>rtminexpire</varname> is not low enough for
	    the kernel to survive a sustained attack.</para>
	</listitem>
      </orderedlist>
      
      <para>If your servers are connected to the Internet via a T3 or
        better, it may be prudent to manually override both
	<varname>rtexpire</varname> and <varname>rtminexpire</varname>
	via &man.sysctl.8;.  Never set either parameter to zero (unless
	you want to crash the machine).  Setting both
	parameters to 2 seconds should be sufficient to protect the route
	table from attack.</para>
    </sect2>

    <sect2>
      <title>Access Issues with Kerberos and SSH</title>
      <indexterm><primary><command>ssh</command></primary></indexterm>
      <indexterm><primary>KerberosIV</primary></indexterm>

      <para>There are a few issues with both Kerberos and
	ssh that need to be addressed if
	you intend to use them.  Kerberos V is an excellent
	authentication protocol, but there are bugs in the kerberized
	<application>telnet</application> and
	<application>rlogin</application> applications that make them
	unsuitable for dealing with binary streams.  Also, by default
	Kerberos does not encrypt a session unless you use the
	<option>-x</option> option.  <application>ssh</application>
	encrypts everything by default.</para>

      <para>ssh works quite well in every
	respect except that it forwards encryption keys by default.  What
	this means is that if you have a secure workstation holding keys
	that give you access to the rest of the system, and you
	ssh to an insecure machine, your keys
	are usable.  The actual keys themselves are not exposed, but
	ssh installs a forwarding port for the
	duration of your login, and if an attacker has broken
	<username>root</username> on the
	insecure machine he can utilize that port to use your keys to gain
	access to any other machine that your keys unlock.</para>

      <para>We recommend that you use ssh in
	combination with Kerberos whenever possible for staff logins.
	<application>ssh</application> can be compiled with Kerberos
	support.  This reduces your reliance on potentially exposed
	ssh keys while at the same time
	protecting passwords via Kerberos.  ssh
	keys should only be used for automated tasks from secure machines
	(something that Kerberos is unsuited to do).  We also recommend that
	you either turn off key-forwarding in the
	ssh configuration, or that you make use
	of the <literal>from=IP/DOMAIN</literal> option that
	ssh allows in its
	<filename>authorized_keys</filename> file to make the key only
	usable to entities logging in from specific machines.</para>
    </sect2>
  </sect1>

  <sect1 id="crypt">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Bill</firstname>
	  <surname>Swingle</surname>
	  <contrib>Czê¶ciowo przepisa³ i zaktualizowa³ </contrib>
	</author>
      </authorgroup>
      <!-- 21 Mar 2000 -->
    </sect1info>

    <title>DES, MD5 i Crypt</title>
    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>kryptografia</secondary>
    </indexterm>

    <indexterm><primary>kryptografia</primary></indexterm>
    <indexterm><primary>DES</primary></indexterm>
    <indexterm><primary>MD5</primary></indexterm>

    <para>Ka¿dy u¿ytkownik systemu &unix;, ma ze swoim kontem skojarzone
      has³o.  Wydaje siê oczywiste, ¿e has³o powinno byæ znane tylko u¿ytkownikowi
      i systemowi operacyjnemu.  Aby przechowywaæ has³a w bezpiecznej postaci,
      szyfrowane s± one technik± zwan± <quote>skrótem jednostronnym</quote>
      (ang. <quote>one-way hash</quote>), czyli mog± byæ ³atwo zaszyfrowane
      lecz odwrócenie tego procesu jest praktycznie niemo¿liwe.  Innymi s³owy
      to co przed chwil± powiedzieli¶my nie jest do koñca prawd± - system operacyjny
      nie zna tak <emphasis>naprawdê</emphasis> hase³ - zna tylko <emphasis>zaszyfrowan±</emphasis>
      postaæ has³a.  Jedynym sposobem uzyskania has³a w postaci <quote>czystego tekstu</quote>
      jest przeszukanie ca³ej przestrzeni mo¿liwych kombinacji i sprawdzenie, która postaæ
      jawna daje dok³adnie ten sam skrót.</para>

    <para>Niestety, jedyny sposób szyfrowania hase³ który pojawi³ siê wraz z Uniksem
      bazowa³ na DES, Standardzie Szyfrowania Danych (ang. Data Encryption Standard).
      Nie jest to problem dla u¿ytkowników mieszkaj±cych na sta³e w Stanach Zjednoczonych,
      ale poniewa¿ kod ¼ród³owy DES nie móg³ byæ eksportowany poza USA, &os; musia³o
      znale¼æ sposób aby dopasowaæ siê zarówno do prawa Stanów Zjednoczonych jak
      i kompatybilno¶ci z wersjami systemu &unix; u¿ywaj±cymi szyfrowania DES.</para>

    <para>Rozwi±zaniem okaza³o siê podzielenie bibliotek szyfruj±cych tak, by u¿ytkownicy
      w Stanach Zjednoczonych mogli zainstalowaæ ich wersje DES, a u¿ytkownicy miêdzynarodowi
      nadal mieli dostêp do jakiej¶ metody szyfrowania.  W ten sposób dosz³o do zastosowania
      we &os; jako domy¶lnego algorytmu szyfrowania MD5.  MD5 jest uwa¿any za bezpieczniejszy
      ni¿ DES, wiêc opcja instalacji standardu DES zachowana zosta³a przede wszystkim z uwagi
      na zagadnienia kompatybilno¶ci.</para>

    <sect2>
      <title>Identyfikacja metody szyfrowania</title>

      <para>Obecnie obs³ugiwane s± funkcje szyfrowania DES, MD5 i Blowfish.  Domy¶lnie
	do szyfrowania hase³ &os; wykorzystuje MD5.</para>

      <para>Identyfikacja metody, której &os; u¿ywa do szyfrowania hase³ jest stosunkowo
        prosta.  Sprawdzenie hase³ zebranych w pliku <filename>/etc/master.passwd</filename>
        jest jednym ze sposobów.  Has³a zaszyfrowane algorytmem MD5 s± d³u¿sze ni¿ zaszyfrowane
        przez DES i zaczynaj± siê znakiem <literal>&dollar;1&dollar;</literal>.  Has³a zaczynaj±ce
        siê od <literal>&dollar;2a&dollar;</literal> zaszyfrowane s± za pomoc± mechanizmu
        Blowfish.  Algorytm DES nie posiada ³atwo rozró¿nialnych cech, ale has³a s± krótsze ni¿
        te szyfrowane MD5 i kodowane 64-znakowych alfabetem, który nie zawiera znaku
        <literal>&dollar;</literal>.  Zatem relatywnie krótki ci±g znaków, nie zaczynaj±cy siê
        od dolara jest z du¿ym prawdopodobieñstwem has³em DES.</para>

      <para>Format hase³ u¿ywany dla nowo ustawianych hase³ kontrolowany jest przez opcjê
        <literal>passwd_format</literal> w pliku <filename>/etc/login.conf</filename>.  Mo¿e
        ona przyj±æ warto¶æ <literal>des</literal>, <literal>md5</literal>
        lub <literal>blf</literal>.  Strona podrêcznika systemowego &man.login.conf.5; zawiera
        wiêcej informacji o mo¿liwo¶ciach zmiany parametrów logowania.</para>

    </sect2>
  </sect1>

  <sect1 id="one-time-passwords">
    <title>Has³a jednorazowe</title>
    <indexterm><primary>one-time passwords</primary></indexterm>
    <indexterm>
      <primary>security</primary>
      <secondary>one-time passwords</secondary>
    </indexterm>

    <para>By default, &os; includes suppor for OPIE (One-time Passwords
      In Everything), which uses the MD5 hash by default.</para>

    <para>There are three different sorts of passwords which we will discuss
      below.  The first is your usual &unix; style or
      Kerberos password; we will call this a <quote>&unix; password</quote>.
      The second sort is the one-time password which is generated by the OPIE
      &man.opiekey.1; program and accepted by the
      &man.opiepasswd.1; program
      and the login prompt; we will
      call this a <quote>one-time password</quote>.  The final sort of
      password is the secret password which you give to the
      <command>opiekey</command> program (and
      sometimes the
      <command>opiepasswd</command> programs)
      which it uses to generate
      one-time passwords; we will call it a <quote>secret password</quote>
      or just unqualified <quote>password</quote>.</para>

    <para>The secret password does not have anything to do with your &unix;
      password; they can be the same but this is not recommended.
      OPIE secret passwords are not limited to 8 characters like old
      &unix; passwords<footnote><para>Under &os; the standard login
      password may be up to 128 characters in length.</para></footnote>,
      they can be as long as you like.  Passwords of six or
      seven word long phrases are fairly common.  For the most part, the
      OPIE system operates completely independently of the &unix;
      password system.</para>

    <para>Besides the password, there are two other pieces of data that
      are important to OPIE.  One is what is known as the
      <quote>seed</quote> or <quote>key</quote>, consisting of two letters
      and five digits.  The other is what is called the <quote>iteration
      count</quote>, a number between 1 and 100.  OPIE creates the
      one-time password by concatenating the seed and the secret password,
      then applying the MD5 hash as many times as specified by the
      iteration count and turning the result into six short English words.
      These six English words are your one-time password.  The
      authentication system (primarily PAM) keeps
      track of the last one-time password used, and the user is
      authenticated if the hash of the user-provided password is equal to
      the previous password.  Because a one-way hash is used it is
      impossible to generate future one-time passwords if a successfully
      used password is captured; the iteration count is decremented after
      each successful login to keep the user and the login program in
      sync.  When the iteration count gets down to 1, OPIE must be
      reinitialized.</para>

    <para>There are a few programs involved in each system
      which we will discuss below.  The
      <command>opiekey</command> program accepts an iteration
      count, a seed, and a secret password, and generates a one-time
      password or a consecutive list of one-time passwords.  The
      <command>opiepasswd</command>
      program is used to initialize OPIE,
      and to change passwords, iteration counts, or seeds; it
      takes either a secret passphrase, or an iteration count,
      seed, and a one-time password.  The
      <command>opieinfo</command> program will examine the
      relevant credentials files
      (<filename>/etc/opiekeys</filename>) and print out the invoking user's
      current iteration count and seed.</para>

    <para>There are four different sorts of operations we will cover.  The
      first is using
      <command>opiepasswd</command> over a secure connection to set up
      one-time-passwords for the first time,  or to change your password
      or seed.  The second operation is using
      <command>opiepasswd</command> over an insecure connection, in
      conjunction with <command>opiekey</command>
      over a secure connection,  to do the same.  The third is using
      <command>opiekey</command> to log in over
      an insecure connection.  The fourth is using
      <command>opiekey</command> to generate a number of keys which
      can be written down or printed out to carry with you when going to
      some location without secure connections to anywhere.</para>

    <sect2>
      <title>Secure Connection Initialization</title>
      <para>To initialize OPIE for the first time, execute the
        <command>opiepasswd</command> command:</para>

      <screen>&prompt.user; <userinput>opiepasswd -c</userinput>
[grimreaper] ~ $ opiepasswd -f -c
Adding unfurl:
Only use this method from the console; NEVER from remote. If you are using
telnet, xterm, or a dial-in, type ^C now or exit with no password.
Then run opiepasswd without the -c parameter.
Using MD5 to compute responses.
Enter new secret pass phrase:
Again new secret pass phrase:
ID unfurl OTP key is 499 to4268
MOS MALL GOAT ARM AVID COED
</screen>

      <para>At the <prompt>Enter new secret pass phrase:</prompt> or
        <prompt>Enter secret password:</prompt> prompts, you
	should enter a password or phrase.  Remember, this is not the
	password that you will use to login with, this is used to generate
	your one-time login keys.  The <quote>ID</quote> line gives the
	parameters of your particular instance: your login name, the
        iteration count, and seed.  When logging in the system
	will remember these parameters and present them back to you so you
	do not have to remember them.  The last line gives the particular
	one-time password which corresponds to those parameters and your
	secret password; if you were to re-login immediately, this
	one-time password is the one you would use.</para>
    </sect2>

    <sect2>
      <title>Insecure Connection Initialization</title>
      
      <para>To initialize or change your secret password over an
	insecure connection, you will need to already have a secure
	connection to some place where you can run
        <command>opiekey</command>; this might be in the form of a shell
	prompt on a machine you
	trust.  You will also need to make up an iteration count (100 is
	probably a good value), and you may make up your own seed or use a
	randomly-generated one.  Over on the insecure connection (to the
	machine you are initializing), use <command>opiepasswd</command>:</para>

      <screen>&prompt.user; <userinput>opiepasswd</userinput>

Updating unfurl:
You need the response from an OTP generator.
Old secret pass phrase:
        otp-md5 498 to4268 ext
        Response: GAME GAG WELT OUT DOWN CHAT
New secret pass phrase:
        otp-md5 499 to4269
        Response: LINE PAP MILK NELL BUOY TROY

ID mark OTP key is 499 gr4269
LINE PAP MILK NELL BUOY TROY
</screen>

      <para>To accept the default seed press <keycap>Return</keycap>.
	Then before entering an
	access password, move over to your secure connection and give it
	the same parameters:</para>

      <screen>&prompt.user; <userinput>opiekey 498 to4268</userinput>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT
</screen>

      <para>Now switch back over to the insecure connection, and copy the
	one-time password generated over to the relevant program.</para>
    </sect2>

    <sect2>
      <title>Generating a Single One-time Password</title>

      <para>Once you have initialized OPIE and login, you will be 
	presented with a prompt like this:</para>

<screen>&prompt.user; <userinput>telnet example.com</userinput>
Trying 10.0.0.1...
Connected to example.com
Escape character is '^]'.

FreeBSD/i386 (example.com) (ttypa)

login: <userinput>&lt;username&gt;</userinput>
otp-md5 498 gr4269 ext
Password: </screen>

      <para>As a side note, the OPIE prompts have a useful feature
	(not shown here): if you press <keycap>Return</keycap>
	at the password prompt, the
	prompter will turn echo on, so you can see what you are
	typing.  This can be extremely useful if you are attempting to
	type in a password by hand, such as from a printout.</para>

      <indexterm><primary>MS-DOS</primary></indexterm>
      <indexterm><primary>Windows</primary></indexterm>
      <indexterm><primary>MacOS</primary></indexterm>

      <para>At this point you need to generate your one-time password to
	answer this login prompt.  This must be done on a trusted system
	that you can run
        <command>opiekey</command> on.  (There are versions of these for DOS,
	&windows; and &macos; as well.) They need the iteration count and
	the seed as command line options.  You can cut-and-paste these
        right from the login prompt on the machine that you are logging
        in to.</para>

      <para>On the trusted system:</para>

      <screen>&prompt.user; <userinput>opiekey 498 to4268</userinput>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT</screen>

      <para>Now that you have your one-time password you can continue
	logging in.</para>
    </sect2>

    <sect2>
      <title>Generating Multiple One-time Passwords</title>

      <para>Sometimes you have to go places where you do not have
	access to a trusted machine or secure connection.  In this case,
	it is possible to use the
	<command>opiekey</command> command to
	generate a number of one-time passwords beforehand to be printed
	out and taken with you.  For example:</para>

      <screen>&prompt.user; <userinput>opiekey -n 5 30 zz99999</userinput>
Using the MD5 algorithm to compute response.
Reminder: Don't use opiekey from telnet or dial-in sessions.
Enter secret pass phrase: <userinput>&lt;secret password&gt;</userinput>
26: JOAN BORE FOSS DES NAY QUIT
27: LATE BIAS SLAY FOLK MUCH TRIG
28: SALT TIN ANTI LOON NEAL USE
29: RIO ODIN GO BYE FURY TIC
30: GREW JIVE SAN GIRD BOIL PHI</screen>

      <para>The <option>-n 5</option> requests five keys in sequence, the
	<option>30</option> specifies what the last iteration number
	should be.  Note that these are printed out in
	<emphasis>reverse</emphasis> order of eventual use.  If you are
	really paranoid, you might want to write the results down by hand;
	otherwise you can cut-and-paste into <command>lpr</command>.  Note
	that each line shows both the iteration count and the one-time
	password; you may still find it handy to scratch off passwords as
	you use them.</para>
    </sect2>

    <sect2>
      <title>Restricting Use of &unix; Passwords</title>

      <para>OPIE can restrict the use of &unix; passwords based on the IP
	address of a login session.  The relevant file
	is <filename>/etc/opieaccess</filename>, which is present by default.
	Please check &man.opieaccess.5;
	for more information on this file and which security considerations
	you should be aware of when using it.</para>
	
      <para>Here is a sample <filename>opieaccess</filename> file:</para>

      <programlisting>permit 192.168.0.0 255.255.0.0</programlisting>

      <para>This line allows users whose IP source address (which is
	vulnerable to spoofing) matches the specified value and mask,
	to use &unix; passwords at any time.</para>
	
      <para>If no rules in <filename>opieaccess</filename> are matched,
	the default is to deny non-OPIE logins.</para>

    </sect2>
  </sect1>

  <sect1 id="tcpwrappers">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Written by: </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <indexterm><primary>TCP Wrappers</primary></indexterm>
      
    <title>TCP Wrappers</title>

    <para>Anyone familiar with &man.inetd.8; has probably heard
      of <acronym>TCP</acronym> Wrappers at some point.  But few
      individuals seem to fully comprehend its usefulness in a
      network environment.  It seems that everyone wants to
      install a firewall to handle network connections.  While a
      firewall has a wide variety of uses, there are some things
      that a firewall not handle such as sending text back to the
      connection originator.  The <acronym>TCP</acronym> software
      does this and much more.  In the next few sections many of
      the <acronym>TCP</acronym> Wrappers features will be discussed,
      and, when applicable, example configuration lines will be
      provided.</para>

    <para>The <acronym>TCP</acronym> Wrappers software extends the
      abilities of <command>inetd</command> to provide support for
      every server daemon under its control.  Using this method it
      is possible to provide logging support, return messages to
      connections, permit a daemon to only accept internal connections,
      etc.  While some of these features can be provided by implementing
      a firewall, this will add not only an extra layer of protection
      but go beyond the amount of control a firewall can
      provide.</para>

    <para>The added functionality of <acronym>TCP</acronym> Wrappers
      should not be considered a replacement for a good firewall.
      <acronym>TCP</acronym> Wrappers can be used in conjunction
      with a firewall or other security enhancements though and
      it can serve nicely as an extra layer of protection
      for the system.</para>

    <para>Since this is an extension to the configuration of
      <command>inetd</command>, the reader is expected have
      read the <link linkend="network-inetd">inetd configuration</link>
      section.</para>

    <note>
      <para>While programs run by &man.inetd.8; are not exactly
	<quote>daemons</quote>, they have traditionally been called
	daemons.  This is the term we will use in this section too.</para>
    </note>

    <sect2>
      <title>Initial Configuration</title>

      <para>The only requirement of using <acronym>TCP</acronym>
	Wrappers in &os; is to ensure the <command>inetd</command>
	server is started from <filename>rc.conf</filename> with the
	<option>-Ww</option> option; this is the default setting.  Of
	course,	proper configuration of
	<filename>/etc/hosts.allow</filename> is also expected, but
	&man.syslogd.8; will throw messages in the system logs in
	these cases.</para>

      <note>
	<para>Unlike other implementations of <acronym>TCP</acronym>
	  Wrappers, the use of <filename>hosts.deny</filename> has
	  been deprecated.  All configuration options should be placed
	  in <filename>/etc/hosts.allow</filename>.</para>
      </note>

      <para>In the simplest configuration, daemon connection policies
	are set to either be permitted or blocked depending on the
	options in <filename>/etc/hosts.allow</filename>.  The default
	configuration in &os; is to allow a connection to every daemon
	started with <command>inetd</command>.  Changing this will be
	discussed only after the basic configuration is covered.</para>

      <para>Basic configuration usually takes the form of
	<literal>daemon : address : action</literal>.  Where
	<literal>daemon</literal> is the daemon name which
	<command>inetd</command> started.  The
	<literal>address</literal> can be a valid hostname, an
	<acronym>IP</acronym> address or an IPv6 address enclosed in
	brackets ([&nbsp;]).  The action field can be either allow
	or deny	to grant or deny access appropriately.  Keep in mind
	that configuration works off a first rule match semantic,
	meaning that the configuration file is scanned in ascending
	order for a matching rule.  When a match is found the rule
	is applied and the search process will halt.</para>

      <para>Several other options exist but they will be explained
	in a later section.  A simple configuration line may easily be
	constructed from that information alone.  For example, to
	allow <acronym>POP</acronym>3 connections via the
	<filename role="package">mail/qpopper</filename> daemon,
	the following lines should be appended to
	<filename>hosts.allow</filename>:</para>

      <programlisting># This line is required for POP3 connections:
qpopper : ALL : allow</programlisting>

      <para>After adding this line, <command>inetd</command> will need
	restarted.  This can be accomplished by use of the &man.kill.1;
	command, or with the <parameter>restart</parameter> parameter
	with <filename>/etc/rc.d/inetd</filename>.</para>
      </sect2>

      <sect2>
        <title>Advanced Configuration</title>

      <para><acronym>TCP</acronym> Wrappers has advanced
	options too; they will allow for more control over the
	way connections are handled.  In some cases it may be
	a good idea to return a comment to certain hosts or
	daemon connections.  In other cases, perhaps a log file
	should be recorded or an email sent to the administrator.
	Other situations may require the use of a service for local
	connections only.  This	is all possible through the use of
	configuration options known as <literal>wildcards</literal>,
	expansion characters and external command execution.  The
	next two sections are written to cover these situations.</para>
	
      <sect3>
	<title>External Commands</title>

	<para>Suppose that a situation occurs where a connection
	  should be denied yet a reason should be sent to the
	  individual who attempted to establish that connection.  How
	  could it be done?  That action can be made possible by
	  using the <option>twist</option> option.  When a connection
	  attempt is made, <option>twist</option> will be called to
	  execute a shell command or script.  An example already exists
	  in the <filename>hosts.allow</filename> file:</para>

	<programlisting># The rest of the daemons are protected.
ALL : ALL \
        : severity auth.info \
        : twist /bin/echo "You are not welcome to use %d from %h."</programlisting>

	<para>This example shows that the message,
	  <quote>You are not allowed to use <literal>daemon</literal>
	  from <literal>hostname</literal>.</quote> will be returned
	  for any daemon not previously configured in the access file.
	  This is extremely useful for sending a reply back to the
	  connection initiator right after the established connection
	  is dropped.  Note that any message returned
	  <emphasis>must</emphasis> be wrapped in quote
	  <literal>"</literal> characters; there are no exceptions to
	  this rule.</para>

	<warning>
	  <para>It may be possible to launch a denial of service attack
	    on the server if an attacker, or group of attackers could
	    flood these daemons with connection requests.</para>
	</warning>

	<para>Another possibility is to use the <option>spawn</option>
	  option in these cases.  Like <option>twist</option>, the
	  <option>spawn</option> implicitly denies the connection and
	  may be used to run external shell commands or scripts.
	  Unlike <option>twist</option>, <option>spawn</option> will
	  not send a reply back to the individual who established the
	  connection.  For an example, consider the following
	  configuration line:</para>

	<programlisting># We do not allow connections from example.com:
ALL : .example.com \
	: spawn (/bin/echo %a from %h attempted to access %d &gt;&gt; \
	  /var/log/connections.log) \
	: deny</programlisting>

	<para>This will deny all connection attempts from the
	  <hostid role="fqdn">*.example.com</hostid> domain;
	  simultaneously logging the hostname, <acronym>IP</acronym>
	  address and the daemon which they attempted to access in the
	  <filename>/var/log/connections.log</filename> file.</para>

	<para>Aside from the already explained substitution characters
	  above, e.g. %a, a few others exist.  See the
	  &man.hosts.access.5; manual page for the complete list.</para>
      </sect3>

      <sect3>
	<title>Wildcard Options</title>

	<para>Thus far the <literal>ALL</literal> example has been used
	  continuously throughout the examples.  Other options exist
	  which could extend the functionality a bit further.  For
	  instance, <literal>ALL</literal> may be used to match every
	  instance of either a daemon, domain or an
	  <acronym>IP</acronym> address. Another wildcard available is
	  <literal>PARANOID</literal> which may be used to match any
	  host which provides an <acronym>IP</acronym> address that may
	  be forged.  In other words, <literal>paranoid</literal> may
	  be used to define an action to be taken whenever a connection
	  is made from an <acronym>IP</acronym> address that differs
	  from its hostname.  The following example may shed some more
	  light on this discussion:</para>

	<programlisting># Block possibly spoofed requests to sendmail:
sendmail : PARANOID : deny</programlisting>

	<para>In that example all connection requests to
	  <command>sendmail</command> which have an
	  <acronym>IP</acronym> address that varies from its hostname
	  will be denied.</para>

	<caution>
	  <para>Using the <literal>PARANOID</literal> may severely
	    cripple servers if the client or server has a broken
	    <acronym>DNS</acronym> setup.  Administrator discretion
	    is advised.</para>
	</caution>

	<para>To learn more about wildcards and their associated
	  functionality, see the &man.hosts.access.5; manual
	  page.</para>

	<para>Before any of the specific configuration lines above will
	  work, the first configuration line should be commented out
	  in <filename>hosts.allow</filename>.  This was noted at the
	  beginning of this section.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 id="kerberosIV">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Mark</firstname>
	  <surname>Murray</surname>
	  <contrib>Napisa³ </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Mark</firstname>
	  <surname>Dapoz</surname>
	  <contrib>Na podstawie pracy </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title><application>KerberosIV</application></title>

    <para>Kerberos to sieciowy system/protokó³ umo¿liwiaj±cy uwierzytelnianie
      siê u¿ytkownikom dziêki us³ugom udostêpnianym przez bezpieczny serwer.
      Kerberos zwiêksza bezpieczeñstwo i poziom kontroli nad us³ugami takimi
      jak rlogin, zdalne kopiowanie, kopiowanie w obrêbie systemu.</para>

    <para>Poni¿sze instrukcje mo¿na zastosowaæ jako przewodnik po konfiguracji
      Kerberosa w takiej postaci, w jakiej dostêpny jest on w systemie &os;.
      Powinni¶my jednak zajrzeæ równie¿ do stron podrêcznika aby mieæ kompletny
      obraz systemu.</para>

    <sect2>
      <title>Instalacja <application>KerberosIV</application></title>

      <indexterm><primary>MIT</primary></indexterm>
      <indexterm>
	<primary>KerberosIV</primary>
	<secondary>instalalacja</secondary>
      </indexterm>
      <para>Kerberos jest opcjonalnym komponentem &os;.  Najprostszym sposobem instalacji
        jest wybranie pozycji <literal>krb4</literal> lub <literal>krb5</literal> podczas
        instalacji systemu za pomoc± programu <application>sysinstall</application>.
        Zainstaluje to odpowiednio <quote>eBones</quote> (KerberosIV) lub <quote>Heimdal</quote>
        (Kerberos5).  Za³±czono je do dystrybucji systemu, poniewa¿ tworzone s± poza USA/Kanad±
        i by³y dostêpne w czasie restrykcji co do eksportu kodu kryptograficznego poza granice
        USA.</para>

      <para>Mo¿liwe jest równie¿ zastosowanie implementacji MIT Kerberosa, dostêpnej w kolekcji
        portów jako <filename role="package">security/krb5</filename>.</para>
    </sect2>

    <sect2>
      <title>Tworzenie pocz±tkowej bazy danych</title>
      
      <para>Operacjê tê przeprowadza siê tylko na serwerze Kerberosa.  Na pocz±tek upewnijmy
        siê, ¿e nie posiadamy starszych baz danych.  Przejd¼my do katalogu
        <filename>/etc/kerberosIV</filename> i sprawd¼my, czy znajduj± siê w nim tylko
        poni¿sze pliki:</para>
	  
      <screen>&prompt.root; <userinput>cd /etc/kerberosIV</userinput>
&prompt.root; <userinput>ls</userinput>
README		krb.conf        krb.realms</screen>
	  
      <para>Je¶li znajduj± siê tu dodatkowe pliki (np. <filename>principal.*</filename> lub
        <filename>master_key</filename>), musimy wpierw u¿yæ polecenia <command>kdb_destroy</command>,
        by skasowaæ star± bazê Kerberosa - lub je¶li akurat us³uga ta nie pracuje, po prostu
        usun±æ dodatkowe pliki.</para>
	  
      <para>Nastêpnie powinni¶my zmodyfikowaæ pliki <filename>krb.conf</filename>
        i <filename>krb.realms</filename>, by okre¶liæ otoczenie (ang. realm) Kerberosa.
        W tym przypadku bêdzie to <literal>EXAMPLE.COM</literal>, a serwerem
        <hostid role="fqdn">grunt.example.com</hostid>. Edytujemy lub tworzymy
        plik <filename>krb.conf</filename>:</para>
	  
      <screen>&prompt.root; <userinput>cat krb.conf</userinput>
EXAMPLE.COM
EXAMPLE.COM grunt.example.com admin server
CS.BERKELEY.EDU okeeffe.berkeley.edu
ATHENA.MIT.EDU kerberos.mit.edu
ATHENA.MIT.EDU kerberos-1.mit.edu
ATHENA.MIT.EDU kerberos-2.mit.edu
ATHENA.MIT.EDU kerberos-3.mit.edu
LCS.MIT.EDU kerberos.lcs.mit.edu
TELECOM.MIT.EDU bitsy.mit.edu
ARC.NASA.GOV trident.arc.nasa.gov</screen>
	  
      <para>In this case, the other realms do not need to be there.  They are
	here as an example of how a machine may be made aware of multiple
	realms.  You may wish to not include them for simplicity.</para>
	  
      <para>The first line names the realm in which this system works.  The
	other lines contain realm/host entries.  The first item on a line is a
	realm, and the second is a host in that realm that is acting as a
	<quote>key distribution center</quote>.  The words <literal>admin
	  server</literal> following a host's name means that host also
	provides an administrative database server.  For further explanation
	of these terms, please consult the Kerberos manual pages.</para>
	  
      <para>Now we have to add <hostid role="fqdn">grunt.example.com</hostid>
	to the <literal>EXAMPLE.COM</literal> realm and also add an entry to
	put all hosts in the <hostid role="domainname">.example.com</hostid>
	domain in the <literal>EXAMPLE.COM</literal> realm.  The
	<filename>krb.realms</filename> file would be updated as
	follows:</para>
	  
      <screen>&prompt.root; <userinput>cat krb.realms</userinput>
grunt.example.com EXAMPLE.COM
.example.com EXAMPLE.COM
.berkeley.edu CS.BERKELEY.EDU
.MIT.EDU ATHENA.MIT.EDU
.mit.edu ATHENA.MIT.EDU</screen>
	  
      <para>Again, the other realms do not need to be there.  They are here as
	an example of how a machine may be made aware of multiple realms.  You
	may wish to remove them to simplify things.</para>
	  
      <para>The first line puts the <emphasis>specific</emphasis> system into
	the named realm.  The rest of the lines show how to default systems of
	a particular subdomain to a named realm.</para>
	  
      <para>Now we are ready to create the database.  This only needs to run
	on the Kerberos server (or Key Distribution Center).  Issue the
	<command>kdb_init</command> command to do this:</para>
	  
      <screen>&prompt.root; <userinput>kdb_init</userinput>
<prompt>Realm name [default  ATHENA.MIT.EDU ]:</prompt> <userinput>EXAMPLE.COM</userinput>
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.
		
<prompt>Enter Kerberos master key:</prompt> </screen>
	  
      <para>Now we have to save the key so that servers on the local machine
	can pick it up.  Use the <command>kstash</command> command to do
	this:</para>
	
      <screen>&prompt.root; <userinput>kstash</userinput>
	      
<prompt>Enter Kerberos master key:</prompt>

Current Kerberos master key version is 1.

Master key entered. BEWARE!</screen>
	
      <para>This saves the encrypted master password in
	<filename>/etc/kerberosIV/master_key</filename>.</para>
    </sect2>
    
    <sect2>
      <title>Making It All Run</title>
	
      <indexterm>
	<primary>KerberosIV</primary>
	<secondary>initial startup</secondary>
      </indexterm>

      <para>Two principals need to be added to the database for
	<emphasis>each</emphasis> system that will be secured with Kerberos.
	Their names are <literal>kpasswd</literal> and <literal>rcmd</literal>.
	These two principals are made for each system, with the instance being
	the name of the individual system.</para>
	  
      <para>These daemons, <application>kpasswd</application> and
	<application>rcmd</application> allow other systems to change Kerberos
	passwords and run commands like &man.rcp.1;,
	&man.rlogin.1; and &man.rsh.1;.</para>
	  
      <para>Now let us add these entries:</para>
	    
      <screen>&prompt.root; <userinput>kdb_edit</userinput>
Opening database...

<prompt>Enter Kerberos master key:</prompt>

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Previous or default values are in [brackets] ,
enter return to leave the same, or new value.

<prompt>Principal name:</prompt> <userinput>passwd</userinput>
<prompt>Instance:</prompt> <userinput>grunt</userinput>

&lt;Not found&gt;, <prompt>Create [y] ?</prompt> <userinput>y</userinput>

Principal: passwd, Instance: grunt, kdc_key_ver: 1
<prompt>New Password:</prompt>                    &lt;---- enter RANDOM here
Verifying password

<prompt>New Password:</prompt> &lt;---- enter RANDOM here

<prompt>Random password [y] ?</prompt> <userinput>y</userinput>

Principal's new key version = 1
<prompt>Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?</prompt>
<prompt>Max ticket lifetime (*5 minutes) [ 255 ] ?</prompt>
<prompt>Attributes [ 0 ] ?</prompt>
Edit O.K.
<prompt>Principal name:</prompt> <userinput>rcmd</userinput>
<prompt>Instance:</prompt> <userinput>grunt</userinput>

&lt;Not found&gt;, <prompt>Create [y] ?</prompt>

Principal: rcmd, Instance: grunt, kdc_key_ver: 1
<prompt>New Password:</prompt>		&lt;---- enter RANDOM here
Verifying password

<prompt>New Password:</prompt>           &lt;---- enter RANDOM here

<prompt>Random password [y] ?</prompt>

Principal's new key version = 1
<prompt>Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?</prompt>
<prompt>Max ticket lifetime (*5 minutes) [ 255 ] ?</prompt>
<prompt>Attributes [ 0 ] ?</prompt>
Edit O.K.
<prompt>Principal name:</prompt>         &lt;---- null entry here will cause an exit</screen>
    </sect2>

    <sect2>
      <title>Creating the Server File</title>
      
      <para>We now have to extract all the instances which define the
	services on each machine.  For this we use the
	<command>ext_srvtab</command> command.  This will create a file
	which must be copied or moved <emphasis>by secure
	  means</emphasis> to each Kerberos client's
	<filename>/etc/kerberosIV</filename> directory.  This file must
	be present on each server and client, and is crucial to the
	operation of Kerberos.</para>
	  
	  
      <screen>&prompt.root; <userinput>ext_srvtab grunt</userinput>
<prompt>Enter Kerberos master key:</prompt>
		
Current Kerberos master key version is 1.

Master key entered. BEWARE!
Generating 'grunt-new-srvtab'....</screen>
	  
      <para>Now, this command only generates a temporary file which must be
	renamed to <filename>srvtab</filename> so that all the servers can pick
	it up.  Use the &man.mv.1; command to move it into place on
	the original system:</para>
	  
      <screen>&prompt.root; <userinput>mv grunt-new-srvtab srvtab</userinput></screen>
	  
      <para>If the file is for a client system, and the network is not deemed
	safe, then copy the
	<filename><replaceable>client</replaceable>-new-srvtab</filename> to
	removable media and transport it by secure physical means.  Be sure to
	rename it to <filename>srvtab</filename> in the client's
	<filename>/etc/kerberosIV</filename> directory, and make sure it is
	mode 600:</para>
	  
      <screen>&prompt.root; <userinput>mv grumble-new-srvtab srvtab</userinput>
&prompt.root; <userinput>chmod 600 srvtab</userinput></screen>
    </sect2>
    
    <sect2>
      <title>Populating the Database</title>
      
      <para>We now have to add some user entries into the database.  First
	let us create an entry for the user <username>jane</username>.  Use the
	<command>kdb_edit</command> command to do this:</para>
	  
      <screen>&prompt.root; <userinput>kdb_edit</userinput>
Opening database...

<prompt>Enter Kerberos master key:</prompt>

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Previous or default values are in [brackets] ,
enter return to leave the same, or new value.

<prompt>Principal name:</prompt> <userinput>jane</userinput>
<prompt>Instance:</prompt>

&lt;Not found&gt;, <prompt>Create [y] ?</prompt> <userinput>y</userinput>

Principal: jane, Instance: , kdc_key_ver: 1
<prompt>New Password:</prompt>                &lt;---- enter a secure password here
Verifying password

<prompt>New Password:</prompt>                &lt;---- re-enter the password here
Principal's new key version = 1
<prompt>Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?</prompt>
<prompt>Max ticket lifetime (*5 minutes) [ 255 ] ?</prompt>
<prompt>Attributes [ 0 ] ?</prompt>
Edit O.K.
<prompt>Principal name:</prompt>		   &lt;---- null entry here will cause an exit</screen>
    </sect2>

    <sect2>
      <title>Testing It All Out</title>
      
      <para>First we have to start the Kerberos daemons.  Note that if you
	have correctly edited your <filename>/etc/rc.conf</filename> then this
	will happen automatically when you reboot.  This is only necessary on
	the Kerberos server.  Kerberos clients will automatically get what
	they need from the <filename>/etc/kerberosIV</filename>
	directory.</para>
	  
      <screen>&prompt.root; <userinput>kerberos &amp;</userinput>
Kerberos server starting
Sleep forever on error
Log file is /var/log/kerberos.log
Current Kerberos master key version is 1.

Master key entered. BEWARE!

Current Kerberos master key version is 1
Local realm: EXAMPLE.COM
&prompt.root; <userinput>kadmind -n &amp;</userinput>
KADM Server KADM0.0A initializing
Please do not use 'kill -9' to kill this job, use a
regular kill instead

Current Kerberos master key version is 1.

Master key entered.  BEWARE!</screen>
	  
      <para>Now we can try using the <command>kinit</command> command to get a
	ticket for the ID <username>jane</username> that we created
	above:</para>
	  
      <screen>&prompt.user; <userinput>kinit jane</userinput>
MIT Project Athena (grunt.example.com)
Kerberos Initialization for "jane"
<prompt>Password:</prompt> </screen>
	  
      <para>Try listing the tokens using <command>klist</command> to see if we
	really have them:</para>
	  
      <screen>&prompt.user; <userinput>klist</userinput>
Ticket file:    /tmp/tkt245
Principal:      jane@EXAMPLE.COM

  Issued           Expires          Principal
Apr 30 11:23:22  Apr 30 19:23:22  krbtgt.EXAMPLE.COM@EXAMPLE.COM</screen>
	  
      <para>Now try changing the password using &man.passwd.1; to
	check if the <application>kpasswd</application> daemon can get 
	authorization to the Kerberos database:</para>
	  
      <screen>&prompt.user; <userinput>passwd</userinput>
realm EXAMPLE.COM
<prompt>Old password for jane:</prompt>
<prompt>New Password for jane:</prompt>
Verifying password
<prompt>New Password for jane:</prompt>
Password changed.</screen>
    </sect2>

    <sect2>
      <title>Adding <command>su</command> Privileges</title>
      
      <para>Kerberos allows us to give <emphasis>each</emphasis> user
	who needs <username>root</username> privileges their own
	<emphasis>separate</emphasis> &man.su.1; password.
	We could now add an ID which is authorized to
	&man.su.1; to <username>root</username>.  This is
	controlled by having an instance of <username>root</username>
	associated with a principal.  Using <command>kdb_edit</command>
	we can create the entry <literal>jane.root</literal> in the
	Kerberos database:</para>
	  
      <screen>&prompt.root; <userinput>kdb_edit</userinput>
Opening database...

<prompt>Enter Kerberos master key:</prompt>

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Previous or default values are in [brackets] ,
enter return to leave the same, or new value.

<prompt>Principal name:</prompt> <userinput>jane</userinput>
<prompt>Instance:</prompt> <userinput>root</userinput>

&lt;Not found&gt;, Create [y] ? y

Principal: jane, Instance: root, kdc_key_ver: 1
<prompt>New Password:</prompt>                    &lt;---- enter a SECURE password here
Verifying password

<prompt>New Password:</prompt>    	 	 &lt;---- re-enter the password here

Principal's new key version = 1
<prompt>Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?</prompt>
<prompt>Max ticket lifetime (*5 minutes) [ 255 ] ?</prompt> <userinput>12</userinput> &lt;--- Keep this short!
<prompt>Attributes [ 0 ] ?</prompt>
Edit O.K.
<prompt>Principal name:</prompt>		         &lt;---- null entry here will cause an exit</screen>
	  
      <para>Now try getting tokens for it to make sure it works:</para>
      
      <screen>&prompt.root; <userinput>kinit jane.root</userinput>
MIT Project Athena (grunt.example.com)
Kerberos Initialization for "jane.root"
<prompt>Password:</prompt></screen>
	  
      <para>Now we need to add the user to <username>root</username>'s
	  <filename>.klogin</filename> file:</para>
	  
      <screen>&prompt.root; <userinput>cat /root/.klogin</userinput>
jane.root@EXAMPLE.COM</screen>
	  
      <para>Now try doing the &man.su.1;:</para>
	  
      <screen>&prompt.user; <userinput>su</userinput>
<prompt>Password:</prompt></screen>
	  
      <para>and take a look at what tokens we have:</para>
	  
      <screen>&prompt.root; <userinput>klist</userinput>
Ticket file:	/tmp/tkt_root_245
Principal:      jane.root@EXAMPLE.COM

  Issued           Expires          Principal
May  2 20:43:12  May  3 04:43:12  krbtgt.EXAMPLE.COM@EXAMPLE.COM</screen>
    </sect2>

    <sect2>
      <title>Using Other Commands</title>
      
      <para>In an earlier example, we created a principal called
	<literal>jane</literal> with an instance <literal>root</literal>.
	This was based on a user with the same name as the principal, and this
	is a Kerberos default; that a
	<literal>&lt;principal&gt;.&lt;instance&gt;</literal> of the form
	<literal>&lt;username&gt;.</literal><username>root</username> will allow
	that <literal>&lt;username&gt;</literal> to &man.su.1; to
	<username>root</username> if the necessary entries are in the
	<filename>.klogin</filename> file in <username>root</username>'s
	home directory:</para>
	  
      <screen>&prompt.root; <userinput>cat /root/.klogin</userinput>
jane.root@EXAMPLE.COM</screen>
      
      <para>Likewise, if a user has in their own home directory lines of the
	form:</para>
      
      <screen>&prompt.user; <userinput>cat ~/.klogin</userinput>
jane@EXAMPLE.COM
jack@EXAMPLE.COM</screen>
	  
      <para>This allows anyone in the <literal>EXAMPLE.COM</literal> realm
	who has authenticated themselves as <username>jane</username> or
	<username>jack</username> (via <command>kinit</command>, see above)
	to access to <username>jane</username>'s
	account or files on this system (<hostid>grunt</hostid>) via
	&man.rlogin.1;, &man.rsh.1; or
	&man.rcp.1;.</para>
	  
      <para>For example, <username>jane</username> now logs into another system using
	Kerberos:</para>
	  
	    <screen>&prompt.user; <userinput>kinit</userinput>
MIT Project Athena (grunt.example.com)
<prompt>Password:</prompt>
&prompt.user; <userinput>rlogin grunt</userinput>
Last login: Mon May  1 21:14:47 from grumble
Copyright (c) 1980, 1983, 1986, 1988, 1990, 1991, 1993, 1994
        The Regents of the University of California.   All rights reserved.

FreeBSD BUILT-19950429 (GR386) #0: Sat Apr 29 17:50:09 SAT 1995</screen>
	  
      <para>Or <username>jack</username> logs into <username>jane</username>'s account on the same machine
	(<username>jane</username> having
	set up the <filename>.klogin</filename> file as above, and the person
	in charge of Kerberos having set up principal
	<emphasis>jack</emphasis> with a null instance):</para>
	  
      <screen>&prompt.user; <userinput>kinit</userinput>
&prompt.user; <userinput>rlogin grunt -l jane</userinput>
MIT Project Athena (grunt.example.com)
<prompt>Password:</prompt>
Last login: Mon May  1 21:16:55 from grumble
Copyright (c) 1980, 1983, 1986, 1988, 1990, 1991, 1993, 1994
        The Regents of the University of California.   All rights reserved.
FreeBSD BUILT-19950429 (GR386) #0: Sat Apr 29 17:50:09 SAT 1995</screen>
    </sect2>
  </sect1>

  <sect1 id="kerberos5">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tillman</firstname>
	  <surname>Hodgson</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Mark</firstname>
	  <surname>Murray</surname>
	  <contrib>Based on a contribution by </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title><application>Kerberos5</application></title>

    <para>Every &os; release beyond &os;-5.1 includes support
      only for <application>Kerberos5</application>.  Hence
      <application>Kerberos5</application> is the only version
      included, and its configuration is similar in many aspects
      to that of <application>KerberosIV</application>.  The following
      information only applies to
      <application>Kerberos5</application> in post &os;-5.0
      releases.  Users who wish to use the
      <application>KerberosIV</application> package may install the
      <filename role="package">security/krb4</filename> port.</para>

    <para><application>Kerberos</application> is a network add-on
      system/protocol that allows users to authenticate themselves
      through the services of a secure server.  Services such as remote
      login, remote copy, secure inter-system file copying and other
      high-risk tasks are made considerably safer and more
      controllable.</para>

    <para><application>Kerberos</application> can be described as an
      identity-verifying proxy system.  It can also be described as a
      trusted third-party authentication system.
      <application>Kerberos</application> provides only one
      function &mdash; the secure authentication of users on the network.
      It does not provide authorization functions (what users are
      allowed to do) or auditing functions (what those users did).
      After a client and server have used
      <application>Kerberos</application> to prove their identity, they
      can also encrypt all of their communications to assure privacy
      and data integrity as they go about their business.</para>

    <para>Therefore it is highly recommended that
      <application>Kerberos</application> be used with other security
      methods which provide authorization and audit services.</para>

    <para>The following instructions can be used as a guide on how to set
      up <application>Kerberos</application> as distributed for &os;.
      However, you should refer to the relevant manual pages for a complete
      description.</para>

    <para>For purposes of demonstrating a <application>Kerberos</application>
      installation, the various name spaces will be handled as follows:</para>

    <itemizedlist>
      <listitem>
	<para>The <acronym>DNS</acronym> domain (<quote>zone</quote>)
	  will be example.org.</para>
      </listitem>

      <listitem>
	<para>The <application>Kerberos</application> realm will be
	  EXAMPLE.ORG.</para>
      </listitem>
    </itemizedlist>

    <note>
      <para>Please use real domain names when setting up
	<application>Kerberos</application> even if you intend to run
	it internally.  This avoids <acronym>DNS</acronym> problems
	and assures inter-operation with other
	<application>Kerberos</application> realms.</para>
    </note>

    <sect2>
      <title>History</title>
      <indexterm>
	<primary>Kerberos5</primary>
	<secondary>history</secondary>
      </indexterm>

      <para><application>Kerberos</application> was created by
	<acronym>MIT</acronym> as a solution to network security problems.
	The <application>Kerberos</application> protocol uses strong
	cryptography so that a client can prove its identity to a server
	(and vice versa) across an insecure network connection.</para>

      <para><application>Kerberos</application> is both the name of a
	network authentication protocol and an adjective to describe
	programs that implement the program
	(<application>Kerberos</application> telnet, for example).  The
	current version of the protocol is version 5, described in
	<acronym>RFC</acronym>&nbsp;1510.</para>

      <para>Several free implementations of this protocol are available,
	covering a wide range of operating systems.  The Massachusetts
	Institute of Technology (<acronym>MIT</acronym>), where
	<application>Kerberos</application> was originally developed,
	continues to develop their <application>Kerberos</application>
	package.  It is commonly used in the <acronym>US</acronym>
	as a cryptography product, as such it
	has historically been affected by <acronym>US</acronym> export
	regulations.  The <acronym>MIT</acronym>
	<application>Kerberos</application> is available as a port
	(<filename role="package">security/krb5</filename>).  Heimdal
	<application>Kerberos</application> is another version 5
	implementation, and was explicitly developed outside of the
	<acronym>US</acronym> to avoid export
	regulations (and is thus often included in non-commercial &unix;
	variants).  The Heimdal <application>Kerberos</application>
	distribution is available as a port
	(<filename role="package">security/heimdal</filename>), and a
	minimal installation of it is included in the base &os;
	install.</para>

    <para>In order to reach the widest audience, these instructions assume
	the use of the Heimdal distribution included in &os;.</para>

    </sect2>

    <sect2>
      <title>Setting up a Heimdal <acronym>KDC</acronym></title>
      <indexterm>
	<primary>Kerberos5</primary>
	<secondary>Key Distribution Center</secondary>
      </indexterm>

      <para>The Key Distribution Center (<acronym>KDC</acronym>) is the
	centralized authentication service that
	<application>Kerberos</application> provides &mdash; it is the
	computer that issues <application>Kerberos</application> tickets.
	The <acronym>KDC</acronym> is considered <quote>trusted</quote> by
	all other computers in the <application>Kerberos</application>
	realm, and thus has heightened security concerns.</para>

    <para>Note that while running the <application>Kerberos</application>
	server requires very few computing resources, a dedicated machine
	acting only as a <acronym>KDC</acronym> is recommended for security
	reasons.</para>

    <para>To begin setting up a <acronym>KDC</acronym>, ensure that your
	<filename>/etc/rc.conf</filename> file contains the correct
	settings to act as a <acronym>KDC</acronym> (you may need to adjust
	paths to reflect your own system):</para>

    <programlisting>kerberos5_server_enable="YES"
kadmind5_server_enable="YES"</programlisting>

      <para>Next we will set up your <application>Kerberos</application>
	config file, <filename>/etc/krb5.conf</filename>:</para>

      <programlisting>[libdefaults]
    default_realm = EXAMPLE.ORG
[realms]
    EXAMPLE.ORG = {
        kdc = kerberos.example.org
        admin_server = kerberos.example.org
    }
[domain_realm]
    .example.org = EXAMPLE.ORG</programlisting>

      <para>Note that this <filename>/etc/krb5.conf</filename> file implies
	that your <acronym>KDC</acronym> will have the fully-qualified
	hostname of <hostid role="fqdn">kerberos.example.org</hostid>.
	You will need to add a CNAME (alias) entry to your zone file to
	accomplish this if your <acronym>KDC</acronym> has a different
	hostname.</para>

      <note>
	<para>For large networks with a properly configured
	  <acronym>BIND</acronym> <acronym>DNS</acronym> server, the
	  above example could be trimmed to:</para>

	<programlisting>[libdefaults]
      default_realm = EXAMPLE.ORG</programlisting>

	<para>With the following lines being appended to the
	  <hostid role="fqdn">example.org</hostid> zonefile:</para>

	<programlisting>_kerberos._udp      IN  SRV     01 00 88 kerberos.example.org.
_kerberos._tcp      IN  SRV     01 00 88 kerberos.example.org.
_kpasswd._udp       IN  SRV     01 00 464 kerberos.example.org.
_kerberos-adm._tcp  IN  SRV     01 00 749 kerberos.example.org.
_kerberos           IN  TXT     EXAMPLE.ORG</programlisting></note>

      <note>
        <para>For clients to be able to find the
          <application>Kerberos</application> services, you
          <emphasis>must</emphasis> have either a fully configured
          <filename>/etc/krb5.conf</filename> or a minimally configured
          <filename>/etc/krb5.conf</filename> <emphasis>and</emphasis> a
          properly configured DNS server.</para>
      </note>

      <para>Next we will create the <application>Kerberos</application>
	database.  This database contains the keys of all principals encrypted
	with a master password.  You are not
	required to remember this password, it will be stored in a file
	(<filename>/var/heimdal/m-key</filename>).  To create the master
	key, run <command>kstash</command> and enter a password.</para>

      <para>Once the master key has been created, you can initialize the
	database using the <command>kadmin</command> program with the
	<literal>-l</literal> option (standing for <quote>local</quote>).
	This option instructs <command>kadmin</command> to modify the
	database files directly rather than going through the
	<command>kadmind</command> network service.  This handles the
	chicken-and-egg problem of trying to connect to the database
	before it is created.  Once you have the <command>kadmin</command>
	prompt, use the <command>init</command> command to create your
	realms initial database.</para>

      <para>Lastly, while still in <command>kadmin</command>, create your
	first principal using the <command>add</command> command.  Stick
	to the defaults options for the principal for now, you can always
	change them later with the <command>modify</command> command.
	Note that you can use the <literal>?</literal> command at any
	prompt to see the available options.</para>

      <para>A sample database creation session is shown below:</para>

      <screen>&prompt.root; <userinput>kstash</userinput>
Master key: <userinput>xxxxxxxx</userinput>
Verifying password - Master key: <userinput>xxxxxxxx</userinput>

&prompt.root; <userinput>kadmin -l</userinput>
kadmin> <userinput>init EXAMPLE.ORG</userinput>
Realm max ticket life [unlimited]:
kadmin> <userinput>add tillman</userinput>
Max ticket life [unlimited]:
Max renewable life [unlimited]:
Attributes []:
Password: <userinput>xxxxxxxx</userinput>
Verifying password - Password: <userinput>xxxxxxxx</userinput></screen>

      <para>Now it is time to start up the <acronym>KDC</acronym> services.
	Run <command>/etc/rc.d/kerberos start</command> and
	<command>/etc/rc.d/kadmind start</command> to bring up the
	services.  Note that you will not have any kerberized daemons running
	at this point but you should be able to confirm the that the
	<acronym>KDC</acronym> is functioning by obtaining and listing a
	ticket for the principal (user) that you just created from the
	command-line of the <acronym>KDC</acronym> itself:</para>

      <screen>&prompt.user; <userinput>k5init <replaceable>tillman</replaceable></userinput>
tillman@EXAMPLE.ORG's Password:

&prompt.user; <userinput>k5list</userinput>
Credentials cache: FILE:<filename>/tmp/krb5cc_500</filename>
	Principal: tillman@EXAMPLE.ORG

  Issued           Expires          Principal
Aug 27 15:37:58  Aug 28 01:37:58  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG</screen>

      </sect2>

      <sect2>
	<title><application>Kerberos</application> enabling a server with
	  Heimdal services</title>

        <indexterm>
	  <primary>Kerberos5</primary>
	  <secondary>enabling services</secondary>
        </indexterm>

	<para>First, we need a copy of the <application>Kerberos</application>
	  configuration file, <filename>/etc/krb5.conf</filename>.  To do
	  so, simply copy it over to the client computer from the
	  <acronym>KDC</acronym> in a secure fashion (using network utilities,
	  such as &man.scp.1;, or physically via a
	  floppy disk).</para>

	<para>Next you need a <filename>/etc/krb5.keytab</filename> file.
	  This is the major difference between a server providing
	  <application>Kerberos</application> enabled daemons and a
	  workstation &mdash; the server must have a
	  <filename>keytab</filename> file.  This file
	  contains the servers host key, which allows it and the
	  <acronym>KDC</acronym> to verify each others identity.  It
	  must be transmitted to the server in a secure fashion, as the
	  security of the server can be broken if the key is made public.
	  This explicitly means that transferring it via a clear text
	  channel, such as <acronym>FTP</acronym>, is a very bad idea.</para>

	<para>Typically, you transfer to the <filename>keytab</filename>
	  to the server using the <command>kadmin</command> program.
	  This is handy because you also need to create the host principal
	  (the <acronym>KDC</acronym> end of the
	  <filename>krb5.keytab</filename>) using
	  <command>kadmin</command>.</para>

	<para>Note that you must have already obtained a ticket and that this
	  ticket must be allowed to use the <command>kadmin</command>
	  interface in the <filename>kadmind.acl</filename>.  See the section
	  titled <quote>Remote administration</quote> in the Heimdal info
	  pages (<command>info heimdal</command>) for details on designing
	  access control lists.  If you do not want to enable remote
	  <command>kadmin</command> access, you can simply securely connect
	  to the <acronym>KDC</acronym> (via local console,
	  &man.ssh.1; or <application>Kerberos</application>
	  &man.telnet.1;) and perform administration locally
	  using <command>kadmin -l</command>.</para>

	<para>After installing the <filename>/etc/krb5.conf</filename> file,
	  you can use <command>kadmin</command> from the
	  <application>Kerberos</application> server.  The
	  <command>add --random-key</command> command will let you add the
	  servers host principal, and the <command>ext</command> command
	  will allow you to extract the servers host principal to its own
	  keytab.  For example:</para>

	<screen>&prompt.root; <userinput>kadmin</userinput>
kadmin><userinput> add --random-key host/myserver.example.org</userinput>
Max ticket life [unlimited]:
Max renewable life [unlimited]:
Attributes []:
kadmin><userinput> ext host/myserver.example.org</userinput>
kadmin><userinput> exit</userinput></screen>

	<para>Note that the <command>ext</command> command (short for
	  <quote>extract</quote>) stores the extracted key in
	  <filename>/etc/krb5.keytab</filename> by default.</para>

	<para>If you do not have <command>kadmind</command> running on the
	  <acronym>KDC</acronym> (possibly for security reasons) and thus
	  do not have access to <command>kadmin</command> remotely, you
	  can add the host principal
	  (<username>host/myserver.EXAMPLE.ORG</username>) directly on the
	  <acronym>KDC</acronym> and then extract it to a temporary file
	  (to avoid over-writing the <filename>/etc/krb5.keytab</filename>
	  on the <acronym>KDC</acronym>) using something like this:</para>

	<screen>&prompt.root; <userinput>kadmin</userinput>
kadmin><userinput> ext --keytab=/tmp/example.keytab host/myserver.example.org</userinput>
kadmin><userinput> exit</userinput></screen>

	<para>You can then securely copy the keytab to the server
	  computer (using <command>scp</command> or a floppy, for
	  example).  Be sure to specify a non-default keytab name
	  to avoid over-writing the keytab on the
	  <acronym>KDC</acronym>.</para>

	<para>At this point your server can communicate with the
	  <acronym>KDC</acronym> (due to its <filename>krb5.conf</filename>
	  file) and it can prove its own identity (due to the
	  <filename>krb5.keytab</filename> file).  It is now ready for
	  you to enable some <application>Kerberos</application> services.
	  For this example we will enable the <command>telnet</command>
	  service by putting a line like this into your
	  <filename>/etc/inetd.conf</filename> and then restarting the
	  &man.inetd.8; service with
	  <command>/etc/rc.d/inetd restart</command>:</para>

	<programlisting>telnet    stream  tcp     nowait  root    /usr/libexec/telnetd  telnetd -a user</programlisting>

	<para>The critical bit is that the <command>-a</command>
	  (for authentication) type is set to user.  Consult the
	  &man.telnetd.8; manual page for more details.</para>

      </sect2>

      <sect2>
	<title><application>Kerberos</application> enabling a client with Heimdal</title>

	<indexterm>
	  <primary>Kerberos5</primary>
	  <secondary>configure clients</secondary>
	</indexterm>

	<para>Setting up a client computer is almost trivially easy.  As
	  far as <application>Kerberos</application> configuration goes,
	  you only need the <application>Kerberos</application>
	  configuration file, located at <filename>/etc/krb5.conf</filename>.
	  Simply securely copy it over to the client computer from the
	  <acronym>KDC</acronym>.</para>

	<para>Test your client computer by attempting to use
	  <command>kinit</command>, <command>klist</command>, and
	  <command>kdestroy</command> from the client to obtain, show, and
	  then delete a ticket for the principal you created above.  You
	  should also be able to use <application>Kerberos</application>
	  applications to connect to <application>Kerberos</application>
	  enabled servers, though if that does not work and obtaining a
	  ticket does the problem is likely with the server and not with
	  the client or the <acronym>KDC</acronym>.</para>

	<para>When testing an application like <command>telnet</command>,
	  try using a packet sniffer (such as &man.tcpdump.1;)
	  to confirm that your password is not sent in the clear.  Try
	  using <command>telnet</command> with the <literal>-x</literal>
	  option, which encrypts the entire data stream (similar to
	  <command>ssh</command>).</para>

	<para>The core <application>Kerberos</application> client applications
	  (traditionally named <command>kinit</command>,
	  <command>klist</command>, <command>kdestroy</command>, and
	  <command>kpasswd</command>) are installed in
	  the base &os; install. Note that &os; versions prior to 5.0
	  renamed them to <command>k5init</command>,
	  <command>k5list</command>, <command>k5destroy</command>,
	  <command>k5passwd</command>, and <command>k5stash</command>
	  (though it is typically only used once).</para>

	<para>Various non-core <application>Kerberos</application> client
	  applications are also installed by default.  This is where the
	  <quote>minimal</quote> nature of the base Heimdal installation is
	  felt: <command>telnet</command> is the only
	  <application>Kerberos</application> enabled service.</para>

	<para>The Heimdal port adds some of the missing client applications:
	  <application>Kerberos</application> enabled versions of
	  <command>ftp</command>, <command>rsh</command>,
	  <command>rcp</command>, <command>rlogin</command>, and a few
	  other less common programs. The <acronym>MIT</acronym> port also
	  contains a full suite of <application>Kerberos</application>
	  client applications.</para>

      </sect2>

      <sect2>
	<title>User configuration files: <filename>.k5login</filename> and <filename>.k5users</filename></title>

	<indexterm>
	  <primary><filename>.k5login</filename></primary>
	</indexterm>

	<indexterm>
	  <primary><filename>.k5users</filename></primary>
	</indexterm>

	<para>Users within a realm typically have their
	  <application>Kerberos</application> principal (such as
	  <username>tillman@EXAMPLE.ORG</username>) mapped to a local
	  user account (such as a local account named
	  <username>tillman</username>).  Client applications such as
	  <command>telnet</command> usually do not require a user name
	  or a principal.</para>

	<para>Occasionally, however, you want to grant access to a local
	  user account to someone who does not have a matching
	  <application>Kerberos</application> principal.  For example,
	  <username>tillman@EXAMPLE.ORG</username> may need access to the
	  local user account <username>webdevelopers</username>.  Other
	  principals may also need access to that local account.</para>

	<para>The <filename>.k5login</filename> and
	  <filename>.k5users</filename> files, placed in a users home
	  directory, can be used similar to a powerful combination of
	  <filename>.hosts</filename> and <filename>.rhosts</filename>,
	  solving this problem. For example, if a
	  <filename>.k5login</filename> with the following
	  contents:</para>

	<screen>tillman@example.org
jdoe@example.org</screen>

	<para>Were to be placed into the home directory of the local user
	  <username>webdevelopers</username> then both principals listed
	  would have access to that account without requiring a shared
	  password.</para>

	<para>Reading the manual pages for these commands is recommended.
	  Note that the <command>ksu</command> manual page covers
	  <filename>.k5users</filename>.</para>

      </sect2>

      <sect2>
	<title><application>Kerberos</application> Tips, Tricks, and Troubleshooting</title>

	<indexterm>
	  <primary>Kerberos5</primary>
	  <secondary>troubleshooting</secondary>
	</indexterm>

	<itemizedlist>
	  <listitem>
	    <para>When using either the Heimdal or <acronym>MIT</acronym>
	      <application>Kerberos</application> ports ensure that your
	      <envar>PATH</envar> environment variable lists the
	      <application>Kerberos</application> versions of the client
	      applications before the system versions.</para>
	  </listitem>

	  <listitem>
	    <para>Do all the computers in your realm have synchronized
	      time settings?  If not, authentication may fail.
	      <xref linkend="network-ntp"> describes how to synchronize
	      clocks using <acronym>NTP</acronym>.</para>
	  </listitem>

	  <listitem>
	    <para><acronym>MIT</acronym> and Heimdal inter-operate nicely.
	      Except for <command>kadmin</command>, the protocol for
	      which is not standardized.</para>
	  </listitem>

	  <listitem>
	    <para>If you change your hostname, you also need to change your
	      <username>host/</username> principal and update your keytab.
	      This also applies to special keytab entries like the
	      <username>www/</username> principal used for Apache's
	      <filename role="package">www/mod_auth_kerb</filename>.</para>
	  </listitem>

	  <listitem>
	    <para>All hosts in your realm must be resolvable (both forwards
	      and reverse) in <acronym>DNS</acronym> (or
	      <filename>/etc/hosts</filename> as a minimum).  CNAMEs
	      will work, but the A and PTR records must be correct and in
	      place. The error message is not very intuitive:
	      <errorname>Kerberos5 refuses authentication because Read req
	      failed: Key table entry not found</errorname>.</para>
	  </listitem>

	  <listitem>
	    <para>Some operating systems that may being acting as clients
	      to your <acronym>KDC</acronym> do not set the permissions
	      for <command>ksu</command> to be setuid
	      <username>root</username>.  This means that
	      <command>ksu</command> does not work, which is a good
	      security idea but annoying. This is not a
	      <acronym>KDC</acronym> error.</para>
	  </listitem>

	  <listitem>
	    <para>With <acronym>MIT</acronym>
	      <application>Kerberos</application>, if you want to allow a
	      principal to have a ticket life longer than the default ten
	      hours, you must use <command>modify_principal</command> in
	      <command>kadmin</command> to change the maxlife of both the
	      principal in question and the <username>krbtgt</username>
	      principal.  Then the principal can use the
	      <literal>-l</literal> option with <command>kinit</command>
	      to request a ticket with a longer lifetime.</para>
	  </listitem>

	  <listitem>
	    <note><para>If you run a packet sniffer on your
	      <acronym>KDC</acronym> to add in troubleshooting and then
	      run <command>kinit</command> from a workstation, you will
	      notice that your <acronym>TGT</acronym> is sent
	      immediately upon running <command>kinit</command> &mdash;
	      even before you type your password!  The explanation is
	      that the <application>Kerberos</application> server freely
	      transmits a <acronym>TGT</acronym> (Ticket Granting
	      Ticket) to any unauthorized request;  however, every
	      <acronym>TGT</acronym> is encrypted in a key derived from
	      the user's password.  Therefore, when a user types their
	      password it is not being sent to the <acronym>KDC</acronym>,
	      it is being used to decrypt the <acronym>TGT</acronym> that
	      <command>kinit</command> already obtained. If the decryption
	      process results in a valid ticket with a valid time stamp,
	      the user has valid <application>Kerberos</application>
	      credentials.  These credentials include a session key for
	      establishing secure communications with the
	      <application>Kerberos</application> server in the future, as
	      well as the actual ticket-granting ticket, which is actually
	      encrypted with the <application>Kerberos</application>
	      server's own key.  This second layer of encryption is
	      unknown to the user, but it is what allows the
	      <application>Kerberos</application> server to verify
	      the authenticity of each <acronym>TGT</acronym>.</para></note>
	  </listitem>

	  <listitem>
	    <para>If you want to use long ticket lifetimes (a week, for
	      example) and you are using <application>OpenSSH</application>
	      to connect to the machine where your ticket is stored, make
	      sure that <application>Kerberos</application>
	      <option>TicketCleanup</option> is set to <literal>no</literal>
	      in your <filename>sshd_config</filename> or else your tickets
	      will be deleted when you log out.</para>
	  </listitem>

	  <listitem>
	    <para>Remember that host principals can have a longer ticket
	      lifetime as well.  If your user principal has a lifetime of a
	      week but the host you are connecting to has a lifetime of nine
	      hours, you will have an expired host principal in your cache
	      and the ticket cache will not work as expected.</para>
	  </listitem>

	  <listitem>
	    <para>When setting up a <filename>krb5.dict</filename> file to
	    prevent specific bad passwords from being used (the manual page
	    for <command>kadmind</command> covers this briefly), remember
	    that it only applies to principals that have a password policy
	    assigned to them.  The <filename>krb5.dict</filename> files
	    format is simple: one string per line.  Creating a symbolic
	    link to <filename>/usr/share/dict/words</filename> might be
	    useful.</para>
	  </listitem>
        </itemizedlist>

      </sect2>

      <sect2>
	<title>Differences with the <acronym>MIT</acronym> port</title>

	<para>The major difference between the <acronym>MIT</acronym>
	  and Heimdal installs relates to the <command>kadmin</command>
	  program which has a different (but equivalent) set of commands
	  and uses a different protocol.  This has a large implications
	  if your <acronym>KDC</acronym> is <acronym>MIT</acronym> as you
	  will not be able to use the Heimdal <command>kadmin</command>
	  program to administer your <acronym>KDC</acronym> remotely
	  (or vice versa, for that matter).</para>

	<para>The client applications may also take slightly different
	  command line options to accomplish the same tasks.  Following
	  the instructions on the <acronym>MIT</acronym>
	  <application>Kerberos</application> web site
	  (<ulink url="http://web.mit.edu/Kerberos/www/"></ulink>)
	  is recommended. Be careful of path issues: the
	  <acronym>MIT</acronym> port installs into
	  <filename>/usr/local/</filename> by default, and the
	  <quote>normal</quote> system applications may be run instead
	  of <acronym>MIT</acronym> if your <envar>PATH</envar>
	  environment variable lists the system directories first.</para>

	<note><para>With the <acronym>MIT</acronym>
	  <filename role="package">security/krb5</filename> port
	  that is provided by &os;, be sure to read the
	  <filename>/usr/local/share/doc/krb5/README.FreeBSD</filename>
	  file installed by the port if you want to understand why logins
	  via <command>telnetd</command> and <command>klogind</command>
	  behave somewhat oddly.  Most importantly, correcting the
	  <quote>incorrect permissions on cache file</quote> behavior
	  requires that the <command>login.krb5</command> binary be used
	  for authentication so that it can properly change ownership for
	  the forwarded credentials.</para></note>

      </sect2>

      <sect2>
	<title>Mitigating limitations found in <application>Kerberos</application></title>

	<indexterm>
	  <primary>Kerberos5</primary>
	  <secondary>limitations and shortcomings</secondary>
	</indexterm>

	<sect3>
	 <title><application>Kerberos</application> is an all-or-nothing approach</title>

	  <para>Every service enabled on the network must be modified to
	    work with <application>Kerberos</application> (or be otherwise
	    secured against network attacks) or else the users credentials
	    could be stolen and re-used.  An example of this would be
	    <application>Kerberos</application> enabling all remote shells
	    (via <command>rsh</command> and <command>telnet</command>, for
	    example) but not converting the <acronym>POP3</acronym> mail
	    server which sends passwords in plain text.</para>

	</sect3>

	<sect3>
	  <title><application>Kerberos</application> is intended for single-user workstations</title>

	  <para>In a multi-user environment,
	    <application>Kerberos</application> is less secure.
	    This is because it stores the tickets in the
	    <filename>/tmp</filename> directory, which is readable by all
	    users.  If a user is sharing a computer with several other
	    people simultaneously (i.e. multi-user), it is possible that
	    the user's tickets can be stolen (copied) by another
	    user.</para>

	  <para>This can be overcome with the <literal>-c</literal>
	    filename command-line option or (preferably) the
	    <envar>KRB5CCNAME</envar> environment variable, but this
	    is rarely done. In principal, storing the ticket in the users
	    home directory and using simple file permissions can mitigate
	    this problem.</para>

	</sect3>

	<sect3>
	  <title>The KDC is a single point of failure</title>

	  <para>By design, the <acronym>KDC</acronym> must be as secure as
	    the master password database is contained on it.  The
	    <acronym>KDC</acronym> should have absolutely no other
	    services running on it and should be physically secured.  The
	    danger is high because <application>Kerberos</application>
	    stores all passwords encrypted with the same key (the
	    <quote>master</quote> key), which in turn is stored as a file
	    on the <acronym>KDC</acronym>.</para>

	  <para>As a side note, a compromised master key is not quite as
	    bad as one might normally fear.  The master key is only used
	    to encrypt the <application>Kerberos</application> database
	    and as a seed for the random number generator.  As long as
	    access to your <acronym>KDC</acronym> is secure, an attacker
	    cannot do much with the master key.</para>

	  <para>Additionally, if the <acronym>KDC</acronym> is unavailable
	    (perhaps due to a denial of service attack or network problems)
	    the network services are unusable as authentication can not be
	    performed, a recipe for a denial-of-service attack.  This can
	    alleviated with multiple <acronym>KDC</acronym>s (a single
	    master and one or more slaves) and with careful implementation
	    of secondary or fall-back authentication
	    (<acronym>PAM</acronym> is excellent for this).</para>

	</sect3>

	<sect3>
	  <title><application>Kerberos</application> Shortcomings</title>

	  <para><application>Kerberos</application> allows users, hosts
	    and services to authenticate between themselves.  It does not
	    have a mechanism to authenticate the <acronym>KDC</acronym>
	    to the users, hosts or services.  This means that a trojanned
	    <command>kinit</command> (for example) could record all user
	    names and passwords.  Something like
	    <filename role="package">security/tripwire</filename> or
	    other file system integrity checking tools can alleviate
	    this.</para>

	</sect3>
      </sect2>

      <sect2>
	<title>Resources and further information</title>

	<indexterm>
	  <primary>Kerberos5</primary>
	  <secondary>external resources</secondary>
	</indexterm>

	<itemizedlist>
	  <listitem>
	  <para><ulink
	    url="http://www.faqs.org/faqs/Kerberos-faq/general/preamble.html">
	    The <application>Kerberos</application> FAQ</ulink></para>
	</listitem>

	<listitem>
	  <para><ulink url="http://web.mit.edu/Kerberos/www/dialogue.html">Designing
	    an Authentication System: a Dialog in Four Scenes</ulink></para>
	</listitem>

	<listitem>
	  <para><ulink url="http://www.ietf.org/rfc/rfc1510.txt?number=1510">RFC 1510,
	    The <application>Kerberos</application> Network Authentication Service
	    (V5)</ulink></para>
	</listitem>

	<listitem>
	  <para><ulink url="http://web.mit.edu/Kerberos/www/"><acronym>MIT</acronym>
	    <application>Kerberos</application> home page</ulink></para>
	</listitem>

	<listitem>
	<para><ulink url="http://www.pdc.kth.se/heimdal/">Heimdal
	  <application>Kerberos</application> home page</ulink></para>
	</listitem>

	</itemizedlist>
    </sect2>
  </sect1>

  <sect1 id="openssl">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Written by: </contrib>
	</author>
      </authorgroup>
    </sect1info>
    <title>OpenSSL</title>
    <indexterm>
      <primary>security</primary>
      <secondary>OpenSSL</secondary>
    </indexterm>

    <para>One feature that many users overlook is the
      <application>OpenSSL</application> toolkit included
      in &os;.  <application>OpenSSL</application> provides an
      encryption transport layer on top of the normal communications
      layer; thus allowing it to be intertwined with many network
      applications and services.</para>

    <para>Some uses of <application>OpenSSL</application> may include
      encrypted authentication of mail clients, web based transactions
      such as credit card payments and more.  Many ports such as
      <filename role="package">www/apache13-ssl</filename>, and
      <filename role="package">mail/sylpheed-claws</filename>
      will offer compilation support for building with
      <application>OpenSSL</application>.</para>

    <note>
      <para>In most cases the Ports Collection will attempt to build
	the <filename role="package">security/openssl</filename> port
	unless the <makevar>WITH_OPENSSL_BASE</makevar> make variable
	is explicitly set to <quote>yes</quote>.</para>
    </note>

    <para>The version of <application>OpenSSL</application> included
      in &os; supports Secure Sockets Layer v2/v3 (SSLv2/SSLv3),
      Transport Layer Security v1 (TLSv1) network security protocols
      and can be used as a general cryptographic library.</para>

    <note>
      <para>While <application>OpenSSL</application> supports the
	<acronym>IDEA</acronym> algorithm, it is disabled by default
	due to United States patents.  To use it, the license should
	be reviewed and, if the restrictions are acceptable, the
	<makevar>MAKE_IDEA</makevar> variable must be set in
	<filename>make.conf</filename>.</para>
    </note>

    <para>One of the most common uses of
      <application>OpenSSL</application> is to provide certificates for
      use with software applications.  These certificates ensure
      that the credentials of the company or individual are valid
      and not fraudulent.  If the certificate in question has
      not been verified by one of the several <quote>Certificate Authorities</quote>,
      or <acronym>CA</acronym>s, a warning is usually produced.  A
      Certificate Authority is a company, such as <ulink url="http://www.verisign.com">VeriSign</ulink>, which will
      sign certificates in order to validate credentials of individuals
      or companies.  This process has a cost associated with it and
      is definitely not a requirement for using certificates; however,
      it can put some of the more paranoid users at ease.</para>

    <sect2>
      <title>Generating Certificates</title>

      <indexterm>
	<primary>OpenSSL</primary>
	<secondary>certificate generation</secondary>
      </indexterm>

      <para>To generate a certificate, the following command is
	available:</para>

      <screen>&prompt.root; <userinput>openssl req -new -nodes -out req.pem -keyout cert.pem</userinput>
Generating a 1024 bit RSA private key
................++++++
.......................................++++++
writing new private key to 'cert.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<userinput><replaceable>US</replaceable></userinput>
State or Province Name (full name) [Some-State]:<userinput><replaceable>PA</replaceable></userinput>
Locality Name (eg, city) []:<userinput><replaceable>Pittsburgh</replaceable></userinput>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<userinput><replaceable>My Company</replaceable></userinput>
Organizational Unit Name (eg, section) []:<userinput><replaceable>Systems Administrator</replaceable></userinput>
Common Name (eg, YOUR name) []:<userinput><replaceable>localhost.example.org</replaceable></userinput>
Email Address []:<userinput><replaceable>trhodes@FreeBSD.org</replaceable></userinput>

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:<userinput><replaceable>SOME PASSWORD</replaceable></userinput>
An optional company name []:<userinput><replaceable>Another Name</replaceable></userinput></screen>

      <para>Notice the response directly after the
	<quote>Common Name</quote> prompt shows a domain name.
	This prompt requires a server name to be entered for
	verification purposes; placing anything	but a domain name
	would yield a useless certificate.  Other options, for
	instance expire time, alternate encryption algorithms, etc.
	are available.  A complete list may be obtained by viewing
	the &man.openssl.1; manual page.</para>

      <para>Two files should now exist in
	the directory in which the aforementioned command was issued.
	The certificate request, <filename>req.pem</filename>, may be
	sent to a certificate authority who will validate the credentials
	that you entered, sign the request and return the certificate to
	you.  The second file created will be named <filename>cert.pem</filename>
	and is the private key for the certificate and should be
	protected at all costs; if this falls in the hands of others it
	can be used to impersonate you (or your server).</para>

      <para>In cases where a signature from a <acronym>CA</acronym> is
	not required, a self signed certificate can be created.  First,
	generate the <acronym>RSA</acronym> key:</para>

      <screen>&prompt.root; <userinput>openssl dsaparam -rand -genkey -out <filename>myRSA.key</filename> 1024</userinput></screen>
	
	<para>Next, generate the <acronym>CA</acronym> key:</para>

      <screen>&prompt.root; <userinput>openssl gendsa -des3 -out <filename>myca.key</filename> <filename>myRSA.key</filename></userinput></screen>

      <para>Use this key to create the certificate:</para>

      <screen>&prompt.root; <userinput>openssl req -new -x509 -days 365 -key <filename>myca.key</filename> -out <filename>new.crt</filename></userinput></screen>

      <para>Two new files should appear in the directory: a certificate
	authority signature file, <filename>myca.key</filename> and the
	certificate itself, <filename>new.crt</filename>.  These should
	be placed in a directory, preferably under
	<filename class="directory">/etc</filename>, which is readable
	only by <username>root</username>.  Permissions of 0700 should be fine for this and
	they can be set with the <command>chmod</command>
	utility.</para>
    </sect2>

    <sect2>
      <title>Using Certificates, an Example</title>

      <para>So what can these files do?  A good use would be to
	encrypt connections to the <application>Sendmail</application>
	<acronym>MTA</acronym>.  This would dissolve the use of clear
	text authentication for users who send mail via the local
	<acronym>MTA</acronym>.</para>

      <note>
	<para>This is not the best use in the world as some
	  <acronym>MUA</acronym>s will present the user with an
	  error if they have not installed the certificate locally.
	  Refer to the documentation included with the software for
	  more information on certificate installation.</para>
      </note>

      <para>The following lines should be placed inside the
	local <filename>.mc</filename> file:</para>

      <programlisting>dnl SSL Options
define(`confCACERT_PATH',`/etc/certs')dnl
define(`confCACERT',`/etc/certs/new.crt')dnl
define(`confSERVER_CERT',`/etc/certs/new.crt')dnl
define(`confSERVER_KEY',`/etc/certs/myca.key')dnl
define(`confTLS_SRV_OPTIONS', `V')dnl</programlisting>

      <para>Where <filename class="directory">/etc/certs/</filename>
	is the directory to be used for storing the certificate
	and key files locally.  The last few requirements are a rebuild
	of the local <filename>.cf</filename> file.  This is easily
	achieved by typing <command>make</command>
	<parameter>install</parameter> within the
	<filename class="directory">/etc/mail</filename>
	directory.  Follow that up with <command>make</command>
	<parameter>restart</parameter> which should start the
	<application>Sendmail</application> daemon.</para>

      <para>If all went well there will be no error messages in the
	<filename>/var/log/maillog</filename> file and
	<application>Sendmail</application> will show up in the process
	list.</para>

      <para>For a simple test, simply connect to the mail server
	using the &man.telnet.1; utility:</para>

      <screen>&prompt.root; <userinput>telnet <replaceable>example.com</replaceable> 25</userinput>
Trying 192.0.34.166...
Connected to <hostid role="fqdn">example.com</hostid>.
Escape character is '^]'.
220 <hostid role="fqdn">example.com</hostid> ESMTP Sendmail 8.12.10/8.12.10; Tue, 31 Aug 2004 03:41:22 -0400 (EDT)
<userinput>ehlo <replaceable>example.com</replaceable></userinput>
250-example.com Hello example.com [192.0.34.166], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH LOGIN PLAIN
250-STARTTLS
250-DELIVERBY
250 HELP
<userinput>quit</userinput>
221 2.0.0 <hostid role="fqdn">example.com</hostid> closing connection
Connection closed by foreign host.</screen>

      <para>If the <quote>STARTTLS</quote> line appears in the output
	then everything is working correctly.</para>
    </sect2>
  </sect1>

  <sect1 id="ipsec">
    <sect1info>
      <authorgroup>
        <author>
  	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	  <affiliation>
	    <address><email>nik@FreeBSD.org</email></address>
          </affiliation>
          <contrib>Written by </contrib>
        </author>
      </authorgroup>
    </sect1info>

    <indexterm>
      <primary>IPsec</primary>
    </indexterm>

    <title>VPN over IPsec</title>
    <para>Creating a VPN between two networks, separated by the
      Internet, using FreeBSD gateways.</para>
 
    <sect2>
      <sect2info>
        <authorgroup>
          <author>
            <firstname>Hiten M.</firstname>
            <surname>Pandya</surname>
	    <affiliation>
	      <address><email>hmp@FreeBSD.org</email></address>
	    </affiliation>
	    <contrib>Written by </contrib>
	  </author>
	</authorgroup>
      </sect2info>

      <title>Understanding IPsec</title>

      <para>This section will guide you through the process of setting
	up IPsec, and to use it in an environment which consists of
	FreeBSD and <application>&microsoft.windows; 2000/XP</application>
	machines, to make them communicate securely.  In order to set up
	IPsec, it is necessary that you are familiar with the concepts
	of building a custom kernel (see
	<xref linkend="kernelconfig">).</para>
    
      <para><emphasis>IPsec</emphasis> is a protocol which sits on top
	of the Internet Protocol (IP) layer.  It allows two or more
	hosts to communicate in a secure manner (hence the name).  The
	FreeBSD IPsec <quote>network stack</quote> is based on the
	<ulink url="http://www.kame.net/">KAME</ulink> implementation,
	which has support for both protocol families, IPv4 and
	IPv6.</para>

      <note>
        <para>FreeBSD contains a <quote>hardware
        accelerated</quote> IPsec stack, known as <quote>Fast
        IPsec</quote>, that was obtained from OpenBSD.  It employs
        cryptographic hardware (whenever possible) via the
        &man.crypto.4; subsystem to optimize the performance of IPsec.
        This subsystem is new, and does not support all the features
        that are available in the KAME version of IPsec.  However, in
        order to enable hardware-accelerated IPsec, the following
        kernel option has to be added to your kernel configuration
        file:</para>

	<indexterm>
	  <primary>kernel options</primary>
	  <secondary>FAST_IPSEC</secondary>
	</indexterm>

        <screen>
options	  FAST_IPSEC  # new IPsec (cannot define w/ IPSEC)
        </screen>

        <para> Note, that it is not currently possible to use the
	  <quote>Fast IPsec</quote> subsystem in lieu of the KAME
	  implementation of IPsec.  Consult the &man.fast.ipsec.4;
	  manual page for more information.</para>
      </note>

      <note>
	<para>To let firewalls properly track state for &man.gif.4;
	  tunnels too, you have to enable the
	  <option>IPSEC_FILTERGIF</option> in your kernel
	  configuration:</para>

	<screen>
options   IPSEC_FILTERGIF  #filter ipsec packets from a tunnel
	</screen>
      </note>
  
      <indexterm>
	<primary>IPsec</primary>
	<secondary>ESP</secondary>
      </indexterm>
  
      <indexterm>
	<primary>IPsec</primary>
	<secondary>AH</secondary>
      </indexterm>

      <para>IPsec consists of two sub-protocols:</para>

      <itemizedlist>
        <listitem>
          <para><emphasis>Encapsulated Security Payload
	      (ESP)</emphasis>, protects the IP packet data from third
	    party interference, by encrypting the contents using
	    symmetric cryptography algorithms (like Blowfish,
	    3DES).</para>
        </listitem>
        <listitem>
          <para><emphasis>Authentication Header (AH)</emphasis>,
	    protects the IP packet header from third party interference
	    and spoofing, by computing a cryptographic checksum and
	    hashing the IP packet header fields with a secure hashing
	    function.  This is then followed by an additional header
	    that contains the hash, to allow the information in the
	    packet to be authenticated.</para>
        </listitem>
      </itemizedlist>
      
      <para><acronym>ESP</acronym> and <acronym>AH</acronym> can
	either be used together or separately, depending on the
	environment.</para>
      
      <indexterm>
	<primary>VPN</primary>
      </indexterm>

      <indexterm>
	<primary>virtual private network</primary>
	<see>VPN</see>
      </indexterm>

      <para>IPsec can either be used to directly encrypt the traffic
	between two hosts (known as <emphasis>Transport
	  Mode</emphasis>); or to build <quote>virtual tunnels</quote>
	between two subnets, which could be used for secure
	communication between two corporate networks (known as
	<emphasis>Tunnel Mode</emphasis>).  The latter is more commonly
	known as a <emphasis>Virtual Private Network (VPN)</emphasis>.
	The &man.ipsec.4; manual page should be consulted for detailed
	information on the IPsec subsystem in FreeBSD.</para>
      
      <para>To add IPsec support to your kernel, add the following
	options to your kernel configuration file:</para>

      <indexterm>
	<primary>kernel options</primary>
	<secondary>IPSEC</secondary>
      </indexterm>

      <indexterm>
	<primary>kernel options</primary>
	<secondary>IPSEC_ESP</secondary>
      </indexterm>

      <screen>
options   IPSEC        #IP security
options   IPSEC_ESP    #IP security (crypto; define w/ IPSEC)
      </screen>

      <indexterm>
	<primary>kernel options</primary>
	<secondary>IPSEC_DEBUG</secondary>
      </indexterm>

      <para>If IPsec debugging support is desired, the following
	kernel option should also be added:</para>

      <screen>
options   IPSEC_DEBUG  #debug for IP security
      </screen>
    </sect2>

    <sect2>
      <title>The Problem</title>
 
      <para>There is no standard for what constitutes a VPN.  VPNs can
	be implemented using a number of different technologies, each of
	which have their own strengths and weaknesses.  This section
	presents a scenario, and the strategies used for implementing a
	VPN for this scenario.</para>
    </sect2>
    
    <sect2> 
      <title>The Scenario: Two networks, connected to the Internet, to
        behave as one</title>
      
      <indexterm>
	<primary>VPN</primary>
	<secondary>creating</secondary>
      </indexterm>

      <para>The premise is as follows:</para>
      
      <itemizedlist>
        <listitem>
          <para>You have at least two sites</para>
        </listitem>
        <listitem>
          <para>Both sites are using IP internally</para>
        </listitem>
        <listitem>
          <para>Both sites are connected to the Internet, through a
            gateway that is running FreeBSD.</para>
        </listitem>
        <listitem>
          <para>The gateway on each network has at least one public IP
            address.</para>
        </listitem>
        <listitem>
          <para>The internal addresses of the two networks can be
            public or private IP addresses, it does not matter.  You can
            be running NAT on the gateway machine if necessary.</para>
        </listitem>
        <listitem>
          <para>The internal IP addresses of the two networks
            <emphasis>do not collide</emphasis>.  While I expect it is
            theoretically possible to use a combination of VPN
            technology and NAT to get this to work, I expect it to be a
            configuration nightmare.</para>
        </listitem>
      </itemizedlist>
      
      <para>If you find that you are trying to connect two networks,
        both of which, internally, use the same private IP address range
        (e.g. both of them use <hostid
        role="ipaddr">192.168.1.x</hostid>), then one of the networks will
        have to be renumbered.</para>
 
      <para>The network topology might look something like this:</para>
 
      <mediaobject>
	<imageobject>
	  <imagedata fileref="security/ipsec-network" align="center">
	</imageobject>

	<textobject>
<literallayout class="monospaced">Network #1            [ Internal Hosts ]    Private Net, 192.168.1.2-254
                      [   Win9x/NT/2K  ]
                      [      UNIX      ]
                               |
                               |
                        .---[fxp1]---.      Private IP, 192.168.1.1
                        |   FreeBSD  |
                        `---[fxp0]---'      Public IP, A.B.C.D
                               |
                               |
                      -=-=- Internet -=-=-
                               |
                               |
                        .---[fxp0]---.      Public IP, W.X.Y.Z
                        |   FreeBSD  |
                        `---[fxp1]---'      Private IP, 192.168.2.1
                               |
                               |
Network #2            [ Internal Hosts ]
                      [   Win9x/NT/2K  ]    Private Net, 192.168.2.2-254
                      [      UNIX      ]</literallayout>
	</textobject>
      </mediaobject>
 
      <para>Notice the two public IP addresses.  I will use the letters to
        refer to them in the rest of this article.  Anywhere you see those
        letters in this article, replace them with your own public IP
        addresses.  Note also that internally, the two gateway
        machines have .1 IP addresses, and that the two networks have
        different private IP addresses (<hostid
        role="ipaddr">192.168.1.x</hostid> and <hostid
        role="ipaddr">192.168.2.x</hostid> respectively).  All the
        machines on the private networks have been configured to use the
        <hostid role="ipaddr">.1</hostid> machine as their default
        gateway.</para>
 
      <para>The intention is that, from a network point of view, each
        network should view the machines on the other network as though
        they were directly attached the same router -- albeit a slightly
        slow router with an occasional tendency to drop packets.</para>
 
      <para>This means that (for example), machine <hostid
        role="ipaddr">192.168.1.20</hostid> should be able to run</para>
 
      <programlisting>ping 192.168.2.34</programlisting>
 
      <para>and have it work, transparently.  &windows; machines should
        be able to see the machines on the other network, browse file
        shares, and so on, in exactly the same way that they can browse
        machines on the local network.</para>
 
      <para>And the whole thing has to be secure.  This means that
        traffic between the two networks has to be encrypted.</para>
 
      <para>Creating a VPN between these two networks is a multi-step
        process.  The stages are as follows:</para>
 
      <orderedlist>
        <listitem>
          <para>Create a <quote>virtual</quote> network link between the two
            networks, across the Internet.  Test it, using tools like
            &man.ping.8;, to make sure it works.</para>
        </listitem>
 
        <listitem>
          <para>Apply security policies to ensure that traffic between
            the two networks is transparently encrypted and decrypted as
            necessary.  Test this, using tools like &man.tcpdump.1;, to
            ensure that traffic is encrypted.</para>
        </listitem>

        <listitem>
          <para>Configure additional software on the FreeBSD gateways,
            to allow &windows; machines to see one another across the
            VPN.</para>
        </listitem>
      </orderedlist>

    <sect3>
      <title>Step 1: Creating and testing a <quote>virtual</quote>
        network link</title>
 
      <para>Suppose that you were logged in to the gateway machine on
        network #1 (with public IP address <hostid
        role="ipaddr">A.B.C.D</hostid>, private IP address <hostid
        role="ipaddr">192.168.1.1</hostid>), and you ran <command>ping
        192.168.2.1</command>, which is the private address of the machine
        with IP address <hostid role="ipaddr">W.X.Y.Z</hostid>.  What
        needs to happen in order for this to work?</para>

      <orderedlist>
        <listitem>
          <para>The gateway machine needs to know how to reach <hostid
            role="ipaddr">192.168.2.1</hostid>.  In other words, it needs
            to have a route to <hostid
            role="ipaddr">192.168.2.1</hostid>.</para>
        </listitem>
        <listitem>
          <para>Private IP addresses, such as those in the <hostid
            role="ipaddr">192.168.x</hostid> range are not supposed to
            appear on the Internet at large.  Instead, each packet you
            send to <hostid role="ipaddr">192.168.2.1</hostid> will need
            to be wrapped up inside another packet.  This packet will need
            to appear to be from <hostid role="ipaddr">A.B.C.D</hostid>,
            and it will have to be sent to <hostid
            role="ipaddr">W.X.Y.Z</hostid>.  This process is called
            <firstterm>encapsulation</firstterm>.</para>
        </listitem>
        <listitem>
          <para>Once this packet arrives at <hostid
            role="ipaddr">W.X.Y.Z</hostid> it will need to
            <quote>unencapsulated</quote>, and delivered to <hostid
            role="ipaddr">192.168.2.1</hostid>.</para>
	</listitem>
      </orderedlist>
 
      <para>You can think of this as requiring a <quote>tunnel</quote>
        between the two networks.  The two <quote>tunnel mouths</quote> are the IP
        addresses <hostid role="ipaddr">A.B.C.D</hostid> and <hostid
        role="ipaddr">W.X.Y.Z</hostid>, and the tunnel must be told the
        addresses of the private IP addresses that will be allowed to pass
        through it.  The tunnel is used to transfer traffic with private
        IP addresses across the public Internet.</para>
 
      <para>This tunnel is created by using the generic interface, or
        <devicename>gif</devicename> devices on FreeBSD.  As you can
        imagine, the <devicename>gif</devicename> interface on each
        gateway host must be configured with four IP addresses; two for
        the public IP addresses, and two for the private IP
        addresses.</para>
 
      <para>Support for the gif device must be compiled in to the
        &os; kernel on both machines.  You can do this by adding the
        line:</para>
 
      <programlisting>device gif</programlisting>
 
      <para>to the kernel configuration files on both machines, and
        then compile, install, and reboot as normal.</para>
 
      <para>Configuring the tunnel is a two step process.  First the
        tunnel must be told what the outside (or public) IP addresses
        are, using &man.ifconfig.8;.  Then the private IP addresses must be
        configured using &man.ifconfig.8;.</para>
 
      <para>On the gateway machine on network #1 you would run the
        following two commands to configure the tunnel.</para>
 
      <programlisting>ifconfig gif0 A.B.C.D W.X.Y.Z
ifconfig gif0 inet 192.168.1.1 192.168.2.1 netmask 0xffffffff
      </programlisting>
 
      <para>On the other gateway machine you run the same commands,
        but with the order of the IP addresses reversed.</para>
 
      <programlisting>ifconfig gif0 W.X.Y.Z A.B.C.D
ifconfig gif0 inet 192.168.2.1 192.168.1.1 netmask 0xffffffff
      </programlisting>
 
      <para>You can then run:</para>
 
      <programlisting>ifconfig gif0</programlisting>
 
      <para>to see the configuration.  For example, on the network #1
        gateway, you would see this:</para>
 
      <screen>&prompt.root; <userinput>ifconfig gif0</userinput>
gif0: flags=8011&lt;UP,POINTTOPOINT,MULTICAST&gt; mtu 1280
inet 192.168.1.1 --&gt; 192.168.2.1 netmask 0xffffffff
physical address inet A.B.C.D --&gt; W.X.Y.Z
      </screen>
 
      <para>As you can see, a tunnel has been created between the
        physical addresses <hostid role="ipaddr">A.B.C.D</hostid> and
        <hostid role="ipaddr">W.X.Y.Z</hostid>, and the traffic allowed
        through the tunnel is that between <hostid
        role="ipaddr">192.168.1.1</hostid> and <hostid
        role="ipaddr">192.168.2.1</hostid>.</para>
 
      <para>This will also have added an entry to the routing table
        on both machines, which you can examine with the command <command>netstat -rn</command>.
        This output is from the gateway host on network #1.</para>
 
      <screen>&prompt.root; <userinput>netstat -rn</userinput>
Routing tables
 
Internet:
Destination      Gateway       Flags    Refs    Use    Netif  Expire
...
192.168.2.1      192.168.1.1   UH        0        0    gif0
...
      </screen>
 
      <para>As the <quote>Flags</quote> value indicates, this is a
        host route, which means that each gateway knows how to reach the
        other gateway, but they do not know how to reach the rest of
        their respective networks.  That problem will be fixed
        shortly.</para>
 
      <para>It is likely that you are running a firewall on both
        machines.  This will need to be circumvented for your VPN
        traffic.  You might want to allow all traffic between both
        networks, or you might want to include firewall rules that
        protect both ends of the VPN from one another.</para>
 
      <para>It greatly simplifies testing if you configure the
        firewall to allow all traffic through the VPN.  You can always
        tighten things up later.  If you are using &man.ipfw.8; on the
        gateway machines then a command like</para>

      <programlisting>ipfw add 1 allow ip from any to any via gif0</programlisting>
 
      <para>will allow all traffic between the two end points of the
        VPN, without affecting your other firewall rules.  Obviously
        you will need to run this command on both gateway hosts.</para>
 
      <para>This is sufficient to allow each gateway machine to ping
        the other.  On <hostid role="ipaddr">192.168.1.1</hostid>, you
        should be able to run</para>
 
      <programlisting>ping 192.168.2.1</programlisting>
 
      <para>and get a response, and you should be able to do the same
        thing on the other gateway machine.</para>
 
      <para>However, you will not be able to reach internal machines
        on either network yet.  This is because of the routing --
        although the gateway machines know how to reach one another,
        they do not know how to reach the network behind each one.</para>
 
      <para>To solve this problem you must add a static route on each
        gateway machine.  The command to do this on the first gateway
        would be:</para>
 
      <programlisting>route add 192.168.2.0 192.168.2.1 netmask 0xffffff00
      </programlisting>
 
      <para>This says <quote>In order to reach the hosts on the
        network <hostid role="ipaddr">192.168.2.0</hostid>, send the
        packets to the host <hostid
        role="ipaddr">192.168.2.1</hostid></quote>.  You will need to
        run a similar command on the other gateway, but with the
        <hostid role="ipaddr">192.168.1.x</hostid> addresses
        instead.</para>
 
      <para>IP traffic from hosts on one network will now be able to
        reach hosts on the other network.</para>
 
      <para>That has now created two thirds of a VPN between the two
        networks, in as much as it is <quote>virtual</quote> and it is a
        <quote>network</quote>.  It is not private yet.  You can test
        this using &man.ping.8; and &man.tcpdump.1;.  Log in to the
        gateway host and run</para>
 
      <programlisting>tcpdump dst host 192.168.2.1</programlisting>

      <para>In another log in session on the same host run</para>

      <programlisting>ping 192.168.2.1</programlisting>
 
      <para>You will see output that looks something like this:</para>
 
      <programlisting>
16:10:24.018080 192.168.1.1 &gt; 192.168.2.1: icmp: echo request
16:10:24.018109 192.168.1.1 &gt; 192.168.2.1: icmp: echo reply
16:10:25.018814 192.168.1.1 &gt; 192.168.2.1: icmp: echo request
16:10:25.018847 192.168.1.1 &gt; 192.168.2.1: icmp: echo reply
16:10:26.028896 192.168.1.1 &gt; 192.168.2.1: icmp: echo request
16:10:26.029112 192.168.1.1 &gt; 192.168.2.1: icmp: echo reply
      </programlisting>
 
      <para>As you can see, the ICMP messages are going back and forth
        unencrypted.  If you had used the <option>-s</option> parameter to
        &man.tcpdump.1; to grab more bytes of data from the packets you
        would see more information.</para>
 
      <para>Obviously this is unacceptable.  The next section will
        discuss securing the link between the two networks so that it
        all traffic is automatically encrypted.</para>
 
      <itemizedlist>
        <title>Summary:</title>
        <listitem>
          <para>Configure both kernels with <quote>device gif</quote>.</para>
        </listitem>
        <listitem>
          <para>Edit <filename>/etc/rc.conf</filename> on gateway host
            #1 and add the following lines (replacing IP addresses as
            necessary).</para>
          <programlisting>gifconfig_gif0="A.B.C.D W.X.Y.Z"
ifconfig_gif0="inet 192.168.1.1 192.168.2.1 netmask 0xffffffff"
static_routes="vpn"
route_vpn="192.168.2.0 192.168.2.1 netmask 0xffffff00"
          </programlisting>
        </listitem>

        <listitem>
          <para>Edit your firewall script
          (<filename>/etc/rc.firewall</filename>, or similar) on both
          hosts, and add</para>

          <programlisting>ipfw add 1 allow ip from any to any via gif0</programlisting>
        </listitem>
        <listitem>
          <para>Make similar changes to
            <filename>/etc/rc.conf</filename> on gateway host #2,
            reversing the order of IP addresses.</para>
        </listitem>
      </itemizedlist>
    </sect3>

    <sect3>
      <title>Step 2: Securing the link</title>
 
      <para>To secure the link we will be using IPsec.  IPsec provides
        a mechanism for two hosts to agree on an encryption key, and to
        then use this key in order to encrypt data between the two
        hosts.</para>
 
      <para>The are two areas of configuration to be considered here.</para>
 
      <orderedlist>
        <listitem>
          <para>There must be a mechanism for two hosts to agree on the
            encryption mechanism to use.  Once two hosts have agreed on
            this mechanism there is said to be a <quote>security association</quote>
            between them.</para>
        </listitem>
        <listitem>
          <para>There must be a mechanism for specifying which traffic
            should be encrypted.  Obviously, you do not want to encrypt
            all your outgoing traffic -- you only want to encrypt the
            traffic that is part of the VPN.  The rules that you put in
            place to determine what traffic will be encrypted are called
            <quote>security policies</quote>.</para>
         </listitem>
       </orderedlist>
 
       <para>Security associations and security policies are both
         maintained by the kernel, and can be modified by userland
         programs.  However, before you can do this you must configure the
         kernel to support IPsec and the Encapsulated Security Payload
         (ESP) protocol.  This is done by configuring a kernel with:</para>
 
       <indexterm>
	 <primary>kernel options</primary>
	 <secondary>IPSEC</secondary>
       </indexterm>

       <programlisting>options IPSEC
options IPSEC_ESP
       </programlisting>
 
       <para>and recompiling, reinstalling, and rebooting.  As before
         you will need to do this to the kernels on both of the gateway
         hosts.</para>
 
       <indexterm>
	 <primary>IKE</primary>
       </indexterm>

       <para>You have two choices when it comes to setting up security
         associations.  You can configure them by hand between two hosts,
         which entails choosing the encryption algorithm, encryption keys,
         and so forth, or you can use daemons that implement the Internet
         Key Exchange protocol (IKE) to do this for you.</para>
 
       <para>I recommend the latter.  Apart from anything else, it is
         easier to set up.</para>
 
       <indexterm>
	 <primary>IPsec</primary>
	 <secondary>security policies</secondary>
       </indexterm>

       <indexterm>
	 <primary><command>setkey</command></primary>
       </indexterm>

       <para>Editing and displaying security policies is carried out
         using &man.setkey.8;.  By analogy, <command>setkey</command> is
         to the kernel's security policy tables as &man.route.8; is to
         the kernel's routing tables.  <command>setkey</command> can
         also display the current security associations, and to continue
         the analogy further, is akin to <command>netstat -r</command>
         in that respect.</para>
 
       <para>There are a number of choices for daemons to manage
         security associations with FreeBSD.  This article will describe
         how to use one of these, racoon&nbsp;&mdash; which is available from
	 <filename role="package">security/ipsec-tools</filename> in the &os; Ports
	 collection.</para>
 
       <indexterm>
	 <primary>racoon</primary>
       </indexterm>

       <para>The <application>racoon</application> software must be run on both gateway hosts.  On each host it
         is configured with the IP address of the other end of the VPN,
         and a secret key (which you choose, and must be the same on both
         gateways).</para>
 
       <para>The two daemons then contact one another, confirm that they
         are who they say they are (by using the secret key that you
         configured).  The daemons then generate a new secret key, and use
         this to encrypt the traffic over the VPN.  They periodically
         change this secret, so that even if an attacker were to crack one
         of the keys (which is as theoretically close to unfeasible as it
         gets) it will not do them much good -- by the time they have cracked
         the key the two daemons have chosen another one.</para>
 
       <para>The configuration file for racoon is stored in
         <filename>${PREFIX}/etc/racoon</filename>.  You should find a
         configuration file there, which should not need to be changed
         too much.  The other component of racoon's configuration,
         which you will need to change, is the <quote>pre-shared
         key</quote>.</para>
 
       <para>The default racoon configuration expects to find this in
         the file <filename>${PREFIX}/etc/racoon/psk.txt</filename>.  It is important to note
         that the pre-shared key is <emphasis>not</emphasis> the key that will be used to
         encrypt your traffic across the VPN link, it is simply a token
         that allows the key management daemons to trust one another.</para>

       <para><filename>psk.txt</filename> contains a line for each
         remote site you are dealing with.  In this example, where there
         are two sites, each <filename>psk.txt</filename> file will contain one line (because
         each end of the VPN is only dealing with one other end).</para>
 
       <para>On gateway host #1 this line should look like this:</para>
 
       <programlisting>W.X.Y.Z            secret</programlisting>
 
       <para>That is, the <emphasis>public</emphasis> IP address of the remote end,
         whitespace, and a text string that provides the secret.
         Obviously, you should not use <quote>secret</quote> as your key -- the normal
         rules for choosing a password apply.</para>
 
       <para>On gateway host #2 the line would look like this</para>
 
       <programlisting>A.B.C.D            secret</programlisting>
 
       <para>That is, the public IP address of the remote end, and the
         same secret key.  <filename>psk.txt</filename> must be mode
         <literal>0600</literal> (i.e., only read/write to
         <username>root</username>) before racoon will run.</para>
 
       <para>You must run racoon on both gateway machines.  You will
         also need to add some firewall rules to allow the IKE traffic,
         which is carried over UDP to the ISAKMP (Internet Security Association
         Key Management Protocol) port.  Again, this should be fairly early in
         your firewall ruleset.</para>
 
       <programlisting>ipfw add 1 allow udp from A.B.C.D to W.X.Y.Z isakmp
ipfw add 1 allow udp from W.X.Y.Z to A.B.C.D isakmp
       </programlisting>
 
       <para>Once racoon is running you can try pinging one gateway host
         from the other.  The connection is still not encrypted, but
         racoon will then set up the security associations between the two
         hosts -- this might take a moment, and you may see this as a
         short delay before the ping commands start responding.</para>
 
       <para>Once the security association has been set up you can
         view it using &man.setkey.8;.  Run</para>
 
       <programlisting>setkey -D</programlisting>
 
       <para>on either host to view the security association information.</para>
 
       <para>That's one half of the problem.  They other half is setting
         your security policies.</para>
 
       <para>To create a sensible security policy, let's review what's
         been set up so far.  This discussions hold for both ends of the
         link.</para>
 
       <para>Each IP packet that you send out has a header that contains
         data about the packet.  The header includes the IP addresses of
         both the source and destination.  As we already know, private IP
         addresses, such as the <hostid role="ipaddr">192.168.x.y</hostid>
         range are not supposed to appear on the public Internet.
         Instead, they must first be encapsulated inside another packet.
         This packet must have the public source and destination IP
         addresses substituted for the private addresses.</para>
 
       <para>So if your outgoing packet started looking like this:</para>
 
	<mediaobject>
	  <imageobject>
	    <imagedata fileref="security/ipsec-out-pkt" align="center">
	  </imageobject>

	  <textobject>
	    <literallayout class="monospaced">
  .----------------------.
  | Src: 192.168.1.1     |
  | Dst: 192.168.2.1     |
  | &lt;other header info&gt;  |
  +----------------------+
  | &lt;packet data&gt;        |
  `----------------------'</literallayout>
	  </textobject>
	</mediaobject>
 
       <para>Then it will be encapsulated inside another packet, looking
         something like this:</para>
 
	<mediaobject>
	  <imageobject>
	    <imagedata fileref="security/ipsec-encap-pkt" align="center">
	  </imageobject>

	  <textobject>
	    <literallayout class="monospaced">
  .--------------------------.
  | Src: A.B.C.D             |
  | Dst: W.X.Y.Z             |
  | &lt;other header info&gt;      |
  +--------------------------+
  | .----------------------. |
  | | Src: 192.168.1.1     | |
  | | Dst: 192.168.2.1     | |
  | | &lt;other header info&gt;  | |
  | +----------------------+ |
  | | &lt;packet data&gt;        | |
  | `----------------------' |
  `--------------------------'</literallayout>
	  </textobject>
	</mediaobject>
 
       <para>This encapsulation is carried out by the
         <devicename>gif</devicename> device.  As
         you can see, the packet now has real IP addresses on the outside,
         and our original packet has been wrapped up as data inside the
         packet that will be put out on the Internet.</para>
 
       <para>Obviously, we want all traffic between the VPNs to be
         encrypted.  You might try putting this in to words, as:</para>

       <para><quote>If a packet leaves from <hostid
         role="ipaddr">A.B.C.D</hostid>, and it is destined for <hostid
         role="ipaddr">W.X.Y.Z</hostid>, then encrypt it, using the
         necessary security associations.</quote></para>
 
       <para><quote>If a packet arrives from <hostid
         role="ipaddr">W.X.Y.Z</hostid>, and it is destined for <hostid
         role="ipaddr">A.B.C.D</hostid>, then decrypt it, using the
         necessary security associations.</quote></para>
 
       <para>That's close, but not quite right.  If you did this, all
         traffic to and from <hostid role="ipaddr">W.X.Y.Z</hostid>, even
         traffic that was not part of the VPN, would be encrypted.  That's
         not quite what you want.  The correct policy is as follows</para>
 
       <para><quote>If a packet leaves from <hostid
         role="ipaddr">A.B.C.D</hostid>, and that packet is encapsulating
         another packet, and it is destined for <hostid
         role="ipaddr">W.X.Y.Z</hostid>, then encrypt it, using the
         necessary security associations.</quote></para>
 
       <para><quote>If a packet arrives from <hostid
         role="ipaddr">W.X.Y.Z</hostid>, and that packet is encapsulating
         another packet, and it is destined for <hostid
         role="ipaddr">A.B.C.D</hostid>, then decrypt it, using the
         necessary security associations.</quote></para>
 
       <para>A subtle change, but a necessary one.</para>
 
       <para>Security policies are also set using &man.setkey.8;.
         &man.setkey.8; features a configuration language for defining the
         policy.  You can either enter configuration instructions via
         stdin, or you can use the <option>-f</option> option to specify a
         filename that contains configuration instructions.</para>
 
       <para>The configuration on gateway host #1 (which has the public
         IP address <hostid role="ipaddr">A.B.C.D</hostid>) to force all
         outbound traffic to <hostid role="ipaddr">W.X.Y.Z</hostid> to be
         encrypted is:</para>
 
       <programlisting>
spdadd A.B.C.D/32 W.X.Y.Z/32 ipencap -P out ipsec esp/tunnel/A.B.C.D-W.X.Y.Z/require;
       </programlisting>
 
       <para>Put these commands in a file (e.g.
       <filename>/etc/ipsec.conf</filename>) and then run</para>

       <screen>&prompt.root; <userinput>setkey -f /etc/ipsec.conf</userinput></screen>
 
       <para><option>spdadd</option> tells &man.setkey.8; that we want
         to add a rule to the secure policy database.  The rest of this
         line specifies which packets will match this policy.  <hostid
         role="ipaddr">A.B.C.D/32</hostid> and <hostid
         role="ipaddr">W.X.Y.Z/32</hostid> are the IP addresses and
         netmasks that identify the network or hosts that this policy will
         apply to.  In this case, we want it to apply to traffic between
         these two hosts.  <option>ipencap</option> tells the kernel that
         this policy should only apply to packets that encapsulate other
         packets.  <option>-P out</option> says that this policy applies
         to outgoing packets, and <option>ipsec</option> says that the
         packet will be secured.</para>
 
       <para>The second line specifies how this packet will be
         encrypted.  <option>esp</option> is the protocol that will be
         used, while <option>tunnel</option> indicates that the packet
         will be further encapsulated in an IPsec packet.  The repeated
         use of <hostid role="ipaddr">A.B.C.D</hostid> and <hostid
         role="ipaddr">W.X.Y.Z</hostid> is used to select the security
         association to use, and the final <option>require</option>
         mandates that packets must be encrypted if they match this
         rule.</para>
 
       <para>This rule only matches outgoing packets.  You will need a
         similar rule to match incoming packets.</para>
 
       <programlisting>spdadd W.X.Y.Z/32 A.B.C.D/32 ipencap -P in ipsec esp/tunnel/W.X.Y.Z-A.B.C.D/require;</programlisting>
 
       <para>Note the <option>in</option> instead of
         <option>out</option> in this case, and the necessary reversal of
         the IP addresses.</para>
 
       <para>The other gateway host (which has the public IP address
         <hostid role="ipaddr">W.X.Y.Z</hostid>) will need similar rules.</para>
 
       <programlisting>spdadd W.X.Y.Z/32 A.B.C.D/32 ipencap -P out ipsec esp/tunnel/W.X.Y.Z-A.B.C.D/require;
spdadd A.B.C.D/32 W.X.Y.Z/32 ipencap -P in ipsec esp/tunnel/A.B.C.D-W.X.Y.Z/require;</programlisting>
 
       <para>Finally, you need to add firewall rules to allow ESP and
        IPENCAP packets back and forth.  These rules will need to be
        added to both hosts.</para>
 
       <programlisting>ipfw add 1 allow esp from A.B.C.D to W.X.Y.Z
ipfw add 1 allow esp from W.X.Y.Z to A.B.C.D
ipfw add 1 allow ipencap from A.B.C.D to W.X.Y.Z
ipfw add 1 allow ipencap from W.X.Y.Z to A.B.C.D
       </programlisting>
 
       <para>Because the rules are symmetric you can use the same rules
         on each gateway host.</para>
 
       <para>Outgoing packets will now look something like this:</para>
 
	<mediaobject>
	  <imageobject>
	    <imagedata fileref="security/ipsec-crypt-pkt" align="center">
	  </imageobject>

	  <textobject>
	    <literallayout class="monospaced">
  .------------------------------.  --------------------------.
  | Src: A.B.C.D                 |                            |
  | Dst: W.X.Y.Z                 |                            |
  | &lt;other header info&gt;          |                            |  Encrypted
  +------------------------------+                            |  packet.
  | .--------------------------. |  -------------.            |  contents
  | | Src: A.B.C.D             | |               |            |  are
  | | Dst: W.X.Y.Z             | |               |            |  completely
  | | &lt;other header info&gt;      | |               |            |- secure
  | +--------------------------+ |               |  Encap'd   |  from third
  | | .----------------------. | |  -.           |  packet    |  party
  | | | Src: 192.168.1.1     | | |   |  Original |- with real |  snooping
  | | | Dst: 192.168.2.1     | | |   |  packet,  |  IP addr   |
  | | | &lt;other header info&gt;  | | |   |- private  |            |
  | | +----------------------+ | |   |  IP addr  |            |
  | | | &lt;packet data&gt;        | | |   |           |            |
  | | `----------------------' | |  -'           |            |
  | `--------------------------' |  -------------'            |
  `------------------------------'  --------------------------'
	    </literallayout>
	  </textobject>
	</mediaobject>

       <para>When they are received by the far end of the VPN they will
         first be decrypted (using the security associations that have
         been negotiated by racoon).  Then they will enter the
         <devicename>gif</devicename> interface, which will unwrap
         the second layer, until you are left with the innermost
         packet, which can then travel in to the inner network.</para>
 
       <para>You can check the security using the same &man.ping.8; test from
         earlier.  First, log in to the
         <hostid role="ipaddr">A.B.C.D</hostid> gateway machine, and
         run:</para>
 
       <programlisting>tcpdump dst host 192.168.2.1</programlisting>
 
       <para>In another log in session on the same host run</para>
 
       <programlisting>ping 192.168.2.1</programlisting>
 
       <para>This time you should see output like the following:</para>
 
       <programlisting>XXX tcpdump output</programlisting>
 
       <para>Now, as you can see, &man.tcpdump.1; shows the ESP packets.  If
         you try to examine them with the <option>-s</option> option you will see
         (apparently) gibberish, because of the encryption.</para>
 
      <para>Congratulations.  You have just set up a VPN between two
        remote sites.</para>
 
      <itemizedlist>
        <title>Summary</title>
        <listitem>
          <para>Configure both kernels with:</para>
 
          <programlisting>options IPSEC
options IPSEC_ESP
          </programlisting>
        </listitem>
        <listitem>
          <para>Install <filename
            role="package">security/ipsec-tools</filename>.  Edit
            <filename>${PREFIX}/etc/racoon/psk.txt</filename> on both
            gateway hosts, adding an entry for the remote host's IP
            address and a secret key that they both know.  Make sure
            this file is mode 0600.</para>
        </listitem>
        <listitem>
          <para>Add the following lines to
            <filename>/etc/rc.conf</filename> on each host:</para>
 
          <programlisting>ipsec_enable="YES"
ipsec_file="/etc/ipsec.conf"
          </programlisting>
        </listitem>
        <listitem>
          <para>Create an <filename>/etc/ipsec.conf</filename> on each
            host that contains the necessary spdadd lines.  On gateway
            host #1 this would be:</para>
 
          <programlisting>
spdadd A.B.C.D/32 W.X.Y.Z/32 ipencap -P out ipsec
  esp/tunnel/A.B.C.D-W.X.Y.Z/require;
spdadd W.X.Y.Z/32 A.B.C.D/32 ipencap -P in ipsec
  esp/tunnel/W.X.Y.Z-A.B.C.D/require;
</programlisting>
 
          <para>On gateway host #2 this would be:</para>
 
<programlisting>
spdadd W.X.Y.Z/32 A.B.C.D/32 ipencap -P out ipsec
  esp/tunnel/W.X.Y.Z-A.B.C.D/require;
spdadd A.B.C.D/32 W.X.Y.Z/32 ipencap -P in ipsec
  esp/tunnel/A.B.C.D-W.X.Y.Z/require;
</programlisting>
        </listitem>
        <listitem>
          <para>Add firewall rules to allow IKE, ESP, and IPENCAP
            traffic to both hosts:</para>
 
          <programlisting>
ipfw add 1 allow udp from A.B.C.D to W.X.Y.Z isakmp
ipfw add 1 allow udp from W.X.Y.Z to A.B.C.D isakmp
ipfw add 1 allow esp from A.B.C.D to W.X.Y.Z
ipfw add 1 allow esp from W.X.Y.Z to A.B.C.D
ipfw add 1 allow ipencap from A.B.C.D to W.X.Y.Z
ipfw add 1 allow ipencap from W.X.Y.Z to A.B.C.D
          </programlisting>
        </listitem>
      </itemizedlist>

      <para>The previous two steps should suffice to get the VPN up and
        running.  Machines on each network will be able to refer to one
        another using IP addresses, and all traffic across the link will
        be automatically and securely encrypted.</para>
    </sect3> 
    </sect2> 
  </sect1>

  <sect1 id="openssh">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Chern</firstname>
	  <surname>Lee</surname>
	  <contrib>Napisa³ </contrib>
	</author>
	<!-- 21 April 2001 -->
      </authorgroup>
    </sect1info>

    <title>OpenSSH</title>
    <indexterm><primary>OpenSSH</primary></indexterm>
    <indexterm>
      <primary>bezpieczeñstwo</primary>
      <secondary>OpenSSH</secondary>
    </indexterm>

    <para><application>OpenSSH</application> to zestaw narzêdzi sieciowych u¿ywanych do pracy
      ze zdalnymi maszynami w sposób bezpieczny.  Mo¿na je traktowaæ jako zastêpstwo dla
      <command>rlogin</command>, <command>rsh</command>, <command>rcp</command>
      i <command>telnet</command>.  Jako dodatkow± zaletê wymieniæ nale¿y fakt, ¿e potrafi±
      one równie¿ tunelowaæ inne po³±czenia TCP/IP przez SSH.  Po³±czenia <application>OpenSSH</application>
      s± szyfrowane, co powinno zabezpieczyæ transmitowane dane przed pods³uchaniem,
      przejêciem sesji i innymi atakami na poziomie sieci.</para>

    <para><application>OpenSSH</application> utrzymywany jest przez projekt OpenBSD i bazuje
      na wersji SSH 1.2.12 ze wszystkimi dostêpnymi poprawkami b³êdów i uaktualnieniami.  Narzêdzie
      to jest zgodne zarówno z wersj± 1 jak i 2 protoko³u SSH.</para>

    <sect2>
      <title>Zalety stosowania OpenSSH</title>
  
      <para>W przypadku stosowania &man.telnet.1; czy &man.rlogin.1;, dane przesy³ane s± przez
        sieæ w czystej, niezaszyfrowanej postaci.  Umo¿liwia to pods³uchanie sesji w dowolnym
        miejscu pomiêdzy nadaj±cym a odbieraj±cym i wy³uskanie informacji o wykorzystywanych
        identyfikatorach i has³ach.  <application>OpenSSH</application> oferuje ca³y zestaw
        uwierzytelniania i szyfrowania by zapobiec takiemu obrotowi spraw.</para>
    </sect2>

    <sect2>
      <title>Aktywacja sshd</title>
      <indexterm>
        <primary>OpenSSH</primary>
        <secondary>aktywacja</secondary>
      </indexterm>

      <para>W trakcie instalacji &os; w trybie <literal>Standard</literal> dostêpna
        jest opcja <application>sshd</application>, która aktywuje demona SSH.  By upewniæ siê,
        ¿e opcja ta jest aktywna nale¿y odnale¼æ w pliku <filename>rc.conf</filename> wpis
        postaci:</para>
      <screen>sshd_enable="YES"</screen>
      <para>Spowoduje to za³adowanie demona &man.sshd.8; przy nastêpnym uruchomieniu systemu.
        Mo¿emy równie¿ uruchomiæ go od razu, uruchamiaj±c skrypt &man.rc.8;
        <filename>/etc/rc.d/sshd</filename>:</para>

      <programlisting>/etc/rc.d/sshd start</programlisting>
    </sect2>

    <sect2>
      <title>Klient SSH</title>
      <indexterm>
        <primary>OpenSSH</primary>
        <secondary>klient</secondary>
      </indexterm>

      <para>Narzêdzie &man.ssh.1; dzia³a podobnie do &man.rlogin.1;.</para>

      <screen>&prompt.root; <userinput>ssh <replaceable>user@example.com</replaceable></userinput>
Host key not found from the list of known hosts.
Are you sure you want to continue connecting (yes/no)? <userinput>yes</userinput>
Host 'example.com' added to the list of known hosts.
user@example.com's password: <userinput>*******</userinput></screen>

      <para>Logowanie bêdzie kontynuowane tak jakby¶my nawi±zali po³±czenie poleceniem
        <command>rlogin</command> lub <command>telnet</command>.  SSH stosuje elektroniczny
        odcisk klucza w celu weryfikacji serwera podczas po³±czenia.  U¿ytkownik proszony jest
        o zaakceptowanie takiego a nie innego odcisku tylko za pierwszym razem - nale¿y wpisaæ
        <literal>yes</literal>. W przypadku kolejnych po³±czeñ, klient weryfikuje otrzymany
        odcisk do zapisanego i powiadomi o ewentualnej ró¿nicy.  Elektroniczne odciski kluczy
        serwerów przechowywane s± w pliku <filename>~/.ssh/known_hosts</filename>, lub dla
        SSH v2 w pliku <filename>~/.ssh/known_hosts2</filename>.</para>

      <para>Domy¶lnie, nowsze wersje serwerów <application>OpenSSH</application> akceptuj±
        jedynie po³±czenia SSH v2.  Klienci wykorzystuj± wersjê 2, a je¶li nie bêdzie to mo¿liwe
        dopiero wersjê 1.  Mo¿na równie¿ wymusiæ wykorzystanie wybranej wersji poprzez opcjê <option>-1</option>
        lub <option>-2</option>, dla odpowiednio wersji 1 lub 2.  Wersja 1 dostêpna jest w klientach
        ze wzglêdów na zgodno¶æ ze starszymi serwerami.</para>
    </sect2>
    
    <sect2>
      <title>Bezpieczne kopiowanie</title>
      <indexterm>
        <primary>OpenSSH</primary>
        <secondary>bezpieczne kopiowanie</secondary>
      </indexterm>
      <indexterm><primary><command>scp</command></primary></indexterm>

      <para>Polecenie &man.scp.1; dzia³a podobnie do &man.rcp.1;; kopiuje pliki do lub ze
        zdalnej maszyny, ale robi to w sposób bezpieczny.</para>

      <screen>&prompt.root; <userinput> scp <replaceable>user@example.com:/COPYRIGHT COPYRIGHT</replaceable></userinput>
user@example.com's password: <userinput>*******</userinput>
COPYRIGHT            100% |*****************************|  4735       
00:00    
&prompt.root;</screen>
      <para>Poniewa¿ dla tego komputera zapisali¶my ju¿ elektroniczny odcisk klucza,
        zostaje on sprawdzony podczas po³±czenia za pomoc± narzêdzia &man.scp.1;.</para>

      <para>Argumenty przekazywane programowi &man.scp.1; s± podobne do tych znanych
        z programu &man.cp.1; - plik lub pliki do skopiowania na pocz±tku, po nich miejsce
        docelowe.  Poniewa¿ plik przesy³any jest przez sieæ (przez SSH), nale¿y u¿yæ zapisu
        w postaci <option>user@host:&lt;¶cie¿ka_do_zdalnego_pliku&gt;</option>.</para>

    </sect2>

    <sect2>
      <title>Konfiguracja</title>
      <indexterm>
        <primary>OpenSSH</primary>
        <secondary>konfiguracja</secondary>
      </indexterm>

      <para>Konfiguracja globalna dla systemu, zarówno dla klienta jak i demona
        <application>OpenSSH</application> znajduje siê w katalogu <filename>/etc/ssh</filename>.</para>

      <para>Plik <filename>ssh_config</filename> zawiera opcje konfiguracji klienta,
        podczas gdy <filename>sshd_config</filename> serwera.</para>

      <para>Dodatkowo w pliku <filename>rc.conf</filename> mo¿na wskazaæ alternatywn±
        lokalizacjê zarówno serwera SSH (domy¶lnie <filename>/usr/sbin/sshd</filename>)
        - opcj± <option>sshd_program</option>, oraz opcje przekazywane mu podczas startu
        - opcj± <option>sshd_flags</option>.</para>
    </sect2>

    <sect2 id="security-ssh-keygen">
      <title>ssh-keygen</title>

      <para>Zamiast stosowaæ has³a, mo¿emy wykorzystaæ program &man.ssh-keygen.1; do wygenerowania
        kluczy DSA lub RSA i u¿ywaæ ich do uwierzytelnienia procesu logowania:</para>

      <screen>&prompt.user; <userinput>ssh-keygen -t <replaceable>dsa</replaceable></userinput>
Generating public/private dsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_dsa):
Created directory '/home/user/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/user/.ssh/id_dsa.
Your public key has been saved in /home/user/.ssh/id_dsa.pub.
The key fingerprint is:
bb:48:db:f2:93:57:80:b6:aa:bc:f5:d5:ba:8f:79:17 user@host.example.com
</screen>

      <para>&man.ssh-keygen.1; tworzy parê kluczy: prywatny i publiczny.  Klucz prywatny
        przechowywany jest w pliku <filename>~/.ssh/id_dsa</filename> b±d¼
        <filename>~/.ssh/id_rsa</filename>, natomiast publiczny w <filename>~/.ssh/id_dsa.pub</filename>
        b±d¼ <filename>~/.ssh/id_rsa.pub</filename>, odpowiednio dla kluczy DSA i RSA.  Klucz
        publiczny nale¿y dodatkowo dopisaæ do pliku <filename>~/.ssh/authorized_keys</filename>
        na zdalnej maszynie tak, by mo¿na by³o wykorzystaæ uwierzytelnianie za pomoc± kluczy.
        Analogicznie, równie¿ klucz publiczny RSA wersji 1 powinien zostaæ umieszczony w pliku
        <filename>~/.ssh/authorized_keys</filename>.</para>

      <para>Pozwoli to na po³±czenia do zdalnej maszyny na podstawie kluczy SSH, w miejsce
        hase³.</para>

      <para>Je¶li dodatkowo skorzystamy z opcji &man.ssh-keygen.1; zabezpieczenia kluczy has³em,
        bêdziemy o nie pytani przy ka¿dym u¿yciu klucza prywatnego.  Rozwi±zaniem problemu ci±g³ego
        wpisywania d³ugiego has³a jest &man.ssh-agent.1;, którego u¿ycie przybli¿a
        <xref linkend="security-ssh-agent"> poni¿ej.</para>

      <warning><para>Niektóre opcje czy nazwy plików mog± ró¿ne od tutaj przedstawionych,
        zale¿nie od wersji <application>OpenSSH</application> zainstalowanej w naszym systemie.
        By unikn±æ wynikaj±cych z tego tytu³u problemów, powinni¶my zapoznaæ siê z podrêcznikiem
        systemowym &man.ssh-keygen.1;.</para></warning>
    </sect2>

    <sect2 id="security-ssh-agent">
      <title>ssh-agent i ssh-add</title>

      <para>Programy &man.ssh-agent.1; i &man.ssh-add.1; pozwalaj± wczytaæ
        do pamiêci klucze <application>SSH</application>, aby móc pó¼niej korzystaæ
        z nich bez konieczno¶ci wpisywania za ka¿dym razem has³a.</para>

      <para>Program &man.ssh-agent.1; zajmuje siê uwierzytelnianiem u¿ytkownika za pomoc±
        wczytanych kluczy prywatnych.  Wykorzystywany jest on do uruchamiania
        innych aplikacji.  Na najni¿szym poziomie, uruchamia interpreter pow³oki,
        b±d¼ na wy¿szym - mened¿er okien.</para>

      <para>By wykorzystaæ &man.ssh-agent.1; w pow³oce systemowej, musi byæ on wpierw
        uruchomiony z nazw± pow³oki jako parametrem. Nastêpnie nale¿y dodaæ to¿samo¶æ,
        uruchamiaj±c program &man.ssh-add.1; i podaj±c has³o klucza prywatnego.
        Po czym bêdziemy mogli po³±czyæ siê za pomoc± &man.ssh.1; do dowolnej maszyny
        z zainstalowanym w³a¶ciwym kluczem publicznym.  Na przyk³ad:</para>

      <screen>&prompt.user; ssh-agent <replaceable>csh</replaceable>
&prompt.user; ssh-add
Enter passphrase for /home/user/.ssh/id_dsa:
Identity added: /home/user/.ssh/id_dsa (/home/user/.ssh/id_dsa)
&prompt.user;</screen>

      <para>By wykorzystaæ &man.ssh-agent.1; w X11, powinni¶my umie¶ciæ odwo³anie
        &man.ssh-agent.1; w pliku <filename>~/.xinitrc</filename>.  Udostêpni do
        funkcje programu &man.ssh-agent.1; wszystkim aplikacjom uruchamianym w X11.
        Przyk³adowy plik <filename>~/.xinitrc</filename> móg³by wygl±daæ
        nastêpuj±co:</para>

      <programlisting>exec ssh-agent <replaceable>startxfce4</replaceable></programlisting>

      <para>Spowodowa³oby to uruchomienie &man.ssh-agent.1; przy ka¿dym starcie X11,
        który z kolei uruchamia³by <application>XFCE</application>.  Po ponownym uruchomieniu
        X11, w celu uwzglêdnienia dokonanych zmian konfiguracji, wystarczy uruchomiæ
        &man.ssh-add.1;, by wczytaæ wszystkie nasze klucze SSH.</para>
    </sect2>

    <sect2 id="security-ssh-tunneling">
      <title>Tunelowanie SSH</title>
      <indexterm>
        <primary>OpenSSH</primary>
        <secondary>tunelowanie</secondary>
      </indexterm>

      <para><application>OpenSSH</application> umo¿liwia tworzenie tunelu, hermetyzuj±cego
        inny protokó³ w zaszyfrowanej sesji.</para>

      <para>Poni¿sze polecenie tworzy tunel &man.ssh.1; dla programu
        <application>telnet</application>:</para>

       <screen>&prompt.user; <userinput>ssh -2 -N -f -L <replaceable>5023:localhost:23 u¿ytkownik@foo.example.com</replaceable></userinput>
&prompt.user;</screen>

      <para>Polecenie <command>ssh</command> mo¿e przyj±æ nastêpuj±ce opcje:</para>

      <variablelist>
	<varlistentry>
	  <term><option>-2</option></term>
	  
	  <listitem>
	    <para>Wymusza u¿ycie wersji drugiej protoko³u <command>ssh</command>
              (nie nale¿y u¿ywaæ, je¶li ³±czymy siê ze starszymi serwerami SSH).</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term><option>-N</option></term>

	  <listitem>
	    <para>Wskazuje na brak polecenia, lub tylko po³±czenie tunelowe.  Pominiêta,
              powoduje nawi±zanie przez <command>ssh</command> normalnej sesji.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term><option>-f</option></term>

	  <listitem>
	    <para>Wymusza pracê <command>ssh</command> w tle.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term><option>-L</option></term>

	  <listitem>
	    <para>Wskazuje lokalny koniec tunelu w postaci
              <replaceable>localny_port:zdalna_maszyna:zdalny_port</replaceable>.</para>
	  </listitem>
	  </varlistentry>

	<varlistentry>
	  <term><option>u¿ytkownik@foo.example.com</option></term>

	  <listitem>
	    <para>Zdalny serwer SSH.</para>
	  </listitem>
	</varlistentry>
      </variablelist>


      <para>Tunel SSH dzia³a w ten sposób, ¿e tworzy nas³uchuj±ce gniazdo na wskazanym
        porcie <hostid>localhost</hostid>.  Nastêpnie ca³y otrzymany ruch przekazuje
        przez po³±czenie SSH do okre¶lonej zdalnej maszyny, na wskazany port.</para>

      <para>W przyk³adzie, port <replaceable>5023</replaceable> na <hostid>localhost</hostid>
        przekazywany jest na port <replaceable>23</replaceable> na <hostid>localhost</hostid>
        zdalnej maszyny.  Poniewa¿ port numer <replaceable>23</replaceable> to
        <application>telnet</application>, po³±czenie to tworzy bezpieczn± sesjê telnetow± przez
        tunel SSH.</para>

      <para>Takiego tunelowania mo¿na u¿yæ w stosunku do dowolnych natywnie niezabezpieczonych
        protoko³ów dzia³aj±cych z wykorzystaniem TCP, takich jak SMTP, POP3, FTP itd.</para>

      <example>
	<title>Zastosowanie SSH do stworzenia bezpiecznego tunelu dla SMTP</title>

        <screen>&prompt.user; <userinput>ssh -2 -N -f -L <replaceable>5025:localhost:25 user@mailserver.example.com</replaceable></userinput>
user@mailserver.example.com's password: <userinput>*****</userinput>
&prompt.user; <userinput>telnet localhost 5025</userinput>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mailserver.example.com ESMTP</screen>     

        <para>Mo¿emy u¿yæ takiej konstrukcji w po³±czeniu z  &man.ssh-keygen.1; i dodatkowymi kontami
          u¿ytkowników by stworzyæ ca³kowicie bezproblemowe ¶rodowisko tunelowania SSH.  W miejsce
          wpisywanych hase³ mo¿na u¿yæ kluczy, a tunele mo¿e tworzyæ osobny u¿ytkownik.</para>
      </example>

      <sect3>
	<title>Praktyczne przyk³ady tunelu SSH</title>

	<sect4>
	  <title>Bezpieczny dostêp do serwera POP3</title>

	  <para>W firmie znajduje siê serwer SSH, akceptuj±cy po³±czenia z zewn±trz.  W tej samej sieci
            biurowej znajduje siê serwer pocztowy POP3.  Sieæ, lub trasa przez sieæ pomiêdzy domem
            a biurem mo¿e byæ, a mo¿e nie byæ kompletnie bezpieczna.  Z uwagi na t± niepewno¶æ,
            powinni¶my zabezpieczyæ sprawdzanie stanu naszej skrzynki pocztowej.  Rozwi±zaniem jest
            stworzenie tunelu SSH pomiêdzy naszym komputerem a serwerem SSH w biurze, a nastêpnie
            w tunelu nawi±zaæ po³±czenie do serwera pocztowego.</para>

	  <screen>&prompt.user; <userinput>ssh -2 -N -f -L <replaceable>2110:mail.example.com:110 user@ssh-server.example.com</replaceable></userinput>
user@ssh-server.example.com's password: <userinput>******</userinput></screen>

	  <para>Gdy tunel jest zestawiony, mo¿emy skonfigurowaæ naszego klienta pocztowego,
            by ³±czy³ siê nie z serwerem, a z <hostid>localhost</hostid> na porcie 2110.
            Po³±czenie zostanie przekazane bezpiecznie przez tunel do hosta
            <hostid>mail.example.com</hostid>.</para>
	</sect4>

	<sect4>
	  <title>Przechodzenie przez drakoñskie zapory ogniowe</title>

	  <para>Niektórzy administratorzy wymuszaj± granicznie drakoñskie regu³y filtrowania
            - filtruj±c nie tylko ruch przychodz±cy, ale równie¿ wychodz±cy.  Byæ mo¿e otrzymali¶my
            pozwolenie tylko na wykonywanie po³±czeñ wychodz±cych na porty 22 i 80 - dla po³±czeñ
            SSH i z serwerami WWW.</para>

	  <para>Mo¿emy osi±gn±æ inne us³ugi (byæ mo¿e nie zwi±zane z wykonywan± prac±),
            takie jak np. serwer Ogg Vorbis do strumieniowego przesy³ania muzyki.  Je¶li
            serwer ten nadaje na innym porcie ni¿ dozwolony 22 czy 80, nie bêdziemy
            w stanie siê z nim po³±czyæ.</para>

	  <para>Rozwi±zaniem jest nawi±zanie po³±czenia SSH do maszyny na zewn±trz naszej
            sieci firmowej i u¿ycie jej do tunelowania ruchu z serwera Ogg Vorbis.</para>

	  <screen>&prompt.user; <userinput>ssh -2 -N -f -L <replaceable>8888:music.example.com:8000 user@unfirewalled-system.example.org</replaceable></userinput>
user@unfirewalled-system.example.org's password: <userinput>*******</userinput></screen>

	  <para>Naszego klienta obs³uguj±cego muzykê musimy skonfigurowaæ, aby ³±czy³ siê
            z <hostid>localhost</hostid> na porcie 8888 - ruch na ten port zostanie przekazany
            do <hostid>music.example.com</hostid> na port 8000, przechodz±c pomy¶lnie przez
            zaporê ogniow±.</para>
        </sect4>
      </sect3>
    </sect2>

    <sect2>
      <title>Opcja <varname>AllowUsers</varname></title>

      <para>Z regu³y dobrym pomys³em jest ograniczenie liczby u¿ytkowników, którzy bêd± mogli
        logowaæ siê do naszego systemu, jak równie¿ ograniczenie adresów, z których bêd±
        siê logowaæ.  W takiej sytuacji pomocn± jest opcja <literal>AllowUsers</literal>.
        Przyk³adowo, by pozwoliæ na logowanie siê tylko u¿ytkownikowi <username>root</username>
        z adresu <hostid role="ipaddr">192.168.1.32</hostid>, w³a¶ciwy by³by wpis w pliku
        <filename>/etc/ssh/sshd_config</filename> postaci:</para>

      <programlisting>AllowUsers root@192.168.1.32</programlisting>

      <para>By pozwoliæ u¿ytkownikowi <username>admin</username> na logowanie siê z dowolnej
        maszyny w sieci, wystarczy podaæ sam± nazwê u¿ytkownika:</para>

      <programlisting>AllowUsers admin</programlisting>

      <para>Gdy chcemy pozwoliæ logowaæ siê kilku u¿ytkownikom, powinni¶my umie¶ciæ ich w jednej
        linii:</para>

      <programlisting>AllowUsers root@192.168.1.32 admin</programlisting>

      <note>
        <para>Przy u¿yciu opcji <literal>AllowUsers</literal> istotnym jest wypisanie ka¿dego
          u¿ytkownika, który ma mieæ mo¿liwo¶æ logowania siê na nasz± maszynê.  U¿ytkownicy
          nie wymienieni nie bêd± mieli mo¿liwo¶ci zalogowania siê poprzez SSH.</para>
      </note>

      <para>Za ka¿dym razem gdy dokonamy zmian w pliku <filename>/etc/ssh/sshd_config</filename>
        musimy poinformowaæ demona &man.sshd.8;, by ponownie wczyta³ plik konfiguracyjny:</para>

      <screen>&prompt.root; <userinput>/etc/rc.d/sshd reload</userinput></screen>
    </sect2>

    <sect2>
      <title>Dodatkowa lektura</title>
      <para><ulink url="http://www.openssh.com/">OpenSSH</ulink></para>
      <para>&man.ssh.1; &man.scp.1; &man.ssh-keygen.1; 
        &man.ssh-agent.1; &man.ssh-add.1; &man.ssh.config.5;</para>
      <para>&man.sshd.8; &man.sftp-server.8; &man.sshd.config.5;</para>
    </sect2>
  </sect1>

  <sect1 id="fs-acl">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Napisa³ </contrib>
	</author>
      </authorgroup>
    </sect1info>
    <indexterm>
      <primary>ACL</primary>
    </indexterm>
    <title>Listy kontroli dostêpu systemu plików</title>

    <para>W po³±czeniu z rozszerzeniami do samego systemu plików jak np. migawki, FreeBSD 5.0
      i kolejne wersje zawieraj± mechanizm bezpieczeñstwa nazwany listami kontroli dostêpu
      do systemu plików (ang. File System Access Control Lists, <acronym>ACLs</acronym>).</para>

    <para>Listy kontroli dostêpu rozszerzaj± standardowy model uprawnieñ w systemie plików systemów
      &unix;, w sposób zgodny ze standardem &posix;.1e.  Rozszerzenie to umo¿liwia administratorowi
      skorzystanie z zalet bardziej wyrafinowanego modelu bezpieczeñstwa.</para>

    <para>Aby listy <acronym>ACL</acronym> dzia³a³y, nale¿y skonfigurowaæ j±dro z obs³ug±
      systemu plików <acronym>UFS</acronym>:</para>

    <programlisting>options UFS_ACL</programlisting>

    <para>Je¶li j±dro nie ma tej opcji, zostanie wy¶wietlony komunikat ostrzegawczy podczas montowania
      systemu plików z ustawionymi listami <acronym>ACL</acronym>.  Opcja
      ta zosta³a dodana przy kompilacji j±dra <filename>GENERIC</filename>.
      Listy <acronym>ACL</acronym> opieraj± siê o uaktywnion± obs³ugê rozszerzonych atrybutów
      w danym systemie plików.  Rozszerzone atrybuty wspierane s± standardowo w systemie plików
      nastêpnej generacji - <acronym>UFS2</acronym>.</para>

    <note><para>U¿ycie rozszerzonych atrybutów w systemie plików <acronym>UFS1</acronym>
      prowadzi do zwiêkszenia ilo¶ci pracy administratora i ni¿szej wydajno¶ci systemu plików
      jako takiego. System plików <acronym>UFS2</acronym> nie posiada tych problemów i jest
      zalecany przy korzystaniu z list kontroli dostêpu.</para></note>

    <para><acronym>ACLs</acronym> are enabled by the mount-time administrative
      flag, <option>acls</option>, which may be added to <filename>/etc/fstab</filename>.
      The mount-time flag can also be automatically set in a persistent manner using
      &man.tunefs.8; to modify a superblock <acronym>ACLs</acronym> flag in the
      file system header.  In general, it is preferred to use the superblock flag
      for several reasons:</para>

    <itemizedlist>
      <listitem>
	<para>The mount-time <acronym>ACLs</acronym> flag cannot be changed by a
	remount (&man.mount.8; <option>-u</option>), only by means of a complete
	&man.umount.8; and fresh &man.mount.8;.  This means that
	<acronym>ACLs</acronym> cannot be enabled on the root file system after boot.
	It also means that you cannot change the disposition of a file system once
	it is in use.</para>
      </listitem>

      <listitem>
	<para>Setting the superblock flag will cause the file system to always be
	mounted with <acronym>ACLs</acronym> enabled even if there is not an
	<filename>fstab</filename> entry or if the devices re-order.  This prevents
	accidental mounting of the file system without <acronym>ACLs</acronym>
	enabled, which can result in <acronym>ACLs</acronym> being improperly enforced,
	and hence security problems.</para>
      </listitem>
    </itemizedlist>

    <note><para>We may change the <acronym>ACLs</acronym> behavior to allow the flag to
      be enabled without a complete fresh &man.mount.8;, but we consider it desirable to
      discourage accidental mounting without <acronym>ACLs</acronym> enabled, because you
      can shoot your feet quite nastily if you enable <acronym>ACLs</acronym>, then disable
      them, then re-enable them without flushing the extended attributes.  In general, once
      you have enabled <acronym>ACLs</acronym> on a file system, they should not be disabled,
      as the resulting file protections may not be compatible with those intended by the
      users of the system, and re-enabling <acronym>ACLs</acronym> may re-attach the previous
      <acronym>ACLs</acronym> to files that have since had their permissions changed,
      resulting in other unpredictable behavior.</para></note>
      
    <para>File systems with <acronym>ACLs</acronym> enabled will show a <literal>+</literal>
      (plus) sign in their permission settings when viewed.  For example:</para>

    <programlisting>drwx------  2 robert  robert  512 Dec 27 11:54 private
drwxrwx---+ 2 robert  robert  512 Dec 23 10:57 directory1
drwxrwx---+ 2 robert  robert  512 Dec 22 10:20 directory2
drwxrwx---+ 2 robert  robert  512 Dec 27 11:57 directory3
drwxr-xr-x  2 robert  robert  512 Nov 10 11:54 public_html</programlisting>

    <para>Here we see that the <filename>directory1</filename>,
      <filename>directory2</filename>, and <filename>directory3</filename>
      directories are all taking advantage of <acronym>ACLs</acronym>.  The
      <filename>public_html</filename> directory is not.</para>

    <sect2>
      <title>Making Use of <acronym>ACL</acronym>s</title>

      <para>The file system <acronym>ACL</acronym>s can be viewed by the
	&man.getfacl.1; utility.  For instance, to view the
	<acronym>ACL</acronym> settings on the <filename>test</filename>
	file, one would use the command:</para>

      <screen>&prompt.user; <userinput>getfacl <filename>test</filename></userinput>
	#file:test
	#owner:1001
	#group:1001
	user::rw-
	group::r--
	other::r--</screen>

      <para>To change the <acronym>ACL</acronym> settings on this file,
	invoke the &man.setfacl.1; utility.  Observe:</para>

      <screen>&prompt.user; <userinput>setfacl -k <filename>test</filename></userinput></screen>

      <para>The <option>-k</option> flag will remove all of the
	currently defined <acronym>ACL</acronym>s from a file or file
	system.  The more preferable method would be to use
	<option>-b</option> as it leaves the basic fields required for
	<acronym>ACL</acronym>s to work.</para>

      <screen>&prompt.user; <userinput>setfacl -m u:trhodes:rwx,group:web:r--,o::--- <filename>test</filename></userinput></screen>

      <para>In the aforementioned command, the <option>-m</option>
	option was used to modify the default <acronym>ACL</acronym>
	entries.  Since there were no pre-defined entries, as they were
	removed by the previous command, this will restore the default
	options and assign the options listed.  Take care to notice that
	if you add a user or group which does not exist on the system,
	an <errorname>Invalid argument</errorname> error will be printed
	to <devicename>stdout</devicename>.</para>
    </sect2>
  </sect1>

  <sect1 id="security-portaudit">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <indexterm>
      <primary>Portaudit</primary>
    </indexterm>
    <title>Monitoring Third Party Security Issues</title>

    <para>In recent years, the security world has made many improvements
      to how vulnerability assessment is handled.  The threat of system
      intrusion increases as third party utilities are installed and
      configured for virtually any operating system available
      today.</para>

    <para>Vulnerability assessment is a key factor in security, and
      while &os; releases advisories for the base system, doing so
      for every third party utility is beyond the &os; Project's
      capability.  There is a way to mitigate third party
      vulnerabilities and warn administrators of known security
      issues.  A &os; add on utility known as
      <application>Portaudit</application> exists solely for this
      purpose.</para>

    <para>The <filename role="port">security/portaudit</filename> port
      polls a database, updated and maintained by the &os; Security
      Team and ports developers, for known security issues.</para>

    <para>To begin using <application>Portaudit</application>, one
      must install it from the Ports Collection:</para>

    <screen>&prompt.root; <userinput>cd /usr/ports/security/portaudit &amp;&amp; make install clean</userinput></screen>

    <para>During the install process, the configuration files for
      &man.periodic.8; will be updated, permitting
      <application>Portaudit</application> output in the daily security
      runs.  Ensure the daily security run emails, which are sent to
      <username>root</username>'s email account, are being read.  No
      more configuration will be required here.</para>

    <para>After installation, an administrator can update the database
      and view known vulnerabilities in installed packages by invoking
      the following command:</para>

    <screen>&prompt.root; <userinput>portaudit -Fda</userinput></screen>

    <note>
      <para>The database will automatically be updated during the
	&man.periodic.8; run; thus, the previous command is completely
	optional.  It is only required for the following
	examples.</para>
    </note>

    <para>To audit the third party utilities installed as part of
      the Ports Collection at anytime, an administrator need only run
      the following command:</para>

    <screen>&prompt.root; <userinput>portaudit -a</userinput></screen>

    <para><application>Portaudit</application> will produce something
      like this for vulnerable packages:</para>

    <programlisting>Affected package: cups-base-1.1.22.0_1
Type of problem: cups-base -- HPGL buffer overflow vulnerability.
Reference: &lt;http://www.FreeBSD.org/ports/portaudit/40a3bca2-6809-11d9-a9e7-0001020eed82.html&gt;

1 problem(s) in your installed packages found.

You are advised to update or deinstall the affected package(s) immediately.</programlisting>

    <para>By pointing a web browser to the <acronym>URL</acronym> shown,
      an administrator may obtain more information about the
      vulnerability in question.  This will include versions affected,
      by &os; Port version, along with other web sites which may contain
      security advisories.</para>

    <para>In short, <application>Portaudit</application> is a powerful
      utility and extremely useful when coupled with the
      <application>Portupgrade</application> port.</para>
  </sect1>

  <sect1 id="security-advisories">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Napisa³ </contrib>
	</author>
      </authorgroup>
    </sect1info>
    <indexterm>
      <primary>Komunikaty bezpieczeñstwa FreeBSD</primary>
    </indexterm>
    <title>Komunikaty bezpieczeñstwa &os;</title>

    <para>Podobnie jak inne systemy operacyjne, równie¿ &os; publikuje
      <quote>Komunikaty bezpieczeñstwa</quote>.  Komunikaty te z regu³y
      wys³ane s± na listy dyskusyjne po¶wiêcone bezpieczeñstwu oraz do³±czane
      do Erraty po za³ataniu w³a¶ciwych wydañ.  Sekcja ta wyja¶ni czym jest
      taki komunikat, jak go rozumieæ i jakie ¶rodki nale¿y podj±æ by za³ataæ
      w³asny system.</para>

    <sect2>
      <title>Jak wygl±da komunikat?</title>

      <para>Komunikaty bezpieczeñstwa &os; wygl±daj± podobnie do poni¿szego,
        pochodz±cego z listy dyskusyjnej &a.security-notifications.name;.</para>

      <programlisting>=============================================================================
&os;-SA-XX:XX.UTIL                                     Security Advisory
                                                          The &os; Project

Topic:          denial of service due to some problem<co id="co-topic">

Category:       core<co id="co-category">
Module:         sys<co id="co-module">
Announced:      2003-09-23<co id="co-announce">
Credits:        Person@EMAIL-ADDRESS<co id="co-credit">
Affects:        All releases of &os;<co id="co-affects">
                &os; 4-STABLE prior to the correction date
Corrected:      2003-09-23 16:42:59 UTC (RELENG_4, 4.9-PRERELEASE)
                2003-09-23 20:08:42 UTC (RELENG_5_1, 5.1-RELEASE-p6)
                2003-09-23 20:07:06 UTC (RELENG_5_0, 5.0-RELEASE-p15)
                2003-09-23 16:44:58 UTC (RELENG_4_8, 4.8-RELEASE-p8)
                2003-09-23 16:47:34 UTC (RELENG_4_7, 4.7-RELEASE-p18)
                2003-09-23 16:49:46 UTC (RELENG_4_6, 4.6-RELEASE-p21)
                2003-09-23 16:51:24 UTC (RELENG_4_5, 4.5-RELEASE-p33)
                2003-09-23 16:52:45 UTC (RELENG_4_4, 4.4-RELEASE-p43)
                2003-09-23 16:54:39 UTC (RELENG_4_3, 4.3-RELEASE-p39)<co id="co-corrected">
<acronym>CVE</acronym> Name:	CVE-XXXX-XXXX<co id="co-cve">

For general information regarding FreeBSD Security Advisories,
including descriptions of the fields above, security branches, and the
following sections, please visit
http://www.FreeBSD.org/security/.

I.   Background<co id="co-backround">


II.  Problem Description<co id="co-descript">


III. Impact<co id="co-impact">


IV.  Workaround<co id="co-workaround">


V.   Solution<co id="co-solution">


VI.  Correction details<co id="co-details">


VII. References<co id="co-ref"></programlisting>


      <calloutlist>
	<callout arearefs="co-topic">
	  <para>Pole <literal>Topic</literal> wskazuje czego dok³adnie dotyczy problem.
	    Stanowi wprowadzenie do bie¿±cego komunikatu bezpieczeñstwa
	    i wskazuje na narzêdzie zawieraj±ce dan± lukê.</para>
	</callout>

	<callout arearefs="co-category">
	  <para>Pole <literal>Category</literal> definiuje czê¶ci systemu, do której
            odnosi siê powiadomienie.  Mo¿liwe s± nastêpuj±ce kategorie: <literal>core</literal>,
            <literal>contrib</literal> b±d¼ <literal>ports</literal>.  Kategoria <literal>core</literal>
	    oznacza, ¿e luka dotyczy kluczowego elementu systemu operacyjnego
	    &os;.  Kategoria <literal>contrib</literal> oznacza, ¿e luka dotyczy
	    oprogramowania dostarczanego wraz z &os;, jak np.
            <application>sendmail</application>.  Natomiast kategoria <literal>ports</literal>
	    oznacza, ¿e luka dotyczy dodatkowego oprogramowania dostêpnego
	    jako cze¶æ kolekcji portów.</para>
	</callout>

	<callout arearefs="co-module">
	  <para>Pole <literal>Module</literal> wskazuje na lokalizacjê elementu, np.
	    <literal>sys</literal>, jak w powy¿szym przyk³adzie.  Zatem luka ta
	    dotyczy komponentu wykorzystywanego w j±drze.</para>
	</callout>

	<callout arearefs="co-announce">
	  <para>Pole <literal>Announced</literal> zawiera datê publikacji
            komunikatu bezpieczeñstwa b±d¼ og³oszenia informacji w ¶wiecie.
            Oznacza to, ¿e grupa bezpieczeñstwa &os; zweryfikowa³a istnienie
            problemu oraz, ¿e ³ata zosta³a dodana do repozytorium kodu
            ¼ród³owego.</para>
	</callout>

	<callout arearefs="co-credit">
	  <para>Pole <literal>Credits</literal> informuje o osobie b±d¼ organizacji,
	    która odkry³a dan± lukê bezpieczeñstwa i poinformowa³a o tym.</para>
	</callout>

	<callout arearefs="co-affects">
	  <para>Pole <literal>Affects</literal> wyja¶nia, którego z wydañ &os; dotyczy
	    dana luka.  W przypadku plików j±dra, sprawdzenie wyniku polecenia
	    <command>ident</command> na plikach wymienionych w komunikacie pomo¿e
            okre¶liæ numer poprawki.  W przypadku portów, numer wersji znajduje siê
	    za nazw± portu w <filename>/var/db/pkg</filename>.  Je¶li nie synchronizujemy
	    naszego systemu z repozytorium <acronym>CVS</acronym> &os; i nie
            rekompilujemy go codziennie, s± bardzo du¿e szanse, ¿e luka dotyczy równie¿
            naszego systemu.</para>
	</callout>

	<callout arearefs="co-corrected">
	  <para>Pole <literal>Corrected</literal> oznacza datê, godzinê wraz ze stref±
            czasow± i wydanie, które zosta³y poprawione.</para>
	</callout>

	<callout arearefs="co-cve">
	  <para>Pole zarezerwowane dla informacji identyfikacyjnych wykorzystywanych
            do wyszukiwania opisów luk w systemie Common Vulnerabilities Database.</para>
	</callout>

	<callout arearefs="co-backround">
	  <para>Pole <literal>Background</literal> przybli¿a dan± aplikacjê.
	    W wiêkszo¶æ przypadków s± to informacje: dlaczego dane narzêdzie jest
	    dostêpne we &os;, do czego jest ono wykorzystywane oraz jak ono
	    powsta³o.</para>
	</callout>

	<callout arearefs="co-descript">
	  <para>Pole <literal>Problem Description</literal> obja¶nia szczegó³owo dan±
            lukê bezpieczeñstwa.  Mo¿e zawieraæ informacje o wadliwym kodzie b±d¼
	    nawet jak dana aplikacja mo¿e zostaæ wykorzystana do stworzenia dziury
            w systemie zabezpieczeñ.</para>
	</callout>

	<callout arearefs="co-impact">
	  <para>Pole <literal>Impact</literal> wyja¶nia jak dany problem mo¿e wp³yn±æ
	    na system.  Przyk³adowo, mo¿e to byæ wszystko od ataku odmowy dostêpu DoS
	    po rozszerzenie uprawnieñ u¿ytkowników b±d¼ nawet umo¿liwienie atakuj±cemu
            dostêpu do konta administratora.</para>
	</callout>

	<callout arearefs="co-workaround">
	  <para>Pole <literal>Workaround</literal> opisuje metodê obej¶cia problemu
	    dla administratorów, którzy nie mog± zaktualizowaæ
	    systemu.  Mo¿e to byæ z powodu ograniczenia czasowego, dostêpno¶ci sieci,
	    b±d¼ ca³ej masy innych przyczyn.  Bez wzglêdu na to, do bezpieczeñstwa
            nie mo¿na podchodziæ lekko.  System podatny na dan± lukê powinien
	    zostaæ za³atany b±d¼ powinno siê zaimplementowaæ obej¶cie problemu.</para>
	</callout>

	<callout arearefs="co-solution">
	  <para>Pole <literal>Solution</literal> przedstawia metodê za³atania podatnego
	    systemu.  Jest to przetestowana i zweryfikowana instrukcja obja¶niaj±ca
	    niezbêdne kroki do za³atania systemu i przywrócenia bezpieczeñstwa pracy.</para>
	</callout>

	<callout arearefs="co-details">
	  <para>Pole <literal>Correction Details</literal> prezentuje numery poprawek
            wszystkich zaktualizowanych plików dla ka¿dej ga³êzi drzewa
	    <acronym>CVS</acronym>.</para>
	</callout>

	<callout arearefs="co-ref">
	  <para>Pole <literal>References</literal> z regu³y zawiera ¼ród³a dodatkowych
	    informacji.  Mo¿e zawieraæ adresy <acronym>URL</acronym> witryn WWW,
	    ksi±¿ki, listy i grupy dyskusyjne.</para>
	</callout>
      </calloutlist>
    </sect2>
  </sect1>

  <sect1 id="security-accounting">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Napisa³ </contrib>
	</author>
      </authorgroup>
    </sect1info>
    <indexterm>
      <primary>kontrola procesów</primary>
    </indexterm>
    <title>Kontrola procesów</title>

    <para>Process accounting is a security method in which an
      administrator may keep track of system resources used,
      their allocation among users, provide for system monitoring,
      and minimally track a user's commands.</para>

    <para>This indeed has its own positive and negative points.  One of
      the positives is that an intrusion may be narrowed down
      to the point of entry.  A negative is the amount of logs
      generated by process accounting, and the disk space they may
      require.  This section will walk an administrator through
      the basics of process accounting.</para>

    <sect2>
      <title>Enable and Utilizing Process Accounting</title>
      <para>Before making use of process accounting, it
	must be enabled.  To do this, execute the following
	commands:</para>

      <screen>&prompt.root; <userinput>touch <filename>/var/account/acct</filename></userinput>

&prompt.root; <userinput>accton <filename>/var/account/acct</filename></userinput>

&prompt.root; <userinput>echo 'accounting_enable="YES"' &gt;&gt; <filename>/etc/rc.conf</filename></userinput></screen>

      <para>Once enabled, accounting will begin to track
	<acronym>CPU</acronym> stats, commands, etc.  All accounting
	logs are in a non-human readable format and may be viewed
	using the &man.sa.8; utility.  If issued without any options,
	<command>sa</command> will print information relating to the
	number of per user calls, the total elapsed time in minutes,
	total <acronym>CPU</acronym> and user time in minutes, average
	number of I/O operations, etc.</para>

      <para>To view information about commands being issued, one
	would use the &man.lastcomm.1; utility.  The
	<command>lastcomm</command> may be used to print out commands
	issued by users on specific &man.ttys.5;, for example:</para>

      <screen>&prompt.root; <userinput>lastcomm ls
	<username>trhodes</username> ttyp1</userinput></screen>

      <para>Would print out all known usage of the <command>ls</command>
        by <username>trhodes</username> on the ttyp1 terminal.</para>

      <para>Many other useful options exist and are explained in the
	&man.lastcomm.1;, &man.acct.5; and &man.sa.8; manual
	pages.</para>
    </sect2>
  </sect1>  
</chapter>

<!--
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->
